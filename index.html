<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento M√©dico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: #2c3e50;
            line-height: 1.5;
            overflow-x: hidden;
        }
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }
        .header-logo {
            height: 90px;
            width: auto;
        }
        .logo {
            font-size: 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .system-title {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            text-align: center;
            padding: 12px;
            margin: -15px 0 15px 0;
            border-radius: 0 0 12px 12px;
            font-weight: 400;
            font-size: 16px;
        }
        .container {
            display: grid;
            grid-template-columns: 1.5fr 1.5fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745);
        }
        .section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        h3 {
            color: #007bff;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        .month-nav button {
            background: #e9ecef;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.2s;
            color: #6c757d;
        }
        .month-nav button:hover {
            background: #007bff;
            color: white;
            transform: scale(1.1);
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }
        .day-header {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            padding: 6px;
            font-weight: 500;
            font-size: 11px;
            color: #6c757d;
        }
        .day {
            padding: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            font-size: 14px;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 0.5px;
            position: relative;
        }
        .day:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: scale(1.05);
        }
        .day.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        .day.other-month {
            color: #adb5bd;
            background: transparent;
        }
        .day.unavailable {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        .day.unavailable:hover {
            background: #f8f9fa;
            transform: none;
            border-color: #e9ecef;
        }
        .day.past {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        .day.has-appointment::after {
            content: '‚Ä¢';
            position: absolute;
            bottom: 1px;
            right: 2px;
            color: #dc3545;
            font-size: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .selected-date {
            margin-top: 8px;
            padding: 8px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 6px;
            font-style: italic;
            color: #0056b3;
            border-left: 3px solid #007bff;
            animation: fadeIn 0.3s ease;
            font-size: 13px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .hour-slot {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffd54f;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hour-slot:hover, .hour-slot.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,123,255,0.2);
        }
        .hour-slot.booked {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #f5c6cb;
            color: #721c24;
            cursor: not-allowed;
            font-weight: bold;
        }
        .hour-slot.booked:hover {
            transform: none;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 13px;
            transition: all 0.2s;
            background: white;
            margin-bottom: 10px;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            display: none;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        .radio-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 400;
            font-size: 13px;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
        }
        .radio-group label:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }
        .schedule-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }
        .schedule-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .schedule-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        .dentist-select {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }
        .dentist-select h4 {
            margin: 0 0 6px 0;
            color: #007bff;
            font-size: 13px;
        }
        .agenda-type-select {
            margin-bottom: 12px;
        }
        .agenda-type-select h4 {
            margin: 0 0 6px 0;
            color: #007bff;
            font-size: 13px;
        }
        .report-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
        }
        .report-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffc107, #dc3545);
        }
        .report-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .report-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .report-filters select, .report-filters input {
            flex: 1;
            min-width: 150px;
        }
        .report-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
            margin-left: 10px;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .csv-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
            margin-left: 5px;
        }
        .csv-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .report-table th, .report-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }
        .report-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 500;
            color: #495057;
        }
        .report-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
        }
        .summary-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            color: #007bff;
        }
        .summary-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #0056b3;
        }
        .scheduled-section {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .scheduled-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .scheduled-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #28a745, #ffc107);
        }
        .scheduled-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 12px;
        }
        .scheduled-column {
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .scheduled-column.odontologia {
            border-left-color: #28a745;
        }
        .scheduled-column h4 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 500;
        }
        .scheduled-column.odontologia h4 {
            color: #28a745;
        }
        .date-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .date-filters input {
            width: auto;
            min-width: 120px;
        }
        .date-filters label {
            font-size: 12px;
            color: #6c757d;
        }
        .professional-filter {
            margin-bottom: 10px;
        }
        .cpf-filter {
            margin-bottom: 10px;
        }
        .search-filter {
            margin-bottom: 10px;
        }
        .professional-filter label, .cpf-filter label, .search-filter label {
            font-size: 12px;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }
        .professional-filter select, .cpf-filter input, .search-filter input {
            width: 100%;
            font-size: 12px;
        }
        .cpf-filter input, .search-filter input {
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        .scheduled-list {
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .appointment-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #007bff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            animation: slideIn 0.4s ease;
            position: relative;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .appointment-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .appointment-card h4 {
            margin: 0 0 4px 0;
            color: #0056b3;
            font-size: 14px;
        }
        .appointment-card p {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }
        .appointment-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
        }
        .btn-edit, .btn-delete {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        .btn-edit:hover {
            background: #e0a800;
            transform: scale(1.05);
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            font-size: 14px;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .modal h3 {
            margin-top: 0;
            color: #007bff;
        }
        .modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        .modal input, .modal select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .modal .radio-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .modal .radio-group label {
            padding: 4px;
            font-size: 12px;
        }
        .modal-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .modal-btn:hover {
            transform: translateY(-1px);
        }
        .cancel-btn {
            background: #6c757d;
        }
        .confirm-delete {
            background: #dc3545;
        }
        .modal input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        .modal .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            display: none;
        }
        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #28a745;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
        }
        .toast.show {
            visibility: visible;
            animation: fadeIn 0.5s;
        }
        .toast.error {
            background-color: #dc3545;
        }
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .summary {
                flex-direction: column;
            }
            .summary-item {
                margin: 5px 0;
            }
            .scheduled-grid {
                grid-template-columns: 1fr;
            }
            .date-filters {
                flex-direction: column;
            }
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            body {
                padding: 10px;
            }
            .header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            .appointment-actions {
                position: static;
                justify-content: center;
                margin-top: 8px;
                gap: 8px;
            }
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            .report-filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="img/sesi.jpg" alt="SESI Logo" class="header-logo">
        <div class="logo">
            <span>ü©∫</span>
            Sistema de Agendamento Pessoa F√≠sica - SESI Sa√∫de
        </div>
        <img src="img/melhoria.jpg" alt="SESI Logo" class="header-logo">
    </div>

    <div class="container">
        <div class="section">
            <h3>üìÖ Selecione uma Data</h3>
            <div class="calendar-header">
                <div class="month-nav">
                    <button onclick="prevMonth()" aria-label="M√™s anterior">&lt;</button>
                    <span class="month" id="monthDisplay" role="status">outubro 2025</span>
                    <button onclick="nextMonth()" aria-label="Pr√≥ximo m√™s">&gt;</button>
                </div>
            </div>
            <div class="calendar" id="calendar" role="grid" aria-label="Calend√°rio">
                <!-- Calendar will be generated by JS -->
            </div>
            <div class="selected-date" id="selectedDate" style="display: none;" role="alert">
                Data selecionada: <span id="selectedDateText"></span>
            </div>
        </div>

        <div class="section">
            <h3>üïí Hor√°rios Dispon√≠veis</h3>
            <div class="agenda-type-select">
                <h4>üìã Selecione o Tipo de Agenda</h4>
                <select id="agendaTypeSelect" aria-label="Tipo de agenda">
                    <option value="">Selecione</option>
                </select>
            </div>
            <div class="dentist-select">
                <h4>üë§ Selecione o Profissional</h4>
                <select id="dentistSelect" aria-label="Profissional">
                    <option value="">Selecione um profissional</option>
                </select>
            </div>
            <div class="hours-grid" id="hoursGrid" role="grid" aria-label="Hor√°rios dispon√≠veis">
                <!-- Hours will be populated by JS -->
            </div>
        </div>

        <div class="section">
            <h3>üë§ Dados da Consulta</h3>
            <label for="patientName">Nome do Paciente</label>
            <input type="text" id="patientName" placeholder="Digite o nome completo do paciente" aria-required="true">
            
            <label for="patientCpf">CPF do Paciente</label>
            <input type="text" id="patientCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" aria-required="true">
            <small id="cpfError" class="error-message">CPF inv√°lido. (Apenas N√∫meros).</small>
            
            <label for="patientPhone">N√∫mero do Telefone</label>
            <input type="tel" id="patientPhone" placeholder="Digite o n√∫mero do telefone (ex: (11) 99999-9999)" aria-required="true">
            <small id="phoneError" class="error-message">Telefone inv√°lido. Use o formato (DD) 9XXXX-XXXX.</small>
            
            <label for="locationSelect">üè¢ Local do Atendimento</label>
            <select id="locationSelect" aria-required="true"></select>
            
            <div class="radio-group">
                <label><input type="radio" name="notification" value="SMS" aria-label="Notifica√ß√£o por SMS"> üì± SMS</label>
                <label><input type="radio" name="notification" value="WhatsApp" checked aria-label="Notifica√ß√£o por WhatsApp"> üì± WhatsApp</label>
            </div>
            <button class="schedule-btn" id="scheduleBtn" onclick="saveAppointment()" disabled aria-label="Agendar consulta">Agendar Consulta</button>
        </div>
    </div>

    <div class="scheduled-section">
        <h3>üìã Consultas Agendadas</h3>
        <div class="scheduled-grid">
            <div class="scheduled-column odontologia">
                <h4>ü¶∑ Odontol√≥gica</h4>
                <div class="date-filters">
                    <label>Data Inicial: <input type="date" id="odontologiaStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial odontol√≥gica"></label>
                    <label>Data Final: <input type="date" id="odontologiaEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final odontol√≥gica"></label>
                </div>
                <div class="professional-filter">
                    <label>Profissional:</label>
                    <select id="odontologiaProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional odontol√≥gico">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label>CPF:</label>
                    <input type="text" id="odontologiaCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF odontol√≥gico">
                </div>
                <div class="search-filter">
                    <label>Buscar Paciente:</label>
                    <input type="text" id="odontologiaSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente odontol√≥gico">
                </div>
                <div id="odontologiaList" class="scheduled-list" role="list" aria-label="Lista de agendamentos odontol√≥gicos">
                    <p class="empty-message">Nenhum agendamento odontol√≥gico.</p>
                </div>
            </div>
            <div class="scheduled-column">
                <h4>üè• Especialidades M√©dicas</h4>
                <div class="date-filters">
                    <label>Data Inicial: <input type="date" id="medicasStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial m√©dica"></label>
                    <label>Data Final: <input type="date" id="medicasEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final m√©dica"></label>
                </div>
                <div class="professional-filter">
                    <label>Profissional:</label>
                    <select id="medicasProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional m√©dico">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label>CPF:</label>
                    <input type="text" id="medicasCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF m√©dico">
                </div>
                <div class="search-filter">
                    <label>Buscar Paciente:</label>
                    <input type="text" id="medicasSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente m√©dico">
                </div>
                <div id="medicasList" class="scheduled-list" role="list" aria-label="Lista de agendamentos m√©dicos">
                    <p class="empty-message">Nenhum agendamento de especialidades m√©dicas.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="report-section">
        <h3>üìä Relat√≥rios de Agendamentos</h3>
        <div class="report-filters">
            <select id="reportAgendaType" aria-label="Tipo de relat√≥rio">
                <option value="">Todos os Tipos</option>
                <option value="Agenda Odontol√≥gica">Agenda Odontol√≥gica</option>
                <option value="Agenda Especialidades M√©dicas">Agenda Especialidades M√©dicas</option>
            </select>
            <input type="date" id="reportStartDate" aria-label="Data inicial relat√≥rio">
            <input type="date" id="reportEndDate" aria-label="Data final relat√≥rio">
            <button class="report-btn" onclick="generateReport()" aria-label="Gerar relat√≥rio">Gerar Relat√≥rio</button>
            <button class="export-btn" id="exportBtn" onclick="exportToExcel()" style="display: none;" aria-label="Exportar Excel">Exportar Excel</button>
            <button class="csv-btn" id="csvBtn" onclick="exportToCSV()" style="display: none;" aria-label="Exportar CSV">Exportar CSV</button>
        </div>
        <div id="reportTableContainer" style="display: none;">
            <table class="report-table" id="reportTable" role="table" aria-label="Tabela de relat√≥rios">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>CPF</th>
                        <th>Telefone</th>
                        <th>Data</th>
                        <th>Hor√°rio</th>
                        <th>Profissional</th>
                        <th>Tipo</th>
                        <th>Local</th>
                        <th>Notifica√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody" role="rowgroup"></tbody>
            </table>
            <div class="summary" id="summaryStats"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Consulta agendada com sucesso!</div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteModal')" aria-label="Fechar">&times;</span>
            <h3 id="deleteTitle">Confirmar Exclus√£o</h3>
            <p>Tem certeza que deseja excluir esta consulta?</p>
            <button class="modal-btn confirm-delete" onclick="confirmDelete()" aria-label="Confirmar exclus√£o">Sim, Excluir</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('deleteModal')" aria-label="Cancelar">Cancelar</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')" aria-label="Fechar">&times;</span>
            <h3 id="editTitle">Editar Consulta</h3>
            <label for="editPatientName">Nome do Paciente</label>
            <input type="text" id="editPatientName" aria-required="true">
            
            <label for="editPatientCpf">CPF do Paciente</label>
            <input type="text" id="editPatientCpf" aria-required="true">
            <small id="editCpfError" class="error-message">CPF inv√°lido. Verifique os d√≠gitos.</small>
            
            <label for="editPatientPhone">N√∫mero do Telefone</label>
            <input type="tel" id="editPatientPhone" aria-required="true">
            <small id="editPhoneError" class="error-message">Telefone inv√°lido. Use o formato (DD) 9XXXX-XXXX.</small>
            
            <label for="editLocationSelect">Local do Atendimento</label>
            <select id="editLocationSelect" aria-required="true"></select>
            
            <label for="editAgendaTypeSelect">Tipo de Agenda</label>
            <select id="editAgendaTypeSelect" onchange="populateEditProfessionals()" aria-required="true"></select>
            
            <label for="editDentistSelect">Profissional</label>
            <select id="editDentistSelect" aria-required="true"></select>
            
            <label for="editDate">Data da Consulta</label>
            <input type="date" id="editDate" required aria-required="true">
            
            <label for="editTime">Hor√°rio da Consulta</label>
            <select id="editTime" required aria-required="true"></select>
            
            <div class="radio-group">
                <label><input type="radio" name="editNotification" value="SMS" aria-label="Notifica√ß√£o por SMS"> üì± SMS</label>
                <label><input type="radio" name="editNotification" value="WhatsApp" aria-label="Notifica√ß√£o por WhatsApp"> üì± WhatsApp</label>
            </div>
            <button class="modal-btn" onclick="saveEdit()" aria-label="Salvar altera√ß√µes">Salvar Altera√ß√µes</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('editModal')" aria-label="Cancelar">Cancelar</button>
        </div>
    </div>

    <script>
        let currentDate = new Date(); // Din√¢mico: inicia no m√™s atual
        let selectedDay = null;
        let selectedHour = null;
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let editingId = null;
        let deleteId = null;
        let filteredAppointments = []; // Store filtered appointments for export
        let debounceTimer; // Para debounce em filtros

        const agendaTypes = [
            'Agenda Odontol√≥gica',
            'Agenda Especialidades M√©dicas'
        ];

        const dentists = [
            'Dr. Ana Silva',
            'Dr. Jo√£o Santos',
            'Dr. Maria Oliveira',
            'Dr. Pedro Costa'
        ];

        const medicalSpecialists = [
            'Cl√≠nica Geral',
            'Cardiologia',
            'Oftalmologia',
            'Otorrinolaringologia',
            'Ginecologia',
            'Dermatologia',
            'Psicologia',
            'Nutri√ß√£o'

        ];

        const locations = [
            'SESI Sa√∫de - Santo Amaro',
            'N√∫cleo SESI Paulista'
        ];

        const hours = [
            '8:00', '8:30', '9:00', '9:30',
            '10:00', '10:30', '11:00', '11:30',
            '12:00', '12:30', '13:00', '13:30',
            '14:00', '14:30', '15:00', '15:30',
            '16:00', '16:30', '17:00', '17:30'
        ];

        // Fun√ß√£o para sanitizar inputs (b√°sica contra XSS)
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function formatCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})/, "$1-$2");
            input.value = value;
        }

        function formatFilterCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})/, "$1-$2");
            input.value = value;
        }

        function validateCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('cpfError');
            const isValid = cpf.length === 11 && isValidCPF(cpf);
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
            } else if (input.value.trim()) { // S√≥ mostra erro se n√£o vazio
                input.classList.add('error');
                errorEl.style.display = 'block';
            }
            updateScheduleButton();
        }

        function isValidCPF(cpf) {
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf[i]) * (10 - i);
            }
            let remainder = 11 - (sum % 11);
            let digit1 = remainder >= 10 ? 0 : remainder;
            if (parseInt(cpf[9]) !== digit1) return false;
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf[i]) * (11 - i);
            }
            remainder = 11 - (sum % 11);
            let digit2 = remainder >= 10 ? 0 : remainder;
            return parseInt(cpf[10]) === digit2;
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, "");
            if (value.length >= 11) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
            } else if (value.length >= 7) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            } else if (value.length >= 2) {
                value = value.replace(/^(\d{2})/, "($1) ");
            }
            input.value = value;
        }

        function validatePhone(input) {
            const phone = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('phoneError');
            const isValid = phone.length >= 10 && phone.length <= 11;
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
            }
            updateScheduleButton();
        }

        function validateEditCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('editCpfError');
            const isValid = cpf.length === 11 && isValidCPF(cpf);
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
            }
        }

        function validateEditPhone(input) {
            const phone = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('editPhoneError');
            const isValid = phone.length >= 10 && phone.length <= 11;
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
            }
        }

        function getProfessionals(agendaType) {
            if (agendaType === 'Agenda Odontol√≥gica') {
                return dentists;
            } else if (agendaType === 'Agenda Especialidades M√©dicas') {
                return medicalSpecialists;
            }
            return [];
        }

        function populateProfessionals(agendaType, selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecione um profissional</option>';
            const professionals = getProfessionals(agendaType);
            professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                select.appendChild(option);
            });
        }

        function populateEditProfessionals() {
            const agendaType = document.getElementById('editAgendaTypeSelect').value;
            populateProfessionals(agendaType, 'editDentistSelect');
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            calendar.innerHTML = `
                <div class="day-header">dom</div>
                <div class="day-header">seg</div>
                <div class="day-header">ter</div>
                <div class="day-header">qua</div>
                <div class="day-header">qui</div>
                <div class="day-header">sex</div>
                <div class="day-header">s√°b</div>
            `;

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = date.getDate();
                dayElement.setAttribute('role', 'gridcell');
                dayElement.setAttribute('tabindex', '0'); // Para navega√ß√£o por teclado
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else {
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                        dayElement.classList.add('unavailable');
                    } else if (date < today) { // Datas passadas indispon√≠veis
                        dayElement.classList.add('past');
                        dayElement.setAttribute('aria-disabled', 'true');
                    } else {
                        dayElement.onclick = () => selectDay(date);
                        dayElement.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectDay(date); };
                        if (date.toDateString() === today.toDateString()) {
                            dayElement.style.background = '#ffc107';
                            dayElement.style.color = '#000';
                        }
                    }
                    // Check for appointments on this day
                    const hasAppointment = appointments.some(apt => {
                        const [day, mon, yr] = apt.date.split('/');
                        const aptDate = new Date(yr, mon - 1, day);
                        return aptDate.toDateString() === date.toDateString();
                    });
                    if (hasAppointment) {
                        dayElement.classList.add('has-appointment');
                    }
                }
                calendar.appendChild(dayElement);
            }

            document.getElementById('monthDisplay').textContent = firstDay.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }

        function selectDay(date) {
            selectedDay = date;
            document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('selectedDate').style.display = 'block';
            document.getElementById('selectedDateText').textContent = `${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })} de ${date.getFullYear()}`;
            updateScheduleButton();
            populateHours(date);
        }

        function populateHours(selectedDate) {
            const hoursGrid = document.getElementById('hoursGrid');
            hoursGrid.innerHTML = '';
            const dateStr = selectedDate.toLocaleDateString('pt-BR');
            const selectedAgendaType = document.getElementById('agendaTypeSelect').value;
            const selectedDentist = document.getElementById('dentistSelect').value;
            let bookedHours = [];
            let isSpecificDentist = false;
            if (selectedAgendaType && selectedDentist) {
                bookedHours = appointments
                    .filter(apt => apt.agendaType === selectedAgendaType && apt.date === dateStr && apt.professional === selectedDentist)
                    .map(apt => apt.time);
                isSpecificDentist = true;
            } else if (selectedAgendaType) {
                bookedHours = appointments
                    .filter(apt => apt.agendaType === selectedAgendaType && apt.date === dateStr)
                    .map(apt => apt.time);
            } else {
                bookedHours = appointments
                    .filter(apt => apt.date === dateStr)
                    .map(apt => apt.time);
            }
            hours.forEach(hour => {
                const slot = document.createElement('div');
                slot.className = 'hour-slot';
                slot.setAttribute('role', 'gridcell');
                slot.setAttribute('tabindex', '0');
                if (bookedHours.includes(hour)) {
                    slot.classList.add('booked');
                    const titleText = isSpecificDentist ? 'Hor√°rio j√° agendado para este profissional' : 'Hor√°rio ocupado';
                    slot.title = titleText;
                    slot.setAttribute('aria-disabled', 'true');
                    slot.onkeydown = null; // Desabilita teclado
                    slot.onclick = (e) => {
                        e.preventDefault();
                        const alertText = isSpecificDentist ? 'Este hor√°rio j√° est√° agendado para este profissional.' : 'Este hor√°rio est√° ocupado.';
                        alert(alertText);
                    };
                } else {
                    slot.onclick = () => selectHour(hour);
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectHour(hour); };
                }
                slot.textContent = hour;
                if (bookedHours.includes(hour)) {
                    const text = isSpecificDentist ? ' (Agendado)' : ' (Ocupado)';
                    slot.innerHTML += `<span style="font-size: 10px;">${text}</span>`;
                }
                hoursGrid.appendChild(slot);
            });
        }

        function selectHour(hour) {
            selectedHour = hour;
            document.querySelectorAll('.hour-slot:not(.booked)').forEach(s => s.classList.remove('selected'));
            event.target.classList.add('selected');
            updateScheduleButton();
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
            document.getElementById('selectedDate').style.display = 'none';
            clearSelections();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
            document.getElementById('selectedDate').style.display = 'none';
            clearSelections();
        }

        function clearSelections() {
            selectedDay = null;
            selectedHour = null;
            editingId = null;
            document.getElementById('scheduleBtn').textContent = 'Agendar Consulta';
            document.getElementById('patientName').value = '';
            document.getElementById('patientCpf').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('locationSelect').value = '';
            document.getElementById('agendaTypeSelect').value = '';
            document.getElementById('dentistSelect').value = '';
            document.querySelectorAll('.hour-slot').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
            document.getElementById('hoursGrid').innerHTML = '';
            document.getElementById('selectedDate').style.display = 'none';
            updateScheduleButton();
        }

        // Debounce para filtros (evita chamadas excessivas)
        function debouncedFilterAppointments() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filterAppointments, 300);
        }

        function generateReport() {
            const agendaTypeFilter = document.getElementById('reportAgendaType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            filteredAppointments = appointments.filter(apt => {
                if (agendaTypeFilter && apt.agendaType !== agendaTypeFilter) return false;
                if (startDate) {
                    const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                    const start = new Date(startDate);
                    if (aptDate < start) return false;
                }
                if (endDate) {
                    const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                    const end = new Date(endDate);
                    if (aptDate > end) return false;
                }
                return true;
            });

            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';
            filteredAppointments.forEach(apt => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = sanitizeInput(apt.patient);
                row.insertCell(1).textContent = apt.cpf || '';
                row.insertCell(2).textContent = apt.phone || '';
                row.insertCell(3).textContent = apt.date;
                row.insertCell(4).textContent = apt.time;
                row.insertCell(5).textContent = sanitizeInput(apt.professional);
                row.insertCell(6).textContent = apt.agendaType;
                row.insertCell(7).textContent = apt.location;
                row.insertCell(8).textContent = apt.notification;
            });

            // Summary Stats
            const total = filteredAppointments.length;
            const odontologica = filteredAppointments.filter(apt => apt.agendaType === 'Agenda Odontol√≥gica').length;
            const medicas = filteredAppointments.filter(apt => apt.agendaType === 'Agenda Especialidades M√©dicas').length;

            const summary = document.getElementById('summaryStats');
            summary.innerHTML = `
                <div class="summary-item">
                    <h4>Total de Agendamentos</h4>
                    <p>${total}</p>
                </div>
                <div class="summary-item">
                    <h4>Odontol√≥gica</h4>
                    <p>${odontologica}</p>
                </div>
                <div class="summary-item">
                    <h4>Especialidades M√©dicas</h4>
                    <p>${medicas}</p>
                </div>
            `;

            document.getElementById('reportTableContainer').style.display = 'block';
            document.getElementById('exportBtn').style.display = 'inline-block';
            document.getElementById('csvBtn').style.display = 'inline-block';
        }

        function exportToExcel() {
            if (filteredAppointments.length === 0) {
                showToast('Nenhum relat√≥rio para exportar.');
                return;
            }

            const headers = ['Paciente', 'CPF', 'Telefone', 'Data', 'Hor√°rio', 'Profissional', 'Tipo', 'Local', 'Notifica√ß√£o'];
            const data = [
                headers,
                ...filteredAppointments.map(apt => [
                    apt.patient,
                    apt.cpf || '',
                    apt.phone || '',
                    apt.date,
                    apt.time,
                    apt.professional,
                    apt.agendaType,
                    apt.location,
                    apt.notification
                ])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relat√≥rio de Agendamentos');
            XLSX.writeFile(wb, `relatorio_agendamentos_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Relat√≥rio exportado para Excel!');
        }

        function exportToCSV() {
            if (filteredAppointments.length === 0) {
                showToast('Nenhum relat√≥rio para exportar.');
                return;
            }

            const headers = ['Paciente', 'CPF', 'Telefone', 'Data', 'Hor√°rio', 'Profissional', 'Tipo', 'Local', 'Notifica√ß√£o'];
            const csvContent = [
                headers.join(','),
                ...filteredAppointments.map(apt => [
                    `"${apt.patient}"`,
                    apt.cpf || '',
                    apt.phone || '',
                    apt.date,
                    apt.time,
                    `"${apt.professional}"`,
                    apt.agendaType,
                    apt.location,
                    apt.notification
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `relatorio_agendamentos_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('Relat√≥rio exportado para CSV!');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        // Populate selects
        window.onload = function() {
            // Aviso sobre localStorage (melhoria de seguran√ßa)
            console.warn('Aviso: Dados salvos em localStorage. Para produ√ß√£o, migre para Firebase ou Supabase para melhor seguran√ßa e persist√™ncia.');

            // Agenda Types
            const agendaTypeSelect = document.getElementById('agendaTypeSelect');
            agendaTypeSelect.innerHTML = '<option value="">Selecione</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                agendaTypeSelect.appendChild(option);
            });

            // Edit Agenda Types
            const editAgendaTypeSelect = document.getElementById('editAgendaTypeSelect');
            editAgendaTypeSelect.innerHTML = '<option value="">Selecione</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                editAgendaTypeSelect.appendChild(option);
            });

            // Edit Times
            const editTimeSelect = document.getElementById('editTime');
            hours.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                editTimeSelect.appendChild(opt);
            });

            // Report Agenda Types
            const reportAgendaTypeSelect = document.getElementById('reportAgendaType');
            reportAgendaTypeSelect.innerHTML = '<option value="">Todos os Tipos</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                reportAgendaTypeSelect.appendChild(option);
            });

            // Locations
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Selecione um local</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });

            // Edit Locations
            const editLocationSelect = document.getElementById('editLocationSelect');
            editLocationSelect.innerHTML = '<option value="">Selecione um local</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                editLocationSelect.appendChild(option);
            });

            // Odontologia Professionals
            const odontologiaProfessional = document.getElementById('odontologiaProfessional');
            odontologiaProfessional.innerHTML = '<option value="">Todos</option>';
            dentists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                odontologiaProfessional.appendChild(option);
            });

            // Medicas Professionals
            const medicasProfessional = document.getElementById('medicasProfessional');
            medicasProfessional.innerHTML = '<option value="">Todos</option>';
            medicalSpecialists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                medicasProfessional.appendChild(option);
            });

            document.getElementById('agendaTypeSelect').onchange = function() {
                const agendaType = this.value;
                populateProfessionals(agendaType, 'dentistSelect');
                document.getElementById('dentistSelect').value = '';
                if (selectedDay) {
                    populateHours(selectedDay);
                }
                updateScheduleButton();
            };

            document.getElementById('dentistSelect').onchange = function() {
                if (selectedDay) {
                    populateHours(selectedDay);
                }
                updateScheduleButton();
            };

            document.getElementById('locationSelect').onchange = function() {
                updateScheduleButton();
            };

            document.getElementById('patientName').oninput = updateScheduleButton;
            document.getElementById('patientCpf').oninput = function() { formatCPF(this); validateCPF(this); };
            document.getElementById('patientPhone').oninput = function() { formatPhone(this); validatePhone(this); };

            const editCpfInput = document.getElementById('editPatientCpf');
            editCpfInput.oninput = function() { formatCPF(this); validateEditCPF(this); };

            const editPhoneInput = document.getElementById('editPatientPhone');
            editPhoneInput.oninput = function() { formatPhone(this); validateEditPhone(this); };

            generateCalendar();
            displayAppointments();
        };

        function updateScheduleButton() {
            const patientName = document.getElementById('patientName').value.trim();
            const patientCpf = document.getElementById('patientCpf').value.trim();
            const cpfValid = patientCpf && isValidCPF(patientCpf.replace(/\D/g, ''));
            const patientPhone = document.getElementById('patientPhone').value.trim();
            const phoneValid = patientPhone && (patientPhone.replace(/\D/g, '').length >= 10 && patientPhone.replace(/\D/g, '').length <= 11);
            const agendaType = document.getElementById('agendaTypeSelect').value;
            const professional = document.getElementById('dentistSelect').value;
            const location = document.getElementById('locationSelect').value;
            const btn = document.getElementById('scheduleBtn');
            btn.disabled = !patientName || !cpfValid || !phoneValid || !selectedDay || !selectedHour || !agendaType || !professional || !location;
        }

        function saveAppointment() {
            const patientName = sanitizeInput(document.getElementById('patientName').value.trim());
            const patientCpf = document.getElementById('patientCpf').value.trim();
            const cpfClean = patientCpf.replace(/\D/g, '');
            const patientPhone = document.getElementById('patientPhone').value.trim();
            const phoneClean = patientPhone.replace(/\D/g, '');
            const agendaType = document.getElementById('agendaTypeSelect').value;
            const professional = sanitizeInput(document.getElementById('dentistSelect').value);
            const location = document.getElementById('locationSelect').value;
            const notification = document.querySelector('input[name="notification"]:checked').value;
            const dateStr = selectedDay.toLocaleDateString('pt-BR');

            if (!isValidCPF(cpfClean)) {
                showToast('CPF inv√°lido.', 'error');
                return;
            }

            if (phoneClean.length < 10 || phoneClean.length > 11) {
                showToast('Telefone inv√°lido.', 'error');
                return;
            }

            // Check for duplicate
            const existing = appointments.find(apt => 
                apt.agendaType === agendaType &&
                apt.date === dateStr && 
                apt.time === selectedHour && 
                apt.professional === professional
            );
            if (existing) {
                showToast('J√° existe um agendamento para este profissional nesta data e hor√°rio.', 'error');
                return;
            }

            // Create new appointment
            const appointment = {
                id: Date.now(),
                patient: patientName,
                cpf: patientCpf,
                phone: patientPhone,
                location,
                agendaType,
                date: dateStr,
                time: selectedHour,
                professional,
                notification,
                timestamp: new Date().toISOString()
            };
            appointments.unshift(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            showToast('Consulta agendada com sucesso!');
            clearSelections();
            generateCalendar();
            displayAppointments();
        }

        function editAppointment(id) {
            const appointment = appointments.find(apt => apt.id === id);
            if (appointment) {
                editingId = id;
                document.getElementById('editPatientName').value = appointment.patient;
                document.getElementById('editPatientCpf').value = appointment.cpf || '';
                document.getElementById('editPatientPhone').value = appointment.phone || '';
                document.getElementById('editLocationSelect').value = appointment.location || '';
                document.getElementById('editAgendaTypeSelect').value = appointment.agendaType || '';
                populateEditProfessionals();
                document.getElementById('editDentistSelect').value = appointment.professional || '';
                // Set date
                const [d, m, y] = appointment.date.split('/');
                document.getElementById('editDate').value = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                // Set time
                document.getElementById('editTime').value = appointment.time;
                // Set notification
                document.querySelector(`input[name="editNotification"][value="${appointment.notification}"]`).checked = true;
                document.getElementById('editModal').style.display = 'block';
            }
        }

        function saveEdit() {
            const patientName = sanitizeInput(document.getElementById('editPatientName').value.trim());
            const patientCpf = document.getElementById('editPatientCpf').value.trim();
            const cpfClean = patientCpf.replace(/\D/g, '');
            const patientPhone = document.getElementById('editPatientPhone').value.trim();
            const phoneClean = patientPhone.replace(/\D/g, '');
            const location = document.getElementById('editLocationSelect').value;
            const agendaType = document.getElementById('editAgendaTypeSelect').value;
            const professional = sanitizeInput(document.getElementById('editDentistSelect').value);
            const notification = document.querySelector('input[name="editNotification"]:checked').value;
            const newDateInput = document.getElementById('editDate').value;
            const newTime = document.getElementById('editTime').value;

            if (!patientName || !isValidCPF(cpfClean) || (phoneClean.length < 10 || phoneClean.length > 11) || !location || !agendaType || !professional || !newDateInput || !newTime) {
                showToast('Preencha todos os campos obrigat√≥rios e verifique o CPF e telefone.', 'error');
                return;
            }

            const [y, m, d] = newDateInput.split('-');
            const newDateStr = `${d}/${m}/${y}`;

            // Check for conflict
            const existing = appointments.find(apt => 
                apt.id !== editingId &&
                apt.agendaType === agendaType &&
                apt.date === newDateStr && 
                apt.time === newTime && 
                apt.professional === professional
            );
            if (existing) {
                showToast('Conflito: J√° existe um agendamento neste hor√°rio para este profissional.', 'error');
                return;
            }

            const appointment = appointments.find(apt => apt.id === editingId);
            if (appointment) {
                appointment.patient = patientName;
                appointment.cpf = patientCpf;
                appointment.phone = patientPhone;
                appointment.location = location;
                appointment.agendaType = agendaType;
                appointment.date = newDateStr;
                appointment.time = newTime;
                appointment.professional = professional;
                appointment.notification = notification;
                appointment.timestamp = new Date().toISOString();
            }
            localStorage.setItem('appointments', JSON.stringify(appointments));
            closeModal('editModal');
            editingId = null;
            showToast('Consulta atualizada com sucesso!');
            generateCalendar();
            displayAppointments();
        }

        function deleteAppointment(id) {
            deleteId = id;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function confirmDelete() {
            if (deleteId) {
                appointments = appointments.filter(apt => apt.id !== deleteId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                closeModal('deleteModal');
                deleteId = null;
                showToast('Consulta exclu√≠da com sucesso!');
                generateCalendar();
                displayAppointments();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const deleteModal = document.getElementById('deleteModal');
            const editModal = document.getElementById('editModal');
            if (event.target === deleteModal) {
                closeModal('deleteModal');
            }
            if (event.target === editModal) {
                closeModal('editModal');
            }
        }

        function filterAppointments() {
            displayAppointments();
        }

        function displayAppointments() {
            const odontologiaList = document.getElementById('odontologiaList');
            const medicasList = document.getElementById('medicasList');

            const odontologiaStart = document.getElementById('odontologiaStartDate').value;
            const odontologiaEnd = document.getElementById('odontologiaEndDate').value;
            const odontologiaProf = document.getElementById('odontologiaProfessional').value;
            const odontologiaCpf = document.getElementById('odontologiaCpf').value.replace(/\D/g, '');
            const odontologiaSearch = document.getElementById('odontologiaSearch').value.toLowerCase().trim();
            const medicasStart = document.getElementById('medicasStartDate').value;
            const medicasEnd = document.getElementById('medicasEndDate').value;
            const medicasProf = document.getElementById('medicasProfessional').value;
            const medicasCpf = document.getElementById('medicasCpf').value.replace(/\D/g, '');
            const medicasSearch = document.getElementById('medicasSearch').value.toLowerCase().trim();

            let odontologiaAppts = appointments.filter(apt => apt.agendaType === 'Agenda Odontol√≥gica');
            odontologiaAppts = odontologiaAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (odontologiaStart) {
                    const start = new Date(odontologiaStart);
                    if (aptDate < start) return false;
                }
                if (odontologiaEnd) {
                    const end = new Date(odontologiaEnd);
                    if (aptDate > end) return false;
                }
                if (odontologiaProf && apt.professional !== odontologiaProf) return false;
                if (odontologiaCpf && apt.cpf.replace(/\D/g, '') !== odontologiaCpf) return false;
                if (odontologiaSearch && !apt.patient.toLowerCase().includes(odontologiaSearch)) return false;
                return true;
            });

            let medicasAppts = appointments.filter(apt => apt.agendaType === 'Agenda Especialidades M√©dicas');
            medicasAppts = medicasAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (medicasStart) {
                    const start = new Date(medicasStart);
                    if (aptDate < start) return false;
                }
                if (medicasEnd) {
                    const end = new Date(medicasEnd);
                    if (aptDate > end) return false;
                }
                if (medicasProf && apt.professional !== medicasProf) return false;
                if (medicasCpf && apt.cpf.replace(/\D/g, '') !== medicasCpf) return false;
                if (medicasSearch && !apt.patient.toLowerCase().includes(medicasSearch)) return false;
                return true;
            });

            if (odontologiaAppts.length === 0) {
                odontologiaList.innerHTML = '<p class="empty-message">Nenhum agendamento odontol√≥gico.</p>';
            } else {
                odontologiaList.innerHTML = '';
                odontologiaAppts.forEach(apt => {
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.setAttribute('role', 'listitem');
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar agendamento">Editar</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Excluir agendamento">Excluir</button>
                        </div>
                        <h4>${sanitizeInput(apt.patient)} - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'N√£o informado'} | Telefone: ${apt.phone || 'N√£o informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'N√£o informado'} | Local: ${apt.location || 'N√£o informado'} | Notifica√ß√£o: ${apt.notification}</p>
                    `;
                    odontologiaList.appendChild(card);
                });
            }

            if (medicasAppts.length === 0) {
                medicasList.innerHTML = '<p class="empty-message">Nenhum agendamento de especialidades m√©dicas.</p>';
            } else {
                medicasList.innerHTML = '';
                medicasAppts.forEach(apt => {
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.setAttribute('role', 'listitem');
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar agendamento">Editar</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Excluir agendamento">Excluir</button>
                        </div>
                        <h4>${sanitizeInput(apt.patient)} - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'N√£o informado'} | Telefone: ${apt.phone || 'N√£o informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'N√£o informado'} | Local: ${apt.location || 'N√£o informado'} | Notifica√ß√£o: ${apt.notification}</p>
                    `;
                    medicasList.appendChild(card);
                });
            }
        }
    </script>
</body>
</html>