<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento Médico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        :root {
            --bg-primary: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            --bg-secondary: white;
            --text-primary: #2c3e50;
            --accent: #007bff;
            --success: #28a745;
            --error: #e74c3c;
            --warning: #ffc107;
        }
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --bg-secondary: #2d2d2d;
            --text-primary: #f0f4f8;
            --accent: #007bff;
            --success: #28a745;
            --error: e74c3c;
            --warning: #ffc107;
        }
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 15px;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
            transition: all 0.3s ease;
        }
        .header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.2);
        }
        .header-logo {
            height: 90px;
            width: auto;
            transition: transform 0.3s ease;
        }
        #melhoriaLogo {
            height: 120px;
        }
        .header-logo:hover {
            transform: scale(1.05);
        }
        .logo {
            font-size: 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        .section:nth-child(1) { animation-delay: 0.1s; }
        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.3s; }
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: all 0.3s ease;
        }
        .section:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        h3 {
            color: #007bff;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        h3:hover {
            color: #0056b3;
            transform: translateX(5px);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .month-nav button {
            background: #e9ecef;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: #6c757d;
        }
        .month-nav button:hover {
            background: #007bff;
            color: white;
            transform: scale(1.1) rotate(5deg);
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .day-header {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            padding: 6px;
            font-weight: 500;
            font-size: 11px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .day-header:hover {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        .day {
            padding: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
            margin: 0.5px;
            position: relative;
        }
        .day:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: scale(1.05) rotate(1deg);
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .day.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
            animation: pulseSelected 0.6s ease;
        }
        @keyframes pulseSelected {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .day.other-month {
            color: #adb5bd;
            background: transparent;
        }
        .day.unavailable {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        .day.holiday {
            background: #ffeb3b;
            color: #000;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .day.holiday:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(255,235,59,0.3);
        }
        .day.blocked {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: var(--error);
            font-weight: bold;
            cursor: not-allowed;
            border-color: var(--error);
        }
        .day.unavailable:hover {
            background: #f8f9fa;
            transform: none;
            border-color: #e9ecef;
        }
        .day.past {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        .day.has-appointment::after {
            content: '•';
            position: absolute;
            bottom: 1px;
            right: 2px;
            color: #dc3545;
            font-size: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        .selected-date {
            margin-top: 8px;
            padding: 8px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 6px;
            font-style: italic;
            color: #0056b3;
            border-left: 3px solid #007bff;
            animation: fadeIn 0.5s ease;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        .selected-date:hover {
            transform: translateX(5px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
            transition: all 0.3s ease;
        }
        .hour-slot {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffd54f;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hour-slot:hover, .hour-slot.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        .hour-slot.booked {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #f5c6cb;
            color: #721c24;
            cursor: not-allowed;
            font-weight: bold;
        }
        .hour-slot.booked:hover {
            transform: scale(1) rotate(0deg);
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            box-shadow: 0 2px 4px rgba(220,53,69,0.2);
        }
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 13px;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 10px;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            transform: scale(1.02);
        }
        input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
            transition: color 0.3s ease;
        }
        label:hover {
            color: #007bff;
        }
        .radio-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-weight: 400;
            font-size: 13px;
        }
        .radio-group label:hover {
            background: #f8f9fa;
            transform: translateX(2px) scale(1.02);
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
            transition: all 0.3s ease;
        }
        .schedule-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
            position: relative;
        }
        .schedule-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        .schedule-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        .block-btn {
            background: linear-gradient(135deg, var(--error) 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
            margin-top: 5px;
        }
        .block-btn:hover:not(:disabled) {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        .block-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        #blockDateContainer {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .dentist-select {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .dentist-select:hover {
            border-top-color: #007bff;
        }
        .dentist-select h4 {
            margin: 0 0 6px 0;
            color: #007bff;
            font-size: 13px;
            transition: color 0.3s ease;
        }
        .agenda-type-select {
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        .agenda-type-select h4 {
            margin: 0 0 6px 0;
            color: #007bff;
            font-size: 13px;
            transition: color 0.3s ease;
        }
        .report-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        .report-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffc107, #dc3545);
            transition: all 0.3s ease;
        }
        .report-section:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .report-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        .report-filters select, .report-filters input {
            flex: 1;
            min-width: 150px;
            transition: all 0.3s ease;
        }
        .report-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
            position: relative;
        }
        .report-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }
        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
            margin-left: 10px;
        }
        .export-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .report-table th, .report-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .report-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 500;
            color: #495057;
        }
        .report-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .report-table tr:hover {
            background: #e3f2fd;
            transform: scale(1.01);
        }
        .report-table .status {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        .report-table .status:hover {
            transform: scale(1.1);
        }
        .report-table .status.attended {
            background: #d4edda;
            color: #155724;
        }
        .report-table .status.no-show {
            background: #f8d7da;
            color: #721c24;
        }
        .report-table .status.rescheduled {
            background: #fff3cd;
            color: #856404;
        }
        .report-table .status.pending {
            background: #e2e3e5;
            color: #383d41;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .summary-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        .summary-item:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,123,255,0.2);
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            color: #007bff;
            transition: color 0.3s ease;
        }
        .summary-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #0056b3;
            transition: all 0.3s ease;
        }
        .chart-container {
            margin-top: 20px;
            text-align: center;
            height: 150px;
            position: relative;
            transition: all 0.3s ease;
        }
        .chart-percentages {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .chart-wrapper {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }
        .chart-wrapper:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .scheduled-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-top: 20px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        .scheduled-section:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .scheduled-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #28a745, #ffc107);
            transition: all 0.3s ease;
        }
        .toggle-scheduled-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
            width: auto;
            margin: 0 0 10px 0;
            display: inline-block;
        }
        .toggle-scheduled-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        .scheduled-grid {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 12px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease;
        }
        .scheduled-grid.show {
            display: grid;
            opacity: 1;
            transform: translateY(0);
        }
        .scheduled-column {
            border-left: 3px solid #007bff;
            padding-left: 10px;
            transition: all 0.3s ease;
        }
        .scheduled-column:hover {
            border-left-color: #0056b3;
            transform: translateX(5px);
        }
        .scheduled-column.odontologia {
            border-left-color: #28a745;
        }
        .scheduled-column.odontologia:hover {
            border-left-color: #20c997;
        }
        .scheduled-column.exames {
            border-left-color: #17a2b8;
        }
        .scheduled-column.exames:hover {
            border-left-color: #138496;
        }
        .scheduled-column h4 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .scheduled-column h4:hover {
            color: #0056b3;
            transform: translateX(5px);
        }
        .scheduled-column.odontologia h4 {
            color: #28a745;
        }
        .scheduled-column.odontologia h4:hover {
            color: #20c997;
        }
        .scheduled-column.exames h4 {
            color: #17a2b8;
        }
        .scheduled-column.exames h4:hover {
            color: #138496;
        }
        .date-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        .date-filters input {
            width: auto;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        .date-filters label {
            font-size: 12px;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        .professional-filter {
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .cpf-filter {
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .search-filter {
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .professional-filter label, .cpf-filter label, .search-filter label {
            font-size: 12px;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        .professional-filter select, .cpf-filter input, .search-filter input {
            width: 100%;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .cpf-filter input, .search-filter input {
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        .clear-filters-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 5px;
            transition: all 0.3s ease;
        }
        .clear-filters-btn:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        .scheduled-list {
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        .appointment-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #007bff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-20px);
        }
        .appointment-card.show {
            opacity: 1;
            transform: translateX(0);
        }
        .appointment-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px) scale(1.02);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        .appointment-card h4 {
            margin: 0 0 4px 0;
            color: #0056b3;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .appointment-card h4:hover {
            color: #007bff;
            transform: translateX(5px);
        }
        .patient-name {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        .patient-name:hover {
            color: #0056b3;
        }
        .appointment-card p {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
            transition: color 0.3s ease;
        }
        .appointment-card .observations {
            font-style: italic;
            color: #495057;
            margin-top: 4px;
            transition: all 0.3s ease;
        }
        .appointment-card .status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        .appointment-card .status:hover {
            transform: scale(1.1);
        }
        .appointment-card .status.attended {
            background: #d4edda;
            color: #155724;
        }
        .appointment-card .status.no-show {
            background: #f8d7da;
            color: #721c24;
        }
        .appointment-card .status.rescheduled {
            background: #fff3cd;
            color: #856404;
        }
        .appointment-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        .appointment-actions button:hover {
            transform: scale(1.1);
        }
        .btn-edit, .btn-delete, .btn-attended, .btn-no-show, .btn-rescheduled, .btn-pdf, .btn-clinica, .btn-declaration {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            margin-bottom: 2px;
        }
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        .btn-edit:hover {
            background: #e0a800;
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 2px 8px rgba(255,193,7,0.3);
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.1) rotate(-5deg);
            box-shadow: 0 2px 8px rgba(220,53,69,0.3);
        }
        .btn-attended {
            background: #28a745;
            color: white;
        }
        .btn-attended:hover {
            background: #218838;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }
        .btn-no-show {
            background: #6c757d;
            color: white;
        }
        .btn-no-show:hover {
            background: #5a6268;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(108,117,125,0.3);
        }
        .btn-rescheduled {
            background: #ffc107;
            color: #000;
        }
        .btn-rescheduled:hover {
            background: #e0a800;
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 2px 8px rgba(255,193,7,0.3);
        }
        .btn-pdf {
            background: #17a2b8;
            color: white;
            padding: 4px 6px;
            font-size: 10px;
        }
        .btn-pdf:hover {
            background: #138496;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(23,162,184,0.3);
        }
        .btn-clinica {
            background: #6f42c1;
            color: white;
            padding: 4px 6px;
            font-size: 10px;
        }
        .btn-clinica:hover {
            background: #5a32a3;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
        }
        .btn-declaration {
            background: #6f42c1;
            color: white;
            padding: 6px 10px;
            font-size: 11px;
        }
        .btn-declaration:hover {
            background: #5a32a3;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
        }
        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        .empty-message:hover {
            opacity: 1;
            transform: scale(1.02);
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.4s ease;
            transition: all 0.3s ease;
        }
        .modal.show {
            animation: fadeIn 0.4s ease;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: scale(0.9);
            opacity: 0;
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes modalSlideIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .close:hover {
            color: #000;
            transform: rotate(90deg) scale(1.2);
        }
        .modal h3 {
            margin-top: 0;
            color: #007bff;
            transition: color 0.3s ease;
        }
        .modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
            transition: color 0.3s ease;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .modal textarea {
            resize: vertical;
            min-height: 60px;
        }
        .modal .radio-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .modal .radio-group label {
            padding: 4px;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .modal-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-btn:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        .cancel-btn {
            background: #6c757d;
        }
        .confirm-delete {
            background: #dc3545;
        }
        .modal input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
            animation: shake 0.5s ease-in-out;
        }
        .modal .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #28a745;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%) translateY(20px);
            font-size: 14px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toast.show {
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            animation: bounceIn 0.6s ease;
        }
        @keyframes bounceIn {
            0% { transform: translateX(-50%) translateY(20px) scale(0.3); opacity: 0; }
            50% { transform: translateX(-50%) translateY(-10px) scale(1.05); opacity: 1; }
            70% { transform: translateX(-50%) translateY(5px) scale(0.98); }
            100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
        }
        .toast.error {
            background-color: #dc3545;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            transform: rotate(180deg) scale(1.2);
        }
        .help-tooltip {
            position: relative;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .help-tooltip:hover {
            transform: scale(1.1);
        }
        .help-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 12px;
            transform: translateY(10px);
        }
        .help-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .clear-all-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .clear-all-btn:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
            }
            .summary {
                flex-direction: column;
            }
            .summary-item {
                margin: 5px 0;
            }
            .scheduled-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
            .date-filters {
                flex-direction: column;
            }
            .charts-container {
                grid-template-columns: 1fr 1fr;
            }
            .appointment-actions {
                flex-direction: column;
                gap: 2px;
            }
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            body {
                padding: 10px;
            }
            .header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            .appointment-actions {
                position: static;
                justify-content: center;
                margin-top: 8px;
                gap: 8px;
            }
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            .report-filters {
                flex-direction: column;
            }
            .hours-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .required {
            color: #dc3545;
        }
        /* Melhorias de acessibilidade para botões */
        button:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            animation: focusPulse 0.3s ease;
        }
        @keyframes focusPulse {
            0% { box-shadow: 0 0 0 0 rgba(0,123,255,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0,123,255,0); }
            100% { box-shadow: 0 0 0 0 rgba(0,123,255,0); }
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        button[aria-disabled="true"] {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Focus trap para modais */
        .modal:focus-within {
            outline: none;
        }
        /* Ajuste para grid de bloqueados (uma coluna) */
        #blockedGrid {
            grid-template-columns: 1fr !important;
        }
        .blocked-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            text-align: center;
        }
        .blocked-summary-item {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            padding: 10px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        .blocked-summary-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
        }
        .blocked-summary-item h4 {
            margin: 0 0 5px 0;
            color: var(--error);
            font-size: 12px;
        }
        .blocked-summary-item p {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            color: #721c24;
        }
        .block-card {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left: 4px solid var(--error);
            padding: 12px 70px 12px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-20px);
        }
        .block-card.show {
            opacity: 1;
            transform: translateX(0);
        }
        .block-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px) scale(1.02);
        }
        .block-card h4 {
            margin: 0 0 4px 0;
            color: var(--error);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .block-card p {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #721c24;
            line-height: 1.4;
        }
        .block-actions {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        .block-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .history-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .history-item .status {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .declaration-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            margin-bottom: 10px;
        }
        .declaration-btn:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
        }
        /* Discount Modal Styles */
        .discount-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .discount-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .discount-checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .discount-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .discount-input-group input {
            width: 80px;
            text-align: right;
        }
        .discount-input-group span {
            font-size: 12px;
            color: #6c757d;
        }
        .promotion-select-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .apply-discount-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        .apply-discount-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .apply-promo-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }
        .apply-promo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }
        .add-discount-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        .add-discount-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .service-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .service-info h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .price-display {
            font-size: 16px;
            font-weight: bold;
            color: #28a745;
        }
        .discounted-price {
            color: #dc3545;
            text-decoration: line-through;
            margin-right: 10px;
        }
        .final-price-display {
            color: #28a745;
            font-weight: bold;
        }
        /* Discount Display Section */
        #displayedDiscounts {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        #displayedDiscounts h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 14px;
        }
        #displayedDiscounts p {
            margin: 5px 0;
            font-weight: 500;
            color: #d39e00;
        }
        .close-discount-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .close-discount-btn:hover {
            background: #5a6268;
            transform: scale(1.02);
        }
        .exam-price-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
            width: auto;
            margin: 10px 0;
        }
        .exam-price-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.3);
        }
        /* Agenda Management Styles - Updated for Table View */
        .agenda-mgmt-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .agenda-mgmt-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .agenda-mgmt-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .agenda-mgmt-item.odontologica {
            border-left-color: #28a745;
        }
        .agenda-mgmt-item.medicas {
            border-left-color: #17a2b8;
        }
        .agenda-mgmt-item h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .agenda-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .agenda-table th, .agenda-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }
        .agenda-table th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            font-weight: 500;
        }
        .agenda-table td input {
            width: 80px;
            text-align: center;
            padding: 4px;
            border: 1px solid #007bff;
            border-radius: 4px;
        }
        .agenda-table .gray-cell {
            background: #e9ecef;
            color: #adb5bd;
        }
        .agenda-table .gray-cell input {
            background: #e9ecef;
            border-color: #adb5bd;
            cursor: not-allowed;
        }
        .save-agenda-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .save-agenda-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .agenda-mgmt-toggle {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        .agenda-mgmt-toggle:hover {
            transform: translateY(-1px);
        }
        /* Button Row for Scheduled Column */
        .button-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .button-row .block-btn {
            margin-top: 0;
            flex: 0 0 auto;
        }
        .button-row .agenda-mgmt-toggle {
            margin: 0;
            flex: 1;
            text-align: center;
        }
    </style>
</head>
<body data-theme="light">
    <div class="header">
        <img src="img/sesibranco.png" alt="SESI Logo" class="header-logo" id="sesiLogo">
        <div class="logo">
            <span>🩺</span>
            Agendamento Pessoa Física - SESI Saúde
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema" role="switch" aria-checked="false">🌙</button>
        <img src="img/melhoriatodobranco.png" alt="Melhoria Logo" class="header-logo" id="melhoriaLogo">
    </div>
    <div class="container">
        <div class="section">
            <h3>👤 Dados da Consulta</h3>
            <label for="patientName">Nome do Paciente <span aria-hidden="true" class="required">*</span> <span class="help-tooltip">?<span class="tooltip-text">Digite o nome completo do paciente para facilitar a identificação.</span></span></label>
            <input type="text" id="patientName" placeholder="Digite o nome completo do paciente" aria-required="true" aria-describedby="patientNameDesc" required>
            <small id="patientNameDesc" class="sr-only">Campo obrigatório. Digite o nome completo do paciente.</small>
            <label for="patientCpf">CPF do Paciente <span class="help-tooltip">?<span class="tooltip-text">Formato: 123.456.789-00. Validação automática.</span></span></label>
            <input type="text" id="patientCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" aria-describedby="cpfError patientCpfDesc">
            <small id="cpfError" class="error-message" aria-live="polite">CPF inválido. (Apenas Números).</small>
            <small id="patientCpfDesc" class="sr-only">Campo opcional. Digite o CPF no formato 123.456.789-00.</small>
            <label for="patientPhone">Número do Telefone <span aria-hidden="true" class="required">*</span> <span class="help-tooltip">?<span class="tooltip-text">Formato: (11) 99999-9999. Validação automática.</span></span></label>
            <input type="tel" id="patientPhone" placeholder="Digite o número do telefone (ex: (11) 99999-9999)" aria-required="true" aria-describedby="phoneError patientPhoneDesc" required>
            <small id="phoneError" class="error-message" aria-live="polite">Telefone inválido. Use o formato (DD) 9XXXX-XXXX.</small>
            <small id="patientPhoneDesc" class="sr-only">Campo obrigatório. Digite o telefone no formato (11) 99999-9999.</small>
            <label for="schedulerName">Responsável pelo Agendamento <span class="help-tooltip">?<span class="tooltip-text">Opcional: Nome de quem está agendando.</span></span></label>
            <input type="text" id="schedulerName" placeholder="Digite o nome do responsável pelo agendamento" aria-describedby="schedulerNameDesc">
            <small id="schedulerNameDesc" class="sr-only">Campo opcional para o nome do responsável pelo agendamento.</small>
            <label for="locationSelect">🏢 Local do Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="locationSelect" aria-required="true" aria-describedby="locationDesc" required>
                <option value="">Selecione um local</option>
            </select>
            <small id="locationDesc" class="sr-only">Campo obrigatório. Escolha o local de atendimento.</small>
            <label for="prioritySelect">Atendimento Prioritário <span aria-hidden="true" class="required">*</span> <span class="help-tooltip">?<span class="tooltip-text">Indique se o paciente precisa de atendimento urgente.</span></span></label>
            <select id="prioritySelect" aria-required="true" aria-describedby="priorityDesc" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>
            <small id="priorityDesc" class="sr-only">Indique se o atendimento é prioritário.</small>
            <label for="firstAppointmentSelect">Primeiro Atendimento <span aria-hidden="true" class="required">*</span> <span class="help-tooltip">?<span class="tooltip-text">Marque se é a primeira consulta do paciente.</span></span></label>
            <select id="firstAppointmentSelect" aria-required="true" aria-describedby="firstAppointmentDesc" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>
            <small id="firstAppointmentDesc" class="sr-only">Indique se é o primeiro atendimento.</small>
            <label for="observations">Observações <span class="help-tooltip">?<span class="tooltip-text">Adicione detalhes importantes sobre o paciente ou consulta.</span></span></label>
            <textarea id="observations" placeholder="Digite observações adicionais (opcional)" aria-describedby="observationsDesc"></textarea>
            <small id="observationsDesc" class="sr-only">Campo opcional para observações adicionais.</small>
            <div id="displayedDiscounts" style="display:none;">
                <h4>Descontos Aplicados:</h4>
                <p id="industryDiscountDisplay"></p>
                <p id="promotionalDiscountDisplay"></p>
                <button class="close-discount-btn" onclick="closeDiscountDisplay()">Fechar</button>
            </div>
        </div>
        <div class="section">
            <h3>Especialidades Disponíveis</h3>
            <div class="agenda-type-select">
                <h4>📋 Selecione o Tipo de Agenda</h4>
                <label for="agendaTypeSelect" class="sr-only">Tipo de agenda</label>
                <select id="agendaTypeSelect" aria-required="true" aria-describedby="agendaTypeDesc">
                    <option value="">Selecione</option>
                </select>
                <small id="agendaTypeDesc" class="sr-only">Escolha o tipo de agenda para exibir profissionais e horários disponíveis.</small>
            </div>
            <div class="dentist-select">
                <h4>👤 Selecione o Profissional</h4>
                <label for="dentistSelect" class="sr-only">Profissional</label>
                <select id="dentistSelect" aria-required="true" aria-describedby="dentistDesc">
                    <option value="">Selecione um profissional</option>
                </select>
                <small id="dentistDesc" class="sr-only">Selecione o profissional para verificar horários disponíveis.</small>
            </div>
            <div class="button-row" id="sectionButtons" style="display: flex;">
                <button class="block-btn" id="blockDateBtn" onclick="blockSelectedDate()" disabled aria-label="Bloquear data selecionada" role="button">🔒 Bloquear Data</button>
                <button class="agenda-mgmt-toggle" onclick="toggleAgendaMgmt()" aria-label="Gerenciar agenda" role="button">📋 Gestão de Agenda</button>
                <button class="block-btn" id="blockProfessionalBtn" onclick="blockSelectedProfessional()" aria-label="Bloquear profissional" role="button">🔒 Bloquear Profissional</button>
            </div>
            <div class="calendar-header">
                <div class="month-nav">
                    <button onclick="prevMonth()" aria-label="Mês anterior" role="button">‹</button>
                    <span class="month" id="monthDisplay" role="status">outubro 2025</span>
                    <button onclick="nextMonth()" aria-label="Próximo mês" role="button">›</button>
                </div>
            </div>
            <div class="calendar" id="calendar" role="grid" aria-label="Calendário">
                <!-- Calendar will be generated by JS -->
            </div>
            <div class="selected-date" id="selectedDate" style="display: none;" role="alert">
                Data selecionada: <span id="selectedDateText"></span>
            </div>
        </div>
        <div class="section">
            <h3>Selecione um Horário</h3>
            <div class="hours-grid" id="hoursGrid" role="grid" aria-label="Horários disponíveis">
                <!-- Hours will be populated by JS -->
            </div>
            <button class="add-discount-btn" onclick="openDiscountModal()" aria-label="Adicionar Desconto">Adicionar Desconto</button>
            <button class="schedule-btn" id="scheduleBtn" onclick="saveAppointment()" disabled aria-label="Agendar consulta (desabilitado até preencher todos os campos obrigatórios)" role="button">
                Agendar Consulta
                <div class="spinner" id="scheduleSpinner"></div>
            </button>
        </div>
    </div>
    <div class="agenda-mgmt-section" id="agendaMgmtSection" style="display: none;">
        <h3>📋 Gestão de Agenda (Inspirado em SOC S+)</h3>
        <button class="toggle-scheduled-btn" onclick="toggleAgendaMgmt()" aria-label="Fechar gestão de agenda" role="button">Fechar</button>
        <div class="agenda-mgmt-grid" id="agendaMgmtGrid">
            <!-- Populated by JS -->
        </div>
    </div>
    <div class="scheduled-section">
        <h3>📋 Consultas Agendadas</h3>
        <button class="toggle-scheduled-btn" id="toggleScheduledBtn" onclick="toggleScheduled()" aria-label="Mostrar ou ocultar lista de consultas agendadas" role="button">Mostrar Consultas Agendadas</button>
        <div class="scheduled-grid" id="scheduledGrid">
            <div class="scheduled-column odontologia">
                <h4>🦷 Odontológica</h4>
                <div class="date-filters">
                    <label for="odontologiaStartDate">Data Inicial:</label>
                    <input type="date" id="odontologiaStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial odontológica">
                    <label for="odontologiaEndDate">Data Final:</label>
                    <input type="date" id="odontologiaEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final odontológica">
                </div>
                <div class="professional-filter">
                    <label for="odontologiaProfessional">Profissional:</label>
                    <select id="odontologiaProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional odontológico">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label for="odontologiaCpf">CPF:</label>
                    <input type="text" id="odontologiaCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF odontológico">
                </div>
                <div class="search-filter">
                    <label for="odontologiaSearch">Buscar Paciente:</label>
                    <input type="text" id="odontologiaSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente odontológico">
                </div>
                <button class="clear-filters-btn" onclick="clearOdontologiaFilters()">Limpar Filtros</button>
                <div id="odontologiaList" class="scheduled-list" role="list" aria-label="Lista de agendamentos odontológicos">
                    <p class="empty-message">Nenhum agendamento odontológico.</p>
                </div>
            </div>
            <div class="scheduled-column">
                <h4>🏥 Especialidades Médicas</h4>
                <div class="date-filters">
                    <label for="medicasStartDate">Data Inicial:</label>
                    <input type="date" id="medicasStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial médica">
                    <label for="medicasEndDate">Data Final:</label>
                    <input type="date" id="medicasEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final médica">
                </div>
                <div class="professional-filter">
                    <label for="medicasProfessional">Profissional:</label>
                    <select id="medicasProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional médico">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label for="medicasCpf">CPF:</label>
                    <input type="text" id="medicasCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF médico">
                </div>
                <div class="search-filter">
                    <label for="medicasSearch">Buscar Paciente:</label>
                    <input type="text" id="medicasSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente médico">
                </div>
                <button class="clear-filters-btn" onclick="clearMedicasFilters()">Limpar Filtros</button>
                <div id="medicasList" class="scheduled-list" role="list" aria-label="Lista de agendamentos médicos">
                    <p class="empty-message">Nenhum agendamento de especialidades médicas.</p>
                </div>
            </div>
            <div class="scheduled-column exames">
                <h4>🔬 Exames</h4>
                <div class="date-filters">
                    <label for="examesStartDate">Data Inicial:</label>
                    <input type="date" id="examesStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial exames">
                    <label for="examesEndDate">Data Final:</label>
                    <input type="date" id="examesEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final exames">
                </div>
                <div class="professional-filter">
                    <label for="examesProfessional">Profissional:</label>
                    <select id="examesProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional exames">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label for="examesCpf">CPF:</label>
                    <input type="text" id="examesCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF exames">
                </div>
                <div class="search-filter">
                    <label for="examesSearch">Buscar Paciente:</label>
                    <input type="text" id="examesSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente exames">
                </div>
                <button class="clear-filters-btn" onclick="clearExamesFilters()">Limpar Filtros</button>
                <div id="examesList" class="scheduled-list" role="list" aria-label="Lista de agendamentos de exames">
                    <p class="empty-message">Nenhum agendamento de exames.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="scheduled-section" id="blockedSection">
        <h3>🔒 Gerenciar Datas Bloqueadas</h3>
        <button class="toggle-scheduled-btn" id="toggleBlockedBtn" onclick="toggleBlocked()" aria-label="Mostrar ou ocultar lista de datas bloqueadas" role="button">Mostrar Datas Bloqueadas</button>
        <div class="scheduled-grid" id="blockedGrid" style="display: none;">
            <div class="scheduled-column">
                <h4>Bloqueios Ativos</h4>
                <div id="blockedSummary" class="blocked-summary" style="display: none;"></div>
                <div id="blockedList" class="scheduled-list" role="list" aria-label="Lista de datas bloqueadas">
                    <p class="empty-message">Nenhuma data bloqueada.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="scheduled-section">
        <h3>📊 Relatórios de Agendamentos</h3>
        <button class="toggle-scheduled-btn" id="toggleReportBtn" onclick="toggleReport()" aria-label="Mostrar ou ocultar seção de relatórios" role="button">Mostrar Relatórios</button>
        <div class="report-section" id="reportContent" style="display: none;">
            <div class="report-filters">
                <label for="reportAgendaType" class="sr-only">Tipo de relatório</label>
                <select id="reportAgendaType" aria-label="Tipo de relatório">
                    <option value="">Todos os Tipos</option>
                    <option value="Agenda Odontológica">Agenda Odontológica</option>
                    <option value="Agenda Especialidades Médicas">Agenda Especialidades Médicas</option>
                    <option value="Agenda de Exames">Agenda de Exames</option>
                </select>
                <label for="reportStartDate" class="sr-only">Data inicial relatório</label>
                <input type="date" id="reportStartDate" aria-label="Data inicial relatório">
                <label for="reportEndDate" class="sr-only">Data final relatório</label>
                <input type="date" id="reportEndDate" aria-label="Data final relatório">
                <button class="report-btn" onclick="generateReport()" aria-label="Gerar relatório de agendamentos" role="button">
                    Gerar Relatório
                    <div class="spinner" id="reportSpinner"></div>
                </button>
                <button class="export-btn" id="exportBtn" onclick="exportToExcel()" style="display: none;" aria-label="Exportar relatório para Excel" role="button">Exportar Excel</button>
            </div>
            <div id="reportTableContainer" style="display: none;">
                <table class="report-table" id="reportTable" role="table" aria-label="Tabela de relatórios">
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>CPF</th>
                            <th>Telefone</th>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Profissional</th>
                            <th>Tipo</th>
                            <th>Local</th>
                            <th>Prioritário</th>
                            <th>Primeiro Atendimento</th>
                            <th>Status</th>
                            <th>Observações</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" role="rowgroup"></tbody>
                </table>
                <div class="summary" id="summaryStats"></div>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h4>Distribuição por Tipo</h4>
                        <div class="chart-container">
                            <canvas id="reportChart" aria-label="Gráfico de colunas mostrando distribuição de agendamentos por tipo" role="img"></canvas>
                        </div>
                        <div class="chart-percentages" id="barPercentages"></div>
                    </div>
                    <div class="chart-wrapper">
                        <h4>Taxa de Comparecimento Detalhada</h4>
                        <div class="chart-container">
                            <canvas id="attendanceChart" aria-label="Gráfico de colunas mostrando taxa de comparecimento detalhada" role="img"></canvas>
                        </div>
                        <div class="chart-percentages" id="barAttendancePercentages"></div>
                    </div>
                    <div class="chart-wrapper">
                        <h4>Produtividade por Profissional</h4>
                        <div class="chart-container">
                            <canvas id="productivityChart" aria-label="Gráfico de colunas mostrando produtividade por profissional" role="img"></canvas>
                        </div>
                        <div class="chart-percentages" id="productivityPercentages"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="scheduled-section">
        <h3>💰 Consulta Preço de Exames</h3>
        <button class="exam-price-btn" onclick="window.open('https://consultapreco.pe.sesi.org.br/', '_blank')" aria-label="Abrir consulta de preço de exames" role="button">Consulta Preço de Exames</button>
    </div>
    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert" aria-live="polite">Consulta agendada com sucesso!</div>
    <!-- Block Modal -->
    <div id="blockModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="blockTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('blockModal')" aria-label="Fechar modal de bloqueio de data">&times;</span>
            <h3 id="blockTitle">Bloquear Data</h3>
            <p>Data: <span id="blockDateText"></span></p>
            <label for="blockAgendaType">Tipo de Agenda <span aria-hidden="true" class="required">*</span></label>
            <select id="blockAgendaType" aria-required="true" required>
                <option value="">Selecione o tipo de agenda</option>
            </select>
            <label for="blockReason">Motivo do Bloqueio <span aria-hidden="true" class="required">*</span></label>
            <textarea id="blockReason" placeholder="Digite o motivo do bloqueio..." aria-required="true" required></textarea>
            <button class="modal-btn" onclick="confirmBlock()" aria-label="Confirmar bloqueio da data" role="button">Bloquear Data</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('blockModal')" aria-label="Cancelar bloqueio da data" role="button">Cancelar</button>
        </div>
    </div>
    <!-- Block Professional Modal -->
    <div id="blockProfessionalModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="blockProfessionalTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('blockProfessionalModal')" aria-label="Fechar modal de bloqueio de profissional">&times;</span>
            <h3 id="blockProfessionalTitle">Bloquear Profissional</h3>
            <label for="blockProfessionalAgendaType">Tipo de Agenda <span aria-hidden="true" class="required">*</span></label>
            <select id="blockProfessionalAgendaType" onchange="populateBlockProfessionalSelect()" aria-required="true" required>
                <option value="">Selecione o tipo de agenda</option>
            </select>
            <label for="blockProfessionalSelect">Profissional <span aria-hidden="true" class="required">*</span></label>
            <select id="blockProfessionalSelect" aria-required="true" required>
                <option value="">Selecione o profissional</option>
            </select>
            <label for="blockProfessionalStartDate">Data de Início do Bloqueio <span aria-hidden="true" class="required">*</span></label>
            <input type="date" id="blockProfessionalStartDate" aria-required="true" required>
            <label for="blockProfessionalEndDate">Data de Fim do Bloqueio <span aria-hidden="true" class="required">*</span></label>
            <input type="date" id="blockProfessionalEndDate" aria-required="true" required>
            <label for="blockProfessionalReason">Motivo do Bloqueio <span aria-hidden="true" class="required">*</span></label>
            <textarea id="blockProfessionalReason" placeholder="Digite o motivo do bloqueio..." aria-required="true" required></textarea>
            <button class="modal-btn" onclick="confirmBlockProfessional()" aria-label="Confirmar bloqueio do profissional" role="button">Bloquear Profissional</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('blockProfessionalModal')" aria-label="Cancelar bloqueio do profissional" role="button">Cancelar</button>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteModal')" aria-label="Fechar modal de confirmação de exclusão">&times;</span>
            <h3 id="deleteTitle">Confirmar Inativação</h3>
            <p>Tem certeza que deseja inativar esta consulta? Esta ação não pode ser desfeita.</p>
            <button class="modal-btn confirm-delete" onclick="confirmDelete()" aria-label="Confirmar inativação da consulta" role="button">Sim, Inativar</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('deleteModal')" aria-label="Cancelar inativação da consulta" role="button">Cancelar</button>
        </div>
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')" aria-label="Fechar modal de edição de consulta">&times;</span>
            <h3 id="editTitle">Editar Consulta</h3>
            <label for="editPatientName">Nome do Paciente <span aria-hidden="true" class="required">*</span></label>
            <input type="text" id="editPatientName" aria-required="true" required autofocus>
            <label for="editPatientCpf">CPF do Paciente</label>
            <input type="text" id="editPatientCpf" aria-describedby="editCpfError editPatientCpfDesc">
            <small id="editCpfError" class="error-message" aria-live="polite">CPF inválido. Verifique os dígitos.</small>
            <small id="editPatientCpfDesc" class="sr-only">Digite o CPF no formato 123.456.789-00.</small>
            <label for="editPatientPhone">Número do Telefone <span aria-hidden="true" class="required">*</span></label>
            <input type="tel" id="editPatientPhone" aria-required="true" aria-describedby="editPhoneError editPatientPhoneDesc" required>
            <small id="editPhoneError" class="error-message" aria-live="polite">Telefone inválido. Use o formato (DD) 9XXXX-XXXX.</small>
            <small id="editPatientPhoneDesc" class="sr-only">Digite o telefone no formato (11) 99999-9999.</small>
            <label for="editSchedulerName">Nome do Responsável pelo Agendamento</label>
            <input type="text" id="editSchedulerName" placeholder="Digite o nome do responsável pelo agendamento">
            <label for="editLocationSelect">Local do Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="editLocationSelect" aria-required="true" required></select>
            <label for="editAgendaTypeSelect">Tipo de Agenda <span aria-hidden="true" class="required">*</span></label>
            <select id="editAgendaTypeSelect" onchange="populateEditProfessionals()" aria-required="true" required></select>
            <label for="editDentistSelect">Profissional <span aria-hidden="true" class="required">*</span></label>
            <select id="editDentistSelect" onchange="populateEditTimes()" aria-required="true" required></select>
            <label for="editDate">Data da Consulta <span aria-hidden="true" class="required">*</span></label>
            <input type="date" id="editDate" required aria-required="true">
            <label for="editTime">Horário da Consulta <span aria-hidden="true" class="required">*</span></label>
            <select id="editTime" required aria-required="true"></select>
            <label for="editPrioritySelect">Atendimento Prioritário <span aria-hidden="true" class="required">*</span></label>
            <select id="editPrioritySelect" aria-required="true" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>
            <label for="editFirstAppointmentSelect">Primeiro Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="editFirstAppointmentSelect" aria-required="true" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>
            <label for="editObservations">Observações</label>
            <textarea id="editObservations" placeholder="Digite observações adicionais (opcional)"></textarea>
            <button class="modal-btn" onclick="saveEdit()" aria-label="Salvar alterações na consulta" role="button">Salvar Alterações</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('editModal')" aria-label="Cancelar edição da consulta" role="button">Cancelar</button>
        </div>
    </div>
    <!-- Print Confirmation Modal -->
    <div id="printConfirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="printConfirmTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('printConfirmModal')" aria-label="Fechar modal de confirmação de impressão">&times;</span>
            <h3 id="printConfirmTitle">Imprimir Comprovante</h3>
            <p>Deseja imprimir o comprovante de agendamento?</p>
            <button class="modal-btn" onclick="showPrintTypeModal()" aria-label="Sim, imprimir" role="button">Sim</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('printConfirmModal')" aria-label="Não imprimir" role="button">Não</button>
        </div>
    </div>
    <!-- Print Type Modal -->
    <div id="printTypeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="printTypeTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('printTypeModal')" aria-label="Fechar modal de tipo de impressão">&times;</span>
            <h3 id="printTypeTitle">Tipo de Impressão</h3>
            <div class="radio-group">
                <label><input type="radio" name="printType" value="normal" checked> Impressora Padrão</label>
                <label><input type="radio" name="printType" value="thermal"> Impressora Térmica</label>
            </div>
            <button class="modal-btn" onclick="generatePrintPDF()" aria-label="Gerar PDF" role="button">Gerar PDF</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('printTypeModal')" aria-label="Cancelar impressão" role="button">Cancelar</button>
        </div>
    </div>
    <!-- Patient History Modal -->
    <div id="patientHistoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('patientHistoryModal')" aria-label="Fechar histórico do paciente">&times;</span>
            <h3 id="historyTitle">Histórico de Atendimentos</h3>
            <p id="historyPatientInfo"></p>
            <div id="historyList" class="history-list"></div>
            <button class="modal-btn cancel-btn" onclick="closeModal('patientHistoryModal')" aria-label="Fechar histórico" role="button">Fechar</button>
        </div>
    </div>
    <!-- Discount Modal -->
    <div id="discountModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="discountTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('discountModal')" aria-label="Fechar modal de desconto">&times;</span>
            <h3 id="discountTitle">Adicionar Desconto</h3>
            <div id="serviceInfo" class="service-info" style="display: none;">
                <h4 id="serviceNameDisplay"></h4>
                <p>Preço Atual: <span id="currentPriceDisplay" class="price-display">R$ 0,00</span></p>
                <p id="discountedInfo" style="display: none;">
                    Preço com Desconto: <span id="discountedPriceDisplay" class="final-price-display">R$ 0,00</span>
                </p>
            </div>
            <div class="discount-checkbox-group">
                <div class="discount-checkbox-item">
                    <input type="checkbox" id="industryDiscount" onchange="toggleDiscountInput('industryDiscountInput', this.checked); calculateDiscount()">
                    <label for="industryDiscount">Desconto Industria</label>
                    <div class="discount-input-group" id="industryDiscountInput" style="display: none;">
                        <input type="number" id="industryDiscountValue" placeholder="10.00" step="0.01" min="0" max="100" onchange="calculateDiscount()">
                        <span>%</span>
                    </div>
                    <small>Digite um valor em %</small>
                </div>
                <div class="discount-checkbox-item">
                    <input type="checkbox" id="promotionalDiscount" onchange="toggleDiscountInput('promotionalDiscountInput', this.checked); calculateDiscount()">
                    <label for="promotionalDiscount">Desconto Promocional</label>
                    <div class="discount-input-group" id="promotionalDiscountInput" style="display: none;">
                        <input type="number" id="promotionalDiscountValue" placeholder="0.00" step="0.01" min="0" max="100" onchange="calculateDiscount()">
                        <span>%</span>
                    </div>
                    <small>Digite um valor em %</small>
                </div>
            </div>
            <div class="promotion-select-group">
                <div>
                    <label for="promotionType">Seleção de promoção</label>
                    <select id="promotionType">
                        <option value="">Selecione</option>
                        <option value="Semana do Consumidor">Semana do Consumidor</option>
                        <option value="Black Friday">Black Friday</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label for="startDate">Data de Início</label>
                    <input type="date" id="startDate">
                </div>
                <div>
                    <label for="endDate">Data de Término</label>
                    <input type="date" id="endDate">
                </div>
                <div>
                    <label for="otherPromotion">Outra promoção</label>
                    <input type="text" id="otherPromotion" placeholder="Digite o nome da promoção" style="display: none;">
                </div>
            </div>
            <button class="apply-discount-btn" onclick="applyDiscount()">Aplicar Desconto</button>
        </div>
    </div>
    <!-- Declaration Time Modal -->
    <div id="declarationTimeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="declarationTimeTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('declarationTimeModal')" aria-label="Fechar modal de horário de declaração">&times;</span>
            <h3 id="declarationTimeTitle">Adicionar Horário de Entrada</h3>
            <p id="declarationPatientInfo"></p>
            <label for="entryTime">Horário de Entrada do Trabalhador <span aria-hidden="true" class="required">*</span></label>
            <input type="time" id="entryTime" required aria-required="true" aria-describedby="entryTimeDesc">
            <small id="entryTimeDesc" class="sr-only">Selecione o horário de entrada do trabalhador para incluir na declaração.</small>
            <button class="modal-btn" onclick="confirmDeclarationTime()" aria-label="Gerar declaração" role="button">Gerar Declaração</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('declarationTimeModal')" aria-label="Cancelar" role="button">Cancelar</button>
        </div>
    </div>
    <script>
        let currentDate = new Date(); // Alterado para usar a data atual (ex: 31/10/2025)
        let selectedDay = null;
        let selectedHour = null;
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let blockedDates = JSON.parse(localStorage.getItem('blockedDates')) || [];
        let blockedProfessionals = JSON.parse(localStorage.getItem('blockedProfessionals')) || [];
        // Updated structure for day-specific schedules
        let agendaSchedules = JSON.parse(localStorage.getItem('agendaSchedules')) || {
            'Agenda Odontológica': {
                0: [], // Domingo
                1: [ // Segunda
                    {start: '08:00', end: '11:00'},
                    {start: '12:00', end: '12:50'},
                    {start: '13:00', end: '17:00'}
                ],
                2: [ // Terça
                    {start: '08:00', end: '11:00'},
                    {start: '12:00', end: '12:50'},
                    {start: '13:00', end: '17:00'}
                ],
                3: [ // Quarta
                    {start: '08:00', end: '11:00'},
                    {start: '12:00', end: '12:50'},
                    {start: '13:00', end: '17:00'}
                ],
                4: [ // Quinta
                    {start: '08:00', end: '11:00'},
                    {start: '12:00', end: '12:50'},
                    {start: '13:00', end: '17:00'}
                ],
                5: [ // Sexta
                    {start: '08:00', end: '11:00'},
                    {start: '12:00', end: '12:50'},
                    {start: '13:00', end: '17:00'}
                ],
                6: [] // Sábado
            },
            'Agenda Especialidades Médicas': {
                0: [],
                1: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''} // Empty for 3rd period
                ],
                // Similar for 2-5, empty for 6
                2: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                3: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                4: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                5: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                6: []
            },
            'Agenda de Exames': {
                0: [],
                1: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                // Similar pattern
                2: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                3: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                4: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                5: [
                    {start: '07:00', end: '12:00'},
                    {start: '14:00', end: '17:00'},
                    {start: '', end: ''}
                ],
                6: []
            }
        };
        const intervals = {
            'Agenda Odontológica': 20,
            'Agenda Especialidades Médicas': 30,
            'Agenda de Exames': 20
        };
        let appointmentDatesSet = new Set();
        let editingId = null;
        let deleteId = null;
        let filteredAppointments = []; // Store filtered appointments for export
        let debounceTimer; // Para debounce em filtros
        let reportChart = null; // Reference to the chart instance
        let attendanceChart = null; // Reference to the attendance chart instance
        let productivityChart = null; // Reference to the productivity chart instance
        let currentPrintId = null; // For print after schedule or existing
        let isBlockedSectionOpen = false; // Flag to track if blocked section is open
        let currentAgendaType = ''; // Track current agenda type for calendar blocks
        let currentPatientCpf = ''; // Global para CPF do paciente atual no histórico
        let currentPatientName = ''; // Global para nome do paciente atual no histórico
        let currentPatientDate = ''; // Global para data do agendamento atual no histórico
        let logoBase64 = ''; // Para imagens em impressões
        let coloredLogoBase64 = ''; // Para imagem colorida em declarações
        let discountObj = {}; // Objeto global para armazenar descontos durante o agendamento
        let currentServicePrice = 0; // Preço atual do serviço para cálculos de desconto
        let currentDeclarationId = null; // Global para ID do agendamento na declaração
        let justScheduled = false; // Flag para indicar se um agendamento foi recém-criado
        // Objeto de preços para serviços (exemplo de valores - ajuste conforme necessário)
        const prices = {
            // Combos para Especialidades Médicas
            'Combo Otorrino': 184.00,
            'Combo Nutricional': 239.00,
            'Combo Gineco': 157.00,
            'Combo Coração': 339.00,
            // Especialidades Médicas
            'Cardiologista': 139.00,
            'Clínico Geral': 119.00,
            'Ginecologista': 119.00,
            'Otorrino': 119.00,
            'Oftalmologista': 119.00,
            'Psicologia': 107.00,
            'Nutricionista': 107.00,
            // Exames
            'Ultrassonografia Abdômen Superior': 122.00,
            'Ultrassonografia Abdômen Total': 202.00,
            'Ultrassonografia Axila': 134.00,
            'Ultrassonografia Bolsa Escrotal': 160.00,
            'Ultrassonografia Mamária': 138.00,
            'Ultrassonografia Obstétrica': 141.00,
            'Ultrassonografia Parede Abdominal': 127.00,
            'Ultrassonografia Partes Moles (Couro Cabeludo)': 127.00,
            'Ultrassonografia Partes Moles (Membros Superiores e Inferiores)': 127.00,
            'Ultrassonografia Partes Moles (Região Cervical)': 127.00,
            'Ultrassonografia Partes Moles (Região Dorsal)': 127.00,
            'Ultrassonografia Partes Moles (Região Inframandibular)': 127.00,
            'Ultrassonografia Partes Moles (Região Lombar)': 127.00,
            'Ultrassonografia Partes Moles (Tórax)': 127.00,
            'Ultrassonografia Pós-ita': 126.00,
            'Ultrassonografia Região Inguinal': 126.00,
            'Ultrassonografia Tireóide': 126.00,
            'Ultrassonografia Transretal': 126.00,
            'Ultrassonografia Transvaginal': 126.00
        };
        // Função para carregar imagem como base64 (melhorada com retry e fallback)
        function getImageBase64(src, retries = 3) {
            return new Promise((resolve, reject) => {
                const loadImage = (attempt) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const base64 = canvas.toDataURL('image/png');
                        console.log('Logo carregado como base64 com sucesso.');
                        resolve(base64);
                    };
                    img.onerror = () => {
                        console.error(`Erro ao carregar imagem (tentativa ${attempt}): ${src}`);
                        if (attempt < retries) {
                            console.log(`Tentando novamente em 500ms... (tentativa ${attempt + 1})`);
                            setTimeout(() => loadImage(attempt + 1), 500);
                        } else {
                            console.warn('Falha ao carregar logo após tentativas. Usando fallback vazio.');
                            resolve(''); // Resolve vazio após retries
                        }
                    };
                    img.src = src + '?t=' + new Date().getTime(); // Cache busting para forçar reload
                };
                loadImage(1);
            });
        }
        const holidays = [
            // 2025
            new Date(2025, 0, 1), // Confraternização Universal
            new Date(2025, 2, 3), // Carnaval (Segunda-feira)
            new Date(2025, 2, 4), // Carnaval (Terça-feira)
            new Date(2025, 3, 18), // Paixão de Cristo
            new Date(2025, 3, 21), // Tiradentes
            new Date(2025, 4, 1), // Dia do Trabalho
            new Date(2025, 5, 19), // Corpus Christi
            new Date(2025, 8, 7), // Independência do Brasil
            new Date(2025, 9, 12), // Nossa Sra. a Aparecida - Padroeira do Brasil
            new Date(2025, 10, 2), // Finados
            new Date(2025, 10, 15), // Proclamação da República
            new Date(2025, 11, 25), // Natal
            // 2026
            new Date(2026, 0, 1), // Confraternização Universal
            new Date(2026, 1, 16), // Carnaval (Segunda-feira)
            new Date(2026, 1, 17), // Carnaval (Terça-feira)
            new Date(2026, 3, 3), // Paixão de Cristo
            new Date(2026, 3, 21), // Tiradentes
            new Date(2026, 4, 1), // Dia do Trabalho
            new Date(2026, 5, 4), // Corpus Christi
            new Date(2026, 8, 7), // Independência do Brasil
            new Date(2026, 9, 12), // Nossa Sra. a Aparecida - Padroeira do Brasil
            new Date(2026, 10, 2), // Finados
            new Date(2026, 10, 15), // Proclamação da República
            new Date(2026, 11, 25), // Natal
            // 2027
            new Date(2027, 0, 1), // Confraternização Universal
            new Date(2027, 1, 8), // Carnaval (Segunda-feira)
            new Date(2027, 1, 9), // Carnaval (Terça-feira)
            new Date(2027, 2, 26), // Paixão de Cristo
            new Date(2027, 3, 21), // Tiradentes
            new Date(2027, 4, 1), // Dia do Trabalho
            new Date(2027, 4, 27), // Corpus Christi
            new Date(2027, 8, 7), // Independência do Brasil
            new Date(2027, 9, 12), // Nossa Sra. a Aparecida - Padroeira do Brasil
            new Date(2027, 10, 2), // Finados
            new Date(2027, 10, 15), // Proclamação da República
            new Date(2027, 11, 25) // Natal
        ];
        const holidayNames = {
            '2025-01-01': 'Confraternização Universal',
            '2025-03-03': 'Carnaval (Segunda-feira)',
            '2025-03-04': 'Carnaval (Terça-feira)',
            '2025-04-18': 'Paixão de Cristo',
            '2025-04-21': 'Tiradentes',
            '2025-05-01': 'Dia do Trabalho',
            '2025-06-19': 'Corpus Christi',
            '2025-09-07': 'Independência do Brasil',
            '2025-10-12': 'Nossa Sra. a Aparecida - Padroeira do Brasil',
            '2025-11-02': 'Finados',
            '2025-11-15': 'Proclamação da República',
            '2025-12-25': 'Natal',
            '2026-01-01': 'Confraternização Universal',
            '2026-02-16': 'Carnaval (Segunda-feira)',
            '2026-02-17': 'Carnaval (Terça-feira)',
            '2026-04-03': 'Paixão de Cristo',
            '2026-04-21': 'Tiradentes',
            '2026-05-01': 'Dia do Trabalho',
            '2026-06-04': 'Corpus Christi',
            '2026-09-07': 'Independência do Brasil',
            '2026-10-12': 'Nossa Sra. a Aparecida - Padroeira do Brasil',
            '2026-11-02': 'Finados',
            '2026-11-15': 'Proclamação da República',
            '2026-12-25': 'Natal',
            '2027-01-01': 'Confraternização Universal',
            '2027-02-08': 'Carnaval (Segunda-feira)',
            '2027-02-09': 'Carnaval (Terça-feira)',
            '2027-03-26': 'Paixão de Cristo',
            '2027-04-21': 'Tiradentes',
            '2027-05-01': 'Dia do Trabalho',
            '2027-05-27': 'Corpus Christi',
            '2027-09-07': 'Independência do Brasil',
            '2027-10-12': 'Nossa Sra. a Aparecida - Padroeira do Brasil',
            '2027-11-02': 'Finados',
            '2027-11-15': 'Proclamação da República',
            '2027-12-25': 'Natal'
        };
        function getHolidayName(date) {
            const key = date.toISOString().split('T')[0];
            return holidayNames[key] || 'Feriado Nacional';
        }
        const agendaTypes = [
            'Agenda Odontológica',
            'Agenda Especialidades Médicas',
            'Agenda de Exames'
        ];
        const dentists = [
            'Dra. Ana Paula',
            'Dr. Carlson',
            'Dra. Cinara',
            'Dr. Edson',
            'Dr. João Santos'
        ];
        const medicalSpecialists = [
            'Combo Otorrino',
            'Combo Nutricional',
            'Combo Gineco',
            'Combo Coração',
            'Cardiologista',
            'Clínico Geral',
            'Ginecologista',
            'Otorrino',
            'Oftalmologista',
            'Psicologia',
            'Nutricionista'
        ];
        const examSpecialists = [
            'Ultrassonografia Abdômen Superior',
            'Ultrassonografia Abdômen Total',
            'Ultrassonografia Axila',
            'Ultrassonografia Bolsa Escrotal',
            'Ultrassonografia Mamária',
            'Ultrassonografia Obstétrica',
            'Ultrassonografia Parede Abdominal',
            'Ultrassonografia Partes Moles (Couro Cabeludo)',
            'Ultrassonografia Partes Moles (Membros Superiores e Inferiores)',
            'Ultrassonografia Partes Moles (Região Cervical)',
            'Ultrassonografia Partes Moles (Região Dorsal)',
            'Ultrassonografia Partes Moles (Região Inframandibular)',
            'Ultrassonografia Partes Moles (Região Lombar)',
            'Ultrassonografia Partes Moles (Tórax)',
            'Ultrassonografia Pós-ita',
            'Ultrassonografia Região Inguinal',
            'Ultrassonografia Tireóide',
            'Ultrassonografia Transretal',
            'Ultrassonografia Transvaginal'
        ];
        const locations = [
            'SESI Saúde - Santo Amaro',
            'Posto Avançado - SESI Paulista'
        ];
        const locationAddresses = {
            'SESI Saúde - Santo Amaro': 'Rua Frei Cassimiro, 88 - Santo Amaro, Recife - PE, 50100-260',
            'Posto Avançado - SESI Paulista': 'Tv. São Pedro, 2800 - Artur Lundgren I, Paulista - PE, 53417-040'
        };
        const professionalDurations = {
            // Dental
            'Dra. Ana Paula': 20,
            'Dr. Carlson': 20,
            'Dra. Cinara': 50,
            'Dr. Edson': 50,
            'Dr. João Santos': 20,
            // Medical
            'Clínico Geral': 30,
            'Cardiologista': 20,
            'Oftalmologista': 25,
            'Otorrino': 20,
            'Ginecologista': 40,
            'Psicologia': 60,
            'Nutricionista': 50
        };
        // Helper functions for time
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }
        function formatPeriod(period) {
            if (!period.start || !period.end) return '';
            return `${period.start} ${period.end}`;
        }
        function parsePeriodInput(value) {
            const parts = value.trim().split(/\s+/);
            if (parts.length >= 2) {
                return { start: parts[0], end: parts[1] };
            }
            return { start: '', end: '' };
        }
        // Updated generateSlots for day-specific
        function generateSlotsForDay(agendaType, dayOfWeek, selectedDate) {
            const periods = agendaSchedules[agendaType]?.[dayOfWeek] || [];
            let slots = [];
            const interval = intervals[agendaType];
            periods.forEach(period => {
                if (period.start && period.end) {
                    let currentMin = parseTime(period.start);
                    const endMin = parseTime(period.end);
                    while (currentMin + interval <= endMin) {
                        slots.push(formatTime(currentMin));
                        currentMin += interval;
                    }
                }
            });
            return [...new Set(slots)].sort();
        }
        function getHoursForAgendaType(agendaType, dayOfWeek) {
            return generateSlotsForDay(agendaType, dayOfWeek, null);
        }
        function getStatusText(status) {
            switch (status) {
                case 'attended': return 'Compareceu';
                case 'no-show': return 'Não Compareceu';
                case 'rescheduled': return 'Reagendado';
                default: return 'Pendente';
            }
        }
        function getStatusClass(status) {
            switch (status) {
                case 'attended': return 'attended';
                case 'no-show': return 'no-show';
                case 'rescheduled': return 'rescheduled';
                default: return 'pending';
            }
        }
        function updateAppointmentDatesSet() {
            appointmentDatesSet.clear();
            appointments.forEach(apt => {
                const [day, mon, yr] = apt.date.split('/');
                appointmentDatesSet.add(new Date(yr, mon - 1, day).toDateString());
            });
        }
        function isHoliday(date) {
            return holidays.some(holiday => holiday.toDateString() === date.toDateString());
        }
        function isBlocked(dateStr, agendaType = null) {
            if (!agendaType) {
                return blockedDates.some(b => b.date === dateStr);
            }
            return blockedDates.some(b => b.date === dateStr && b.agendaType === agendaType);
        }
        function isProfessionalBlocked(professional, agendaType) {
            const today = new Date().toISOString().split('T')[0];
            return blockedProfessionals.some(bp => {
                if (bp.professional === professional && bp.agendaType === agendaType) {
                    if (!bp.startDate || !bp.endDate) return true;
                    return today >= bp.startDate && today <= bp.endDate;
                }
                return false;
            });
        }
        // Função para sanitizar inputs (básica contra XSS)
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }
        function formatCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})/, "$1-$2");
            input.value = value;
        }
        function formatFilterCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})/, "$1-$2");
            input.value = value;
        }
        function validateCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('cpfError');
            const isValid = cpf.length === 11 && isValidCPF(cpf);
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
            updateScheduleButton();
        }
        function isValidCPF(cpf) {
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf[i]) * (10 - i);
            }
            let remainder = 11 - (sum % 11);
            let digit1 = remainder >= 10 ? 0 : remainder;
            if (parseInt(cpf[9]) !== digit1) return false;
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf[i]) * (11 - i);
            }
            remainder = 11 - (sum % 11);
            let digit2 = remainder >= 10 ? 0 : remainder;
            return parseInt(cpf[10]) === digit2;
        }
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, "");
            if (value.length >= 11) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
            } else if (value.length >= 7) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            } else if (value.length >= 2) {
                value = value.replace(/^(\d{2})/, "($1) ");
            }
            input.value = value;
        }
        function validatePhone(input) {
            const phone = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('phoneError');
            const isValid = phone.length >= 10 && phone.length <= 11;
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
            updateScheduleButton();
        }
        function validateEditCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('editCpfError');
            const isValid = cpf.length === 11 && isValidCPF(cpf);
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
        }
        function validateEditPhone(input) {
            const phone = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('editPhoneError');
            const isValid = phone.length >= 10 && phone.length <= 11;
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
        }
        function getProfessionals(agendaType) {
            if (agendaType === 'Agenda Odontológica') {
                return dentists.filter(prof => !isProfessionalBlocked(prof, agendaType));
            } else if (agendaType === 'Agenda Especialidades Médicas') {
                return medicalSpecialists.filter(prof => !isProfessionalBlocked(prof, agendaType));
            } else if (agendaType === 'Agenda de Exames') {
                return examSpecialists.filter(prof => !isProfessionalBlocked(prof, agendaType));
            }
            return [];
        }
        function populateProfessionals(agendaType, selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecione um profissional</option>';
            const professionals = getProfessionals(agendaType);
            professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                select.appendChild(option);
            });
        }
        function populateBlockProfessionalSelect() {
            const agendaType = document.getElementById('blockProfessionalAgendaType').value;
            const select = document.getElementById('blockProfessionalSelect');
            select.innerHTML = '<option value="">Selecione o profissional</option>';
            const professionals = getProfessionals(agendaType);
            professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                select.appendChild(option);
            });
        }
        function populateEditProfessionals() {
            const agendaType = document.getElementById('editAgendaTypeSelect').value;
            populateProfessionals(agendaType, 'editDentistSelect');
        }
        function populateEditTimes() {
            const agendaTypeSelect = document.getElementById('editAgendaTypeSelect');
            const dentistSelect = document.getElementById('editDentistSelect');
            const agendaType = agendaTypeSelect.value;
            const professional = dentistSelect.value;
            const timeSelect = document.getElementById('editTime');
            timeSelect.innerHTML = '';
            let hours;
            if (agendaType && professional) {
                // Use day 1 (Monday) for example
                hours = getHoursForAgendaType(agendaType, 1);
            } else if (agendaType) {
                hours = getHoursForAgendaType(agendaType, 1);
            } else {
                hours = getHoursForAgendaType('Agenda Especialidades Médicas', 1);
            }
            hours.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                timeSelect.appendChild(opt);
            });
        }
        async function generatePDF(appointmentId, format) {
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            const isThermal = format === 'thermal';
            const generatedDate = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            const schedulerName = apt.scheduler ? sanitizeInput(apt.scheduler) : 'Não informado';
            const cnpj = apt.location && apt.location.includes('Paulista') ? '03.910.210/0025-82' : '03.910.210/0002-52';
            let originalPrice = prices[apt.professional] || 0;
            let industryAmount = 0;
            let promotionalAmount = 0;
            let discountedPrice = originalPrice;
            let industryDiscountLine = '';
            let promotionalDiscountLine = '';
            let promotionalPeriodLine = '';
            if (apt.discount) {
                if (apt.discount.industry) {
                    const industryDiscount = apt.discount.industry;
                    industryAmount = originalPrice * (industryDiscount / 100);
                    discountedPrice = originalPrice * (1 - industryDiscount / 100);
                    industryDiscountLine = `Desconto Indústria: ${industryDiscount}%`;
                }
                if (apt.discount.promotional) {
                    const promotionalDiscount = apt.discount.promotional;
                    promotionalAmount = discountedPrice * (promotionalDiscount / 100);
                    discountedPrice = discountedPrice * (1 - promotionalDiscount / 100);
                    promotionalDiscountLine = `Desconto Promocional: ${promotionalDiscount}%`;
                }
                if (apt.discount.promotion && (apt.agendaType === 'Agenda de Exames' || apt.agendaType === 'Agenda Especialidades Médicas')) {
                    const { name, start, end } = apt.discount.promotion;
                    if (name && start && end) {
                        promotionalPeriodLine = `${name}: de ${new Date(start).toLocaleDateString('pt-BR')} a ${new Date(end).toLocaleDateString('pt-BR')}`;
                    }
                }
            }
            if (isThermal) {
                let title = apt.agendaType === 'Agenda de Exames' ? 'ORÇAMENTO DE EXAMES' : 'COMPROVANTE DE AGENDAMENTO';
                let printContent = `
                    <html>
                    <head>
                      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                      <title>${title}</title>
                      <style>
                        @page {
                          margin: 0;
                        }
                        body {
                          font-family: monospace;
                          font-size: 10pt;
                          margin: 0;
                          padding: 0 5mm 5mm 0;
                          width: 80mm;
                          line-height: 1.2;
                          color: #000;
                          background: #fff;
                          text-align: left;
                        }
                        .line { margin-bottom: 0.3em; }
                        .divider {
                          border-top: 1px dashed #000;
                          margin: 0.5em 0;
                        }
                        .center { text-align: center; }
                        .bold { font-weight: bold; }
                        .warning {
                          margin: 0.5em 0;
                          font-size: 9pt;
                          text-align: center;
                        }
                        .warning-title {
                          font-weight: bold;
                          text-align: center;
                        }
                        .thermal-logo {
                          display: block;
                          margin: 0 auto 0.5em auto;
                          max-width: 60mm;
                          max-height: 15mm;
                          width: auto;
                          height: auto;
                          filter: grayscale(100%) contrast(200%) brightness(0%);
                          image-rendering: -webkit-optimize-contrast;
                          image-rendering: crisp-edges;
                        }
                        .discount-line {
                          font-weight: bold;
                          color: #000;
                        }
                      </style>
                    </head>
                    <body>
                      ${logoBase64 ? `<img src="${logoBase64}" alt="Logo SESI" class="thermal-logo">` : ''}
                      <div class="center bold line">SERVIÇO SOCIAL DA INDÚSTRIA</div>
                      <div class="center line">CNPJ: ${cnpj}</div>
                      <div class="center bold line">${title}</div>
                `;
                if (apt.agendaType === 'Agenda de Exames') {
                    printContent += `
                      <div class="line">Responsável pelo Orçamento: ${schedulerName || ''}</div>
                      <div class="line">Paciente: ${apt.patient}</div>
                      <div class="line">Telefone do Paciente: ${apt.phone || ''}</div>
                      <div class="line">Tipo de Atendimento: ${apt.professional || ''}</div>
                      <div class="discount-line line">Valor Original: R$ ${originalPrice.toFixed(2)}</div>
                      ${industryDiscountLine ? `<div class="discount-line line">${industryDiscountLine}</div>` : ''}
                      ${promotionalDiscountLine ? `<div class="discount-line line">${promotionalDiscountLine}</div>` : ''}
                      ${promotionalPeriodLine ? `<div class="discount-line line">${promotionalPeriodLine}</div>` : ''}
                      <div class="discount-line line">Valor Final: R$ ${discountedPrice.toFixed(2)}</div>
                      ${apt.observations ? `<div class="line">Obs.: ${apt.observations}</div>` : ''}
                      <div class="divider"></div>
                      <div class="center line">Endereço: ${locationAddresses[apt.location] || 'Endereço não especificado'}</div>
                    `;
                } else if (apt.agendaType === 'Agenda Odontológica') {
                    printContent += `
                      <div class="line">Data: ${apt.date || ''}</div>
                      <div class="line">Horário: ${apt.time || ''}</div>
                      <div class="line">Paciente: ${apt.patient || ''}</div>
                      <div class="line">CPF: ${apt.cpf || ''}</div>
                      <div class="line">Telefone: ${apt.phone || ''}</div>
                      ${schedulerName ? `<div class="line">Responsável pelo Agendamento: ${schedulerName}</div>` : ''}
                      <div class="line">Profissional: ${apt.professional || ''}</div>
                      <div class="line">Tipo: ${apt.agendaType || ''}</div>
                      <div class="line">Local: ${apt.location || ''}</div>
                      <div class="divider"></div>
                      ${apt.priority ? `<div class="line">Prioritário: ${apt.priority}</div>` : ''}
                      ${apt.firstAppointment ? `<div class="line">1º Atendimento: ${apt.firstAppointment}</div>` : ''}
                      ${apt.observations ? `<div class="line">Obs.: ${apt.observations}</div>` : ''}
                      <div class="center line">Endereço: ${locationAddresses[apt.location] || 'Endereço não especificado'}</div>
                    `;
                } else {
                    printContent += `
                      <div class="line">Data: ${apt.date || ''}</div>
                      <div class="line">Horário: ${apt.time || ''}</div>
                      <div class="line">Paciente: ${apt.patient || ''}</div>
                      <div class="line">CPF: ${apt.cpf || ''}</div>
                      <div class="line">Telefone: ${apt.phone || ''}</div>
                      ${schedulerName ? `<div class="line">Responsável pelo Agendamento: ${schedulerName}</div>` : ''}
                      <div class="line">Profissional: ${apt.professional || ''}</div>
                      <div class="line">Tipo: ${apt.agendaType || ''}</div>
                      <div class="line">Local: ${apt.location || ''}</div>
                      <div class="discount-line line">Valor Original: R$ ${originalPrice.toFixed(2)}</div>
                      ${industryDiscountLine ? `<div class="discount-line line">${industryDiscountLine}</div>` : ''}
                      ${promotionalDiscountLine ? `<div class="discount-line line">${promotionalDiscountLine}</div>` : ''}
                      ${promotionalPeriodLine ? `<div class="discount-line line">${promotionalPeriodLine}</div>` : ''}
                      <div class="discount-line line">Valor Final: R$ ${discountedPrice.toFixed(2)}</div>
                      <div class="divider"></div>
                      ${apt.priority ? `<div class="line">Prioritário: ${apt.priority}</div>` : ''}
                      ${apt.firstAppointment ? `<div class="line">1º Atendimento: ${apt.firstAppointment}</div>` : ''}
                      ${apt.observations ? `<div class="line">Obs.: ${apt.observations}</div>` : ''}
                      <div class="center line">Endereço: ${locationAddresses[apt.location] || 'Endereço não especificado'}</div>
                    `;
                }
                printContent += `
                      <div class="line">Gerado em: ${generatedDate}</div>
                      <div class="divider"></div>
                      <div class="warning">
                        <div class="warning-title bold">AVISO IMPORTANTE !</div>
                        <div class="line">Ao solicitar o agendamento de consultas e exames, o cliente autoriza o uso de seus dados pessoais (nome, telefone, CPF) exclusivamente para essa finalidade. O agendamento possui validade a partir da data de sua solicitação até o término do ano corrente (2025). Durante esse período, os valores poderão ser atualizados, inclusive em razão de campanhas promocionais ou ajustes de tabela.
Caso o atendimento seja confirmado em data posterior ao prazo de validade ou em período com novas condições comerciais, o cliente será previamente informado sobre eventuais alterações nos preços antes da efetivação do agendamento.</div>
                      </div>
                      <div class="center line">Apresente este comprovante no dia do atendimento.</div>
                    </body>
                    </html>
                `;
                const printWindow = window.open('', '_blank', 'width=300,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            } else {
                let title = apt.agendaType === 'Agenda de Exames' ? 'Orçamento de Exames e Especialidades' : 'Comprovante de Agendamento';
                const address = locationAddresses[apt.location] || 'Endereço não especificado';
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                let printContent = `
                    <html>
                    <head>
                      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                      <title>${title}</title>
                      <style>
                        @page {
                          size: A4;
                          margin: 1.5cm 1cm;
                          @bottom-center {
                            content: "Página " counter(page) " de " counter(pages);
                            font-size: 10pt;
                            color: #666;
                          }
                        }
                        body {
                          font-family: 'Roboto', Arial, sans-serif;
                          font-size: 11pt;
                          margin: 0;
                          padding: 0;
                          line-height: 1.5;
                          color: #000;
                          background: white;
                          text-align: left;
                          width: 100%;
                        }
                        .print-container {
                          max-width: 210mm;
                          margin: 0 auto;
                          padding: 20px;
                          border: 2px solid #007bff;
                          border-radius: 8px;
                          background: #ffffff;
                          box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .print-header {
                          background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                          color: white;
                          padding: 20px;
                          border-radius: 8px 8px 0 0;
                          margin: -20px -20px 20px -20px;
                          text-align: center;
                          position: relative;
                          overflow: hidden;
                        }
                        .print-header::after {
                          content: '';
                          position: absolute;
                          bottom: 0;
                          left: 0;
                          right: 0;
                          height: 4px;
                          background: rgba(255,255,255,0.2);
                        }
                        .header-container {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          margin-bottom: 15px;
                          flex-wrap: wrap;
                        }
                        .logo-container {
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          flex: 0 0 auto;
                        }
                        .logo-container img {
                          max-width: 120px;
                          height: auto;
                          margin-bottom: 5px;
                        }
                        .logo-container p {
                          margin: 0;
                          font-size: 9pt;
                          color: rgba(255,255,255,0.9);
                          text-align: center;
                          font-weight: 300;
                        }
                        .title-container {
                          flex: 1;
                          text-align: center;
                          margin: 0 15px;
                          min-width: 200px;
                        }
                        .cnpj-container {
                          text-align: right;
                          flex: 0 0 auto;
                        }
                        h1 {
                          font-size: 20pt;
                          color: white;
                          margin: 0 0 5px 0;
                          font-weight: 600;
                          letter-spacing: 0.5px;
                        }
                        .header-info {
                          font-size: 9pt;
                          color: rgba(255,255,255,0.9);
                          margin: 0;
                          font-weight: 300;
                        }
                        .section {
                          border-bottom: 1px solid #e0e0e0;
                          padding-bottom: 15px;
                          margin-bottom: 20px;
                        }
                        .section:last-child {
                          border-bottom: none;
                          margin-bottom: 0;
                        }
                        .section-title {
                          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                          color: #007bff;
                          padding: 8px 12px;
                          border-radius: 6px;
                          font-size: 12pt;
                          font-weight: 500;
                          margin-bottom: 15px;
                          border-left: 4px solid #007bff;
                          box-shadow: 0 2px 4px rgba(0,123,255,0.1);
                        }
                        p {
                          margin: 8px 0;
                          font-size: 11pt;
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          word-wrap: break-word;
                        }
                        p i {
                          width: 18px;
                          text-align: center;
                          color: #007bff;
                          font-size: 12pt;
                        }
                        .print-table {
                          width: 100%;
                          border-collapse: collapse;
                          margin: 20px 0;
                          border: 1px solid #007bff;
                          border-radius: 6px;
                          overflow: hidden;
                          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
                        }
                        .print-table th, .print-table td {
                          border: 1px solid #007bff;
                          padding: 10px 8px;
                          text-align: left;
                          font-size: 10pt;
                        }
                        .print-table th {
                          background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                          color: white;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.5px;
                        }
                        .print-table td {
                          background: #f8f9fa;
                        }
                        .print-table tr:nth-child(even) td {
                          background: #e9ecef;
                        }
                        .print-table tr:hover td {
                          background: #e3f2fd;
                        }
                        .print-summary {
                          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                          padding: 20px;
                          border-radius: 8px;
                          margin: 20px 0;
                          border-left: 4px solid #007bff;
                          box-shadow: 0 2px 8px rgba(0,123,255,0.1);
                        }
                        .print-summary p {
                          justify-content: space-between;
                          font-size: 11pt;
                          margin: 10px 0;
                          font-weight: 500;
                          border-bottom: 1px dashed #007bff;
                          padding-bottom: 5px;
                        }
                        .print-summary p:last-child {
                          border-bottom: none;
                        }
                        .print-summary .final-price {
                          font-size: 13pt;
                          color: #007bff;
                          border-top: 2px solid #007bff;
                          padding-top: 10px;
                          margin-top: 10px;
                          font-weight: 700;
                          text-align: center;
                        }
                        .print-summary .discount-info {
                          color: #dc3545;
                          font-weight: bold;
                          text-align: center;
                          margin-top: 5px;
                        }
                        .print-warning {
                          background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                          border: 2px solid #ffc107;
                          border-radius: 8px;
                          padding: 20px;
                          margin: 25px 0;
                          color: #856404;
                          font-size: 10pt;
                          line-height: 1.4;
                          box-shadow: 0 2px 6px rgba(255,193,7,0.2);
                        }
                        .print-warning .warning-title {
                          font-weight: 700;
                          color: #d39e00;
                          margin-bottom: 12px;
                          text-align: center;
                          font-size: 12pt;
                          text-transform: uppercase;
                          letter-spacing: 1px;
                        }
                        .print-footer {
                          text-align: center;
                          color: #6c757d;
                          font-size: 9pt;
                          margin-top: 25px;
                          border-top: 1px solid #dee2e6;
                          padding-top: 15px;
                          font-style: italic;
                        }
                        .print-footer p {
                          margin: 8px 0;
                          justify-content: center;
                          display: flex;
                          align-items: center;
                          gap: 5px;
                        }
                        .maps-link {
                          color: #007bff;
                          text-decoration: underline;
                          font-size: 10pt;
                          transition: color 0.3s ease;
                        }
                        .maps-link:hover {
                          color: #0056b3;
                        }
                        .discount-line {
                          font-weight: bold;
                          color: #dc3545;
                        }
                        @media print {
                          body {
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                            font-size: 11pt;
                          }
                          .print-table {
                            border-collapse: collapse;
                            box-shadow: none;
                          }
                          .print-container {
                            box-shadow: none;
                            border: 1px solid #000;
                          }
                          .print-header {
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                          }
                          .print-warning {
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                          }
                        }
                        @media (max-width: 640px) {
                          .print-table {
                            font-size: 9pt;
                            width: 100%;
                          }
                          .print-table td:before {
                            content: attr(data-label) ": ";
                            font-weight: bold;
                            display: block;
                          }
                          .print-table td {
                            border: none;
                            border-bottom: 1px solid #007bff;
                            padding: 5px;
                          }
                          .header-container {
                            flex-direction: column;
                            gap: 10px;
                          }
                          .title-container {
                            order: -1;
                            margin: 0;
                          }
                        }
                      </style>
                    </head>
                    <body onload="setTimeout(() => window.print(), 1000)">
                      <div class="print-container">
                        <div class="print-header">
                          <div class="header-container">
                            <div class="logo-container">
                              ${logoBase64 ? `<img src="${logoBase64}" alt="Logo SESI">` : ''}
                            </div>
                            <div class="title-container">
                              <h1>${title}</h1>
                            </div>
                            <div class="cnpj-container">
                              <p class="header-info">CNPJ: ${cnpj}</p>
                            </div>
                          </div>
                        </div>
                        <div class="section">
                          <div class="section-title">Informações Gerais</div>
                          <p><i class="fas fa-calendar-alt"></i><span>Gerado em:</span> <span>${generatedDate}</span></p>
                          <p><i class="fas fa-user"></i><span>Responsável pelo Orçamento:</span> <span>${schedulerName}</span></p>
                          <p><i class="fas fa-user-md"></i><span>Cliente:</span> <span>${apt.patient || 'Não informado'}</span></p>
                          <p><i class="fas fa-phone"></i><span>Telefone do Cliente:</span> <span>${apt.phone || 'Não informado'}</span></p>
                `;
                if (apt.agendaType === 'Agenda de Exames') {
                    printContent += `
                          <div class="section">
                            <div class="section-title">Exames Selecionados</div>
                            <table class="print-table">
                              <thead>
                                <tr>
                                  <th>Exame</th>
                                  <th>Valor Original (R$)</th>
                                  <th>Desconto Indústria (%)</th>
                                  <th>Desconto Promocional (%)</th>
                                  <th>Valor Final (R$)</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td data-label="Exame">${apt.professional || 'Não informado'}</td>
                                  <td data-label="Valor Original (R$)">${originalPrice.toFixed(2)}</td>
                                  <td data-label="Desconto Indústria (%)">${apt.discount && apt.discount.industry ? apt.discount.industry : '0'}</td>
                                  <td data-label="Desconto Promocional (%)">${apt.discount && apt.discount.promotional ? apt.discount.promotional : '0'}</td>
                                  <td data-label="Valor Final (R$)">${discountedPrice.toFixed(2)}</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                          <div class="print-summary">
                            <p><i class="fas fa-calculator"></i><span>Valor Total Original:</span> <span>R$ ${originalPrice.toFixed(2)}</span></p>
                            ${industryDiscountLine ? `<p class="discount-line"><i class="fas fa-industry"></i><span>${industryDiscountLine}:</span> <span>R$ ${industryAmount.toFixed(2)}</span></p>` : ''}
                            ${promotionalDiscountLine ? `<p class="discount-line"><i class="fas fa-tag"></i><span>${promotionalDiscountLine}:</span> <span>R$ ${promotionalAmount.toFixed(2)}</span></p>` : ''}
                            ${promotionalPeriodLine ? `<p class="discount-line"><i class="fas fa-calendar-alt"></i><span>${promotionalPeriodLine}:</span></p>` : ''}
                            <p class="final-price"><i class="fas fa-receipt"></i><span>Total do Pagamento:</span> <span>R$ ${discountedPrice.toFixed(2)}</span></p>
                          </div>
                          ${apt.observations ? `
                          <div class="section">
                            <div class="section-title">Observações</div>
                            <p><i class="fas fa-sticky-note"></i><span>${sanitizeInput(apt.observations)}</span></p>
                          </div>
                          ` : ''}
                    `;
                } else if (apt.agendaType === 'Agenda Odontológica') {
                    printContent += `
                          <div class="section">
                            <div class="section-title">Detalhes do Agendamento</div>
                            <p><i class="fas fa-calendar-day"></i><span>Data:</span> <span>${apt.date || ''}</span></p>
                            <p><i class="fas fa-clock"></i><span>Horário:</span> <span>${apt.time || ''}</span></p>
                            <p><i class="fas fa-user-md"></i><span>Profissional:</span> <span>${apt.professional || ''}</span></p>
                            <p><i class="fas fa-stethoscope"></i><span>Tipo:</span> <span>${apt.agendaType || ''}</span></p>
                            <p><i class="fas fa-map-marker-alt"></i><span>Local:</span> <span>${apt.location || ''}</span></p>
                            ${apt.priority ? `<p><i class="fas fa-exclamation-triangle"></i><span>Prioritário:</span> <span>${apt.priority}</span></p>` : ''}
                            ${apt.firstAppointment ? `<p><i class="fas fa-star"></i><span>1º Atendimento.:</span> <span>${apt.firstAppointment}</span></p>` : ''}
                            ${apt.observations ? `<p><i class="fas fa-sticky-note"></i><span>Obs.:</span> <span>${sanitizeInput(apt.observations)}</span></p>` : ''}
                          </div>
                    `;
                } else {
                    printContent += `
                          <div class="section">
                            <div class="section-title">Detalhes do Agendamento</div>
                            <p><i class="fas fa-calendar-day"></i><span>Data:</span> <span>${apt.date || ''}</span></p>
                            <p><i class="fas fa-clock"></i><span>Horário:</span> <span>${apt.time || ''}</span></p>
                            <p><i class="fas fa-user-md"></i><span>Profissional:</span> <span>${apt.professional || ''}</span></p>
                            <p><i class="fas fa-stethoscope"></i><span>Tipo:</span> <span>${apt.agendaType || ''}</span></p>
                            <p><i class="fas fa-map-marker-alt"></i><span>Local:</span> <span>${apt.location || ''}</span></p>
                            ${apt.priority ? `<p><i class="fas fa-exclamation-triangle"></i><span>Prioritário:</span> <span>${apt.priority}</span></p>` : ''}
                            ${apt.firstAppointment ? `<p><i class="fas fa-star"></i><span>1º Atendimento.:</span> <span>${apt.firstAppointment}</span></p>` : ''}
                            <p><i class="fas fa-tag"></i><span>Valor Original:</span> <span>R$ ${originalPrice.toFixed(2)}</span></p>
                            ${industryDiscountLine ? `<p class="discount-line"><i class="fas fa-industry"></i><span>${industryDiscountLine}:</span> <span>R$ ${industryAmount.toFixed(2)}</span></p>` : ''}
                            ${promotionalDiscountLine ? `<p class="discount-line"><i class="fas fa-tag"></i><span>${promotionalDiscountLine}:</span> <span>R$ ${promotionalAmount.toFixed(2)}</span></p>` : ''}
                            ${promotionalPeriodLine ? `<p class="discount-line"><i class="fas fa-calendar-alt"></i><span>${promotionalPeriodLine}:</span></p>` : ''}
                            <p><i class="fas fa-receipt"></i><span>Valor Final:</span> <span>R$ ${discountedPrice.toFixed(2)}</span></p>
                            ${apt.observations ? `<p><i class="fas fa-sticky-note"></i><span>Obs.:</span> <span>${sanitizeInput(apt.observations)}</span></p>` : ''}
                          </div>
                    `;
                }
                printContent += `
                        </div>
                        <div class="print-warning">
                          <div class="warning-title">! AVISO IMPORTANTE !</div>
                          <div>Ao solicitar o agendamento de exames laboratoriais e especialidades médicas, o cliente declara expressamente que autoriza o tratamento dos seus dados pessoais de nome, telefone e CPF, para essa finalidade específica. Neste orçamento, possui validade a partir da data de sua solicitação até o término do ano corrente (2025). Durante esse período, os valores poderão ser atualizados, inclusive em razão de campanhas promocionais ou ajustes de tabela. Caso o atendimento seja confirmado em data posterior ao prazo de validade ou em período com novas condições comerciais, o cliente será previamente informado sobre eventuais alterações nos preços antes da confirmação do atendimento.</div>
                        </div>
                        <div class="print-footer">
                          <p><i class="fas fa-map-marker-alt"></i><span>Endereço:</span> <span><a href="${mapsUrl}" class="maps-link" target="_blank">${address}</a></span></p>
                          <p><i class="fas fa-calendar-alt"></i><span>Data:</span> <span>${generatedDate}</span></p>
                        </div>
                      </div>
                    </body>
                    </html>
                `;
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 1000);
            }
            showToast(`Comprovante ${isThermal ? 'térmica' : 'normal'} gerado com sucesso!`, 'success');
        }
        function showPrintTypeModal() {
            closeModal('printConfirmModal');
            document.getElementById('printTypeModal').style.display = 'block';
            document.querySelector('input[name="printType"]').focus();
        }
        function generatePrintPDF() {
            const printType = document.querySelector('input[name="printType"]:checked').value;
            generatePDF(currentPrintId, printType);
            closeModal('printTypeModal');
            if (justScheduled) {
                setTimeout(() => {
                    justScheduled = false;
                    window.location.reload();
                }, 2000);
            }
        }
        function preparePrint(id) {
            currentPrintId = id;
            document.getElementById('printConfirmModal').style.display = 'block';
        }
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            toggleBtn.setAttribute('aria-checked', newTheme === 'dark' ? 'true' : 'false');
        }
        function confirmOpenFicha(cpf, patient = '', phone = '', observations = '') {
            if (confirm('Deseja abrir o arquivo da ficha clínica?')) {
                const sanitizedPatient = encodeURIComponent(sanitizeInput(patient));
                const sanitizedPhone = encodeURIComponent(sanitizeInput(phone));
                const sanitizedObs = encodeURIComponent(sanitizeInput(observations));
                const fichaUrl = `https://pesenaibr-my.sharepoint.com/:w:/g/personal/socrates_silva_sistemafiepe_org_br/EezX1v19-BBDl9cKn3fKqgcB_lCc-cVTcpZi26gErPTlDw?e=5DVI2m&cpf=${encodeURIComponent(cpf || '')}&name=${sanitizedPatient}&phone=${sanitizedPhone}&obs=${sanitizedObs}`;
                window.open(fichaUrl, '_blank');
            }
        }
        function showPatientHistory(cpf, patientName) {
            currentPatientCpf = cpf;
            const patientAppointments = appointments.filter(apt => apt.cpf === cpf);
            if (patientAppointments.length === 0) {
                showToast('Nenhum histórico encontrado para este paciente.', 'error');
                return;
            }
            patientAppointments.sort((a, b) => {
                const dateA = new Date(a.date.split('/').reverse().join('-'));
                const dateB = new Date(b.date.split('/').reverse().join('-'));
                return dateB - dateA;
            });
            currentPatientName = patientName || patientAppointments[0].patient;
            currentPatientDate = patientAppointments[0].date;
            const modal = document.getElementById('patientHistoryModal');
            const title = document.getElementById('historyTitle');
            const info = document.getElementById('historyPatientInfo');
            const list = document.getElementById('historyList');
            title.textContent = `Histórico de Atendimentos - ${currentPatientName}`;
            info.innerHTML = `<strong>Nome Completo:</strong> ${currentPatientName}<br><strong>CPF:</strong> ${cpf} | <strong>Total de Atendimentos:</strong> ${patientAppointments.length}`;
            list.innerHTML = '';
            patientAppointments.forEach(apt => {
                const item = document.createElement('div');
                item.className = 'history-item';
                const statusClass = getStatusClass(apt.status);
                item.innerHTML = `
                    <p><strong>Data:</strong> ${apt.date} | <strong>Horário:</strong> ${apt.time}</p>
                    <p><strong>Tipo:</strong> ${apt.agendaType} | <strong>Profissional:</strong> ${sanitizeInput(apt.professional)}</p>
                    <p><strong>Status:</strong> <span class="status ${statusClass}">${getStatusText(apt.status)}</span></p>
                    ${apt.observations ? `<p><strong>Observações:</strong> ${sanitizeInput(apt.observations)}</p>` : ''}
                `;
                list.appendChild(item);
            });
            modal.style.display = 'block';
            focusTrap(modal);
        }
        function generateAttendanceDeclarationForAppointment(id) {
            currentDeclarationId = id;
            const apt = appointments.find(a => a.id === id);
            if (!apt) {
                showToast('Agendamento não encontrado.', 'error');
                return;
            }
            document.getElementById('declarationPatientInfo').innerHTML = `<strong>Paciente:</strong> ${sanitizeInput(apt.patient)}<br><strong>CPF:</strong> ${apt.cpf || 'Não informado'}<br><strong>Data do Atendimento:</strong> ${apt.date}`;
            document.getElementById('entryTime').value = '';
            document.getElementById('declarationTimeModal').style.display = 'block';
            document.getElementById('entryTime').focus();
            focusTrap(document.getElementById('declarationTimeModal'));
        }
        function openDeclarationTimeModal() {
            document.getElementById('declarationTimeModal').style.display = 'block';
            document.getElementById('entryTime').focus();
            focusTrap(document.getElementById('declarationTimeModal'));
        }
        function confirmDeclarationTime() {
            const entryTime = document.getElementById('entryTime').value;
            if (!entryTime) {
                showToast('Informe o horário de entrada do trabalhador.', 'error');
                return;
            }
            const apt = appointments.find(a => a.id === currentDeclarationId);
            if (!apt) {
                showToast('Agendamento não encontrado.', 'error');
                return;
            }
            generateAttendanceDeclaration(apt.cpf, apt.patient, entryTime);
            closeModal('declarationTimeModal');
            currentDeclarationId = null;
        }
        async function generateAttendanceDeclaration(cpf, patientName, entryTime) {
            const declDate = new Date().toLocaleDateString('pt-BR');
            const declTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const entryTimeFormatted = new Date(`2000-01-01T${entryTime}`).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const printContent = `
                <html>
                <head>
                  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                  <title>Declaração de Comparecimento</title>
                  <style>
                    @page {
                      size: A4;
                      margin: 2cm;
                    }
                    body {
                      font-family: 'Roboto', serif;
                      font-size: 12pt;
                      margin: 0;
                      padding: 0;
                      line-height: 1.6;
                      color: #000;
                      background: white;
                      text-align: center;
                      width: 100%;
                    }
                    .print-container {
                      max-width: 600px;
                      margin: 0 auto;
                      padding: 20px;
                      border: 2px solid #007bff;
                      border-radius: 8px;
                      background: #ffffff;
                    }
                    .print-header {
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      text-align: center;
                      margin-bottom: 30px;
                      border-bottom: 2px solid #007bff;
                      padding-bottom: 15px;
                      gap: 20px;
                    }
                    .header-logo {
                      max-width: 125px;
                      height: auto;
                      margin: 0;
                      flex-shrink: 0;
                    }
                    .header-text {
                      flex: 1;
                      text-align: center;
                    }
                    h1 {
                      color: #007bff;
                      font-size: 18pt;
                      margin: 0 0 10px 0;
                      font-weight: bold;
                    }
                    .declaration-body {
                      text-align: center;
                      margin-bottom: 20px;
                    }
                    .declaration-body p {
                      margin-bottom: 15px;
                      text-indent: 0;
                    }
                    .signature-section {
                      display: flex;
                      justify-content: flex-start;
                      margin-top: 40px;
                    }
                    .signature-box {
                      border-bottom: 1px solid #000;
                      width: 100%;
                      padding-top: 50px;
                      text-align: left;
                      font-size: 10pt;
                      color: #666;
                    }
                    .footer {
                      text-align: center;
                      margin-top: 30px;
                      font-size: 10pt;
                      color: #666;
                    }
                    @media print {
                      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                  </style>
                </head>
                <body onload="setTimeout(() => window.print(), 1000)">
                  <div class="print-container">
                    <div class="print-header">
                      <div style="display: flex; align-items: center; justify-content: center; width: 100%; gap: 20px;">
                        ${coloredLogoBase64 ? `<img src="${coloredLogoBase64}" alt="Logo SESI Saúde" class="header-logo">` : ''}
                        <div class="header-text">
                          <h1>Declaração de Comparecimento</h1>
                          <p>SERVIÇO SOCIAL DA INDÚSTRIA - SESI SAÚDE</p>
                          <p>CNPJ: 03.910.210/0002-52</p>
                        </div>
                      </div>
                    </div>
                    <div class="declaration-body">
                      <p>Eu, <strong>${sanitizeInput(patientName)}</strong>, portador(a) do CPF <strong>${cpf}</strong>, declaro para os devidos fins que compareci ao atendimento no SESI Saúde no horário de entrada <strong>${entryTimeFormatted}</strong>, tendo o atendimento realizado na data de <strong>${declDate}</strong>.</p>
                      <p>O atendimento foi realizado conforme agendamento prévio, e não houve qualquer impedimento ou irregularidade que pudesse comprometer a qualidade do serviço prestado.</p>
                      <p>Esta declaração serve como comprovação de presença e comparecimento ao local e horário designados.</p>
                      <p>Local e Data: Recife/PE, ${declDate} às ${declTime}.</p>
                    </div>
                    <div class="signature-section">
                      <div class="signature-box">
                        Assinatura e Carimbo do Responsável:<br>
                        ________________________________________
                      </div>
                    </div>
                    <div class="footer">
                      <p>Documento gerado automaticamente pelo Agendamento SESI Saúde.</p>
                      <p>Validade: Única emissão.</p>
                    </div>
                  </div>
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
            showToast('Declaração de Comparecimento gerada e aberta para impressão!', 'success');
        }
        function generateCalendar(agendaType = currentAgendaType) {
            const calendar = document.getElementById('calendar');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            calendar.innerHTML = `
                <div class="day-header">dom</div>
                <div class="day-header">seg</div>
                <div class="day-header">ter</div>
                <div class="day-header">qua</div>
                <div class="day-header">qui</div>
                <div class="day-header">sex</div>
                <div class="day-header">sáb</div>
            `;
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = date.getDate();
                dayElement.setAttribute('role', 'gridcell');
                dayElement.setAttribute('tabindex', '0');
                dayElement.setAttribute('aria-label', `Dia ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else {
                    const dayOfWeek = date.getDay();
                    const dateStr = date.toLocaleDateString('pt-BR');
                    const isHolidayDay = isHoliday(date);
                    const isBlockedDay = agendaType ? isBlocked(dateStr, agendaType) : false;
                    const blockReason = agendaType ? blockedDates.find(b => b.date === dateStr && b.agendaType === agendaType)?.reason : null;
                    const isUnavailableBase = dayOfWeek === 0 || dayOfWeek === 6 || isHolidayDay || date < today || isBlockedDay || (agendaType && !agendaSchedules[agendaType][dayOfWeek].some(p => p.start && p.end));
                    if (isUnavailableBase) {
                        dayElement.classList.add('unavailable');
                        if (isHolidayDay) {
                            dayElement.classList.add('holiday');
                            dayElement.title = getHolidayName(date);
                            dayElement.setAttribute('aria-label', `Feriado: ${getHolidayName(date)} - ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                        } else if (isBlockedDay) {
                            dayElement.classList.add('blocked');
                            dayElement.title = `Data bloqueada para ${agendaType}: ${blockReason}`;
                            dayElement.setAttribute('aria-label', `Data bloqueada para ${agendaType}: ${blockReason} - ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                        } else if (!agendaSchedules[agendaType]?.[dayOfWeek]?.some(p => p.start && p.end)) {
                            dayElement.title = `Sem disponibilidade para ${agendaType} neste dia da semana.`;
                        }
                        dayElement.setAttribute('aria-disabled', 'true');
                        dayElement.onclick = null;
                        dayElement.onkeydown = null;
                    } else {
                        dayElement.onclick = () => selectDay(date);
                        dayElement.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectDay(date); };
                        if (date.toDateString() === today.toDateString()) {
                            dayElement.style.background = '#ffc107';
                            dayElement.style.color = '#000';
                            dayElement.setAttribute('aria-label', `Hoje: ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                        }
                    }
                    const hasAppointment = appointmentDatesSet.has(date.toDateString());
                    if (hasAppointment) {
                        dayElement.classList.add('has-appointment');
                        dayElement.setAttribute('aria-label', `${dayElement.getAttribute('aria-label')} - Possui agendamento`);
                    }
                }
                calendar.appendChild(dayElement);
            }
            document.getElementById('monthDisplay').textContent = firstDay.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }
        function selectDay(date, dayElement = null) {
            if (isHoliday(date)) {
                showToast(`Não é possível selecionar feriados: ${getHolidayName(date)}`, 'error');
                return;
            }
            const dateStr = date.toLocaleDateString('pt-BR');
            const selectedAgendaType = document.getElementById('agendaTypeSelect').value;
            if (selectedAgendaType && isBlocked(dateStr, selectedAgendaType)) {
                const reason = blockedDates.find(b => b.date === dateStr && b.agendaType === selectedAgendaType)?.reason;
                showToast(`Data bloqueada para ${selectedAgendaType}: ${reason}`, 'error');
                return;
            }
            const dayOfWeek = date.getDay();
            if (selectedAgendaType && !agendaSchedules[selectedAgendaType][dayOfWeek].some(p => p.start && p.end)) {
                showToast(`Sem disponibilidade para ${selectedAgendaType} neste dia da semana.`, 'error');
                return;
            }
            selectedDay = date;
            if (dayElement) {
                dayElement.classList.add('selected');
            } else {
                document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
                const days = document.querySelectorAll('.day');
                for (let d of days) {
                    const dayNum = parseInt(d.textContent);
                    if (!isNaN(dayNum)) {
                        const testDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNum);
                        if (testDate.toDateString() === date.toDateString()) {
                            d.classList.add('selected');
                            break;
                        }
                    }
                }
            }
            document.getElementById('selectedDate').style.display = 'block';
            document.getElementById('selectedDateText').textContent = `${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })} de ${date.getFullYear()}`;
            document.getElementById('sectionButtons').style.display = 'flex';
            document.getElementById('blockDateBtn').disabled = false;
            updateScheduleButton();
            populateHours(date);
        }
        function autoSelectToday() {
            const today = new Date();
            const days = document.querySelectorAll('.day');
            for (let day of days) {
                const dayNum = parseInt(day.textContent);
                if (!isNaN(dayNum)) {
                    const testDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNum);
                    if (testDate.toDateString() === today.toDateString() && testDate.getMonth() === currentDate.getMonth()) {
                        const dayOfWeek = testDate.getDay();
                        const dateStr = testDate.toLocaleDateString('pt-BR');
                        const isHolidayDay = isHoliday(testDate);
                        const selectedAgendaType = document.getElementById('agendaTypeSelect').value;
                        const isBlockedDay = selectedAgendaType ? isBlocked(dateStr, selectedAgendaType) : false;
                        const hasSchedule = selectedAgendaType ? agendaSchedules[selectedAgendaType][dayOfWeek].some(p => p.start && p.end) : true;
                        const isUnavailable = dayOfWeek === 0 || dayOfWeek === 6 || isHolidayDay || testDate < today || isBlockedDay || !hasSchedule;
                        if (!isUnavailable) {
                            selectDay(testDate, day);
                            day.focus();
                            return;
                        }
                    }
                }
            }
            console.log('Hoje não é selecionável (fim de semana, feriado ou bloqueado).');
        }
        function blockSelectedDate() {
            if (!selectedDay) {
                showToast('Selecione uma data primeiro.', 'error');
                return;
            }
            const dateStr = selectedDay.toLocaleDateString('pt-BR');
            const selectedAgendaType = document.getElementById('agendaTypeSelect').value;
            if (selectedAgendaType && isBlocked(dateStr, selectedAgendaType)) {
                showToast(`Esta data já está bloqueada para ${selectedAgendaType}.`, 'error');
                return;
            }
            const hasAppointment = appointmentDatesSet.has(selectedDay.toDateString());
            if (hasAppointment) {
                if (!confirm(`Esta data possui agendamentos existentes. Deseja realmente bloquear a data "${dateStr}"? Isso impedirá novos agendamentos, mas os existentes permanecerão até serem editados ou excluídos manualmente.`)) {
                    return;
                }
            }
            document.getElementById('blockDateText').textContent = dateStr;
            const blockAgendaTypeSelect = document.getElementById('blockAgendaType');
            blockAgendaTypeSelect.innerHTML = '<option value="">Selecione o tipo de agenda</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                if (selectedAgendaType === type) {
                    option.selected = true;
                }
                blockAgendaTypeSelect.appendChild(option);
            });
            document.getElementById('blockReason').value = '';
            document.getElementById('blockModal').style.display = 'block';
            document.getElementById('blockAgendaType').focus();
        }
        function blockSelectedProfessional() {
            const blockProfessionalAgendaTypeSelect = document.getElementById('blockProfessionalAgendaType');
            blockProfessionalAgendaTypeSelect.innerHTML = '<option value="">Selecione o tipo de agenda</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                blockProfessionalAgendaTypeSelect.appendChild(option);
            });
            document.getElementById('blockProfessionalSelect').innerHTML = '<option value="">Selecione o profissional</option>';
            document.getElementById('blockProfessionalReason').value = '';
            document.getElementById('blockProfessionalStartDate').value = '';
            document.getElementById('blockProfessionalEndDate').value = '';
            document.getElementById('blockProfessionalModal').style.display = 'block';
            document.getElementById('blockProfessionalAgendaType').focus();
        }
        function confirmBlock() {
            const agendaType = document.getElementById('blockAgendaType').value.trim();
            const reason = document.getElementById('blockReason').value.trim();
            if (!agendaType) {
                showToast('Selecione o tipo de agenda para o bloqueio.', 'error');
                return;
            }
            if (!reason) {
                showToast('Informe o motivo do bloqueio.', 'error');
                return;
            }
            const dateStr = selectedDay.toLocaleDateString('pt-BR');
            blockedDates.push({ date: dateStr, agendaType: agendaType, reason: sanitizeInput(reason) });
            localStorage.setItem('blockedDates', JSON.stringify(blockedDates));
            blockedDates = JSON.parse(localStorage.getItem('blockedDates')) || [];
            closeModal('blockModal');
            showToast(`Data bloqueada com sucesso para ${agendaType}! 🔒`);
            toggleBlocked();
            generateCalendar(currentAgendaType);
            clearCalendarSelections();
        }
        function confirmBlockProfessional() {
            const agendaType = document.getElementById('blockProfessionalAgendaType').value.trim();
            const professional = document.getElementById('blockProfessionalSelect').value.trim();
            const startDate = document.getElementById('blockProfessionalStartDate').value;
            const endDate = document.getElementById('blockProfessionalEndDate').value;
            const reason = document.getElementById('blockProfessionalReason').value.trim();
            if (!agendaType || !professional || !startDate || !endDate || !reason) {
                showToast('Preencha todos os campos obrigatórios.', 'error');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                showToast('A data de início não pode ser posterior à data de fim.', 'error');
                return;
            }
            if (isProfessionalBlocked(professional, agendaType)) {
                showToast(`Este profissional já está bloqueado para ${agendaType}.`, 'error');
                return;
            }
            blockedProfessionals.push({ professional, agendaType, startDate, endDate, reason: sanitizeInput(reason) });
            localStorage.setItem('blockedProfessionals', JSON.stringify(blockedProfessionals));
            blockedProfessionals = JSON.parse(localStorage.getItem('blockedProfessionals')) || [];
            closeModal('blockProfessionalModal');
            showToast(`Profissional ${professional} bloqueado com sucesso para ${agendaType} de ${startDate} a ${endDate}! 🔒`);
            populateProfessionals(currentAgendaType, 'dentistSelect');
            if (document.getElementById('scheduledGrid').style.display !== 'none') {
                displayAppointments();
            }
        }
        function removeBlock(index) {
            if (confirm('Tem certeza que deseja remover este bloqueio?')) {
                blockedDates.splice(index, 1);
                localStorage.setItem('blockedDates', JSON.stringify(blockedDates));
                blockedDates = JSON.parse(localStorage.getItem('blockedDates')) || [];
                displayBlocked();
                generateCalendar(currentAgendaType);
                showToast('Bloqueio removido com sucesso! ✅');
            }
        }
        function removeProfessionalBlock(index) {
            if (confirm('Tem certeza que deseja remover este bloqueio de profissional?')) {
                blockedProfessionals.splice(index, 1);
                localStorage.setItem('blockedProfessionals', JSON.stringify(blockedProfessionals));
                blockedProfessionals = JSON.parse(localStorage.getItem('blockedProfessionals')) || [];
                displayBlocked();
                populateProfessionals(currentAgendaType, 'dentistSelect');
                showToast('Bloqueio de profissional removido com sucesso! ✅');
            }
        }
        function toggleBlocked() {
            const grid = document.getElementById('blockedGrid');
            const btn = document.getElementById('toggleBlockedBtn');
            if (grid.style.display === 'none' || grid.style.display === '') {
                grid.style.display = 'grid';
                grid.classList.add('show');
                btn.textContent = 'Ocultar Datas Bloqueadas';
                isBlockedSectionOpen = true;
                displayBlocked();
            } else {
                grid.style.display = 'none';
                grid.classList.remove('show');
                btn.textContent = 'Mostrar Datas Bloqueadas';
                isBlockedSectionOpen = false;
            }
        }
        function displayBlocked() {
            const list = document.getElementById('blockedList');
            const summary = document.getElementById('blockedSummary');
            list.innerHTML = '';
            blockedDates.sort((a, b) => {
                const dateA = new Date(a.date.split('/').reverse().join('-'));
                const dateB = new Date(b.date.split('/').reverse().join('-'));
                return dateB - dateA;
            });
            blockedProfessionals.sort((a, b) => a.agendaType.localeCompare(b.agendaType) || a.professional.localeCompare(b.professional));
            if (blockedDates.length === 0 && blockedProfessionals.length === 0) {
                list.innerHTML = '<p class="empty-message">Nenhuma data ou profissional bloqueado.</p>';
                summary.style.display = 'none';
                return;
            }
            const countOdontoDates = blockedDates.filter(b => b.agendaType === 'Agenda Odontológica').length;
            const countMedicasDates = blockedDates.filter(b => b.agendaType === 'Agenda Especialidades Médicas').length;
            const countExamesDates = blockedDates.filter(b => b.agendaType === 'Agenda de Exames').length;
            const countOdontoProfs = blockedProfessionals.filter(b => b.agendaType === 'Agenda Odontológica').length;
            const countMedicasProfs = blockedProfessionals.filter(b => b.agendaType === 'Agenda Especialidades Médicas').length;
            const countExamesProfs = blockedProfessionals.filter(b => b.agendaType === 'Agenda de Exames').length;
            summary.style.display = 'flex';
            summary.innerHTML = `
                <div class="blocked-summary-item">
                    <h4>🦷 Odontológica (Datas)</h4>
                    <p>${countOdontoDates}</p>
                </div>
                <div class="blocked-summary-item">
                    <h4>🏥 Médicas (Datas)</h4>
                    <p>${countMedicasDates}</p>
                </div>
                <div class="blocked-summary-item">
                    <h4>🔬 Exames (Datas)</h4>
                    <p>${countExamesDates}</p>
                </div>
                <div class="blocked-summary-item">
                    <h4>🦷 Odontológica (Profs)</h4>
                    <p>${countOdontoProfs}</p>
                </div>
                <div class="blocked-summary-item">
                    <h4>🏥 Médicas (Profs)</h4>
                    <p>${countMedicasProfs}</p>
                </div>
                <div class="blocked-summary-item">
                    <h4>🔬 Exames (Profs)</h4>
                    <p>${countExamesProfs}</p>
                </div>
            `;
            blockedDates.forEach((block, index) => {
                const card = document.createElement('div');
                card.className = 'block-card';
                card.setAttribute('role', 'listitem');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Bloqueio em ${block.date} para ${block.agendaType}: ${block.reason}`);
                card.innerHTML = `
                    <div class="block-actions">
                        <button class="btn-delete" onclick="removeBlock(${index})" aria-label="Remover bloqueio desta data" role="button">Remover</button>
                    </div>
                    <h4>🔒 ${block.date} - ${block.agendaType} (Data)</h4>
                    <p>Motivo: ${sanitizeInput(block.reason)}</p>
                `;
                list.appendChild(card);
                setTimeout(() => card.classList.add('show'), index * 100);
            });
            blockedProfessionals.forEach((block, index) => {
                const cardIndex = blockedDates.length + index;
                const card = document.createElement('div');
                card.className = 'block-card';
                card.setAttribute('role', 'listitem');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Bloqueio de ${block.professional} para ${block.agendaType}: ${block.reason}`);
                card.innerHTML = `
                    <div class="block-actions">
                        <button class="btn-delete" onclick="removeProfessionalBlock(${index})" aria-label="Remover bloqueio deste profissional" role="button">Remover</button>
                    </div>
                    <h4>🔒 ${block.professional} - ${block.agendaType} (Profissional)</h4>
                    <p>Período: ${block.startDate} a ${block.endDate}</p>
                    <p>Motivo: ${sanitizeInput(block.reason)}</p>
                `;
                list.appendChild(card);
                setTimeout(() => card.classList.add('show'), cardIndex * 100);
            });
        }
        function populateHours(selectedDate) {
            const hoursGrid = document.getElementById('hoursGrid');
            hoursGrid.innerHTML = '';
            const dateStr = selectedDate.toLocaleDateString('pt-BR');
            const selectedAgendaType = document.getElementById('agendaTypeSelect').value;
            const selectedDentist = document.getElementById('dentistSelect').value;
            const dayOfWeek = selectedDate.getDay();
            if (selectedAgendaType && isBlocked(dateStr, selectedAgendaType)) {
                const message = document.createElement('div');
                message.textContent = 'Esta data está bloqueada para o tipo de agenda selecionado. Nenhum horário disponível.';
                message.style.textAlign = 'center';
                message.style.padding = '20px';
                message.style.color = '#dc3545';
                message.style.fontWeight = 'bold';
                hoursGrid.appendChild(message);
                return;
            }
            if (selectedAgendaType && !agendaSchedules[selectedAgendaType][dayOfWeek].some(p => p.start && p.end)) {
                const message = document.createElement('div');
                message.textContent = 'Sem disponibilidade para este tipo de agenda neste dia da semana.';
                message.style.textAlign = 'center';
                message.style.padding = '20px';
                message.style.color = '#ffc107';
                message.style.fontWeight = 'bold';
                hoursGrid.appendChild(message);
                return;
            }
            let hours = getHoursForAgendaType(selectedAgendaType || 'Agenda Especialidades Médicas', dayOfWeek);
            let bookedHours = [];
            if (selectedAgendaType && selectedDentist) {
                bookedHours = appointments
                    .filter(apt => apt.agendaType === selectedAgendaType && apt.date === dateStr && apt.professional === selectedDentist)
                    .map(apt => apt.time);
            } else if (selectedAgendaType) {
                bookedHours = appointments
                    .filter(apt => apt.agendaType === selectedAgendaType && apt.date === dateStr)
                    .map(apt => apt.time);
            } else {
                bookedHours = appointments
                    .filter(apt => apt.date === dateStr)
                    .map(apt => apt.time);
            }
            hours.forEach((hour, index) => {
                const slot = document.createElement('div');
                slot.className = 'hour-slot';
                slot.style.animationDelay = `${index * 0.1}s`;
                slot.setAttribute('role', 'gridcell');
                slot.setAttribute('tabindex', '0');
                slot.setAttribute('aria-label', `Horário ${hour}`);
                if (bookedHours.includes(hour)) {
                    slot.classList.add('booked');
                    const titleText = selectedDentist ? 'Horário já agendado para este profissional' : 'Horário ocupado';
                    slot.title = titleText;
                    slot.setAttribute('aria-disabled', 'true');
                    slot.setAttribute('aria-label', `Horário ${hour} - Ocupado`);
                    slot.onkeydown = null;
                    slot.onclick = (e) => {
                        e.preventDefault();
                        const alertText = selectedDentist ? 'Este horário já está agendado para este profissional.' : 'Este horário está ocupado.';
                        alert(alertText);
                    };
                } else {
                    slot.onclick = () => selectHour(hour);
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectHour(hour); };
                }
                slot.textContent = hour;
                if (bookedHours.includes(hour)) {
                    const text = selectedDentist ? ' (Agendado)' : ' (Ocupado)';
                    slot.innerHTML += `<span style="font-size: 10px;">${text}</span>`;
                }
                hoursGrid.appendChild(slot);
            });
        }
        function selectHour(hour) {
            selectedHour = hour;
            document.querySelectorAll('.hour-slot:not(.booked)').forEach(s => s.classList.remove('selected'));
            event.target.classList.add('selected');
            updateScheduleButton();
        }
        function prevMonth() {
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentAgendaType);
            document.getElementById('selectedDate').style.display = 'none';
            clearCalendarSelections();
        }
        function nextMonth() {
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentAgendaType);
            document.getElementById('selectedDate').style.display = 'none';
            clearCalendarSelections();
        }
        function clearCalendarSelections() {
            selectedDay = null;
            selectedHour = null;
            document.querySelectorAll('.hour-slot').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
            document.getElementById('hoursGrid').innerHTML = '';
            document.getElementById('selectedDate').style.display = 'none';
            document.getElementById('blockDateBtn').disabled = true;
            updateScheduleButton();
        }
        function resetToEmpty() {
            clearCalendarSelections();
            editingId = null;
            document.getElementById('scheduleBtn').textContent = 'Agendar Consulta';
            document.getElementById('patientName').value = '';
            document.getElementById('patientCpf').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('schedulerName').value = '';
            document.getElementById('observations').value = '';
            document.getElementById('locationSelect').value = '';
            document.getElementById('agendaTypeSelect').value = '';
            document.getElementById('dentistSelect').value = '';
            document.getElementById('prioritySelect').value = '';
            document.getElementById('firstAppointmentSelect').value = '';
            discountObj = {};
            document.getElementById('displayedDiscounts').style.display = 'none';
            currentAgendaType = '';
            updateScheduleButton();
            generateCalendar(currentAgendaType);
            document.getElementById('patientName').focus();
        }
        function debouncedFilterAppointments() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filterAppointments, 300);
        }
        function clearOdontologiaFilters() {
            document.getElementById('odontologiaStartDate').value = '';
            document.getElementById('odontologiaEndDate').value = '';
            document.getElementById('odontologiaProfessional').value = '';
            document.getElementById('odontologiaCpf').value = '';
            document.getElementById('odontologiaSearch').value = '';
            filterAppointments();
        }
        function clearMedicasFilters() {
            document.getElementById('medicasStartDate').value = '';
            document.getElementById('medicasEndDate').value = '';
            document.getElementById('medicasProfessional').value = '';
            document.getElementById('medicasCpf').value = '';
            document.getElementById('medicasSearch').value = '';
            filterAppointments();
        }
        function clearExamesFilters() {
            document.getElementById('examesStartDate').value = '';
            document.getElementById('examesEndDate').value = '';
            document.getElementById('examesProfessional').value = '';
            document.getElementById('examesCpf').value = '';
            document.getElementById('examesSearch').value = '';
            filterAppointments();
        }
        function toggleScheduled() {
            const grid = document.getElementById('scheduledGrid');
            const btn = document.getElementById('toggleScheduledBtn');
            if (grid.style.display === 'none' || grid.style.display === '') {
                grid.style.display = 'grid';
                grid.classList.add('show');
                btn.textContent = 'Ocultar Consultas Agendadas';
                displayAppointments();
            } else {
                grid.style.display = 'none';
                grid.classList.remove('show');
                btn.textContent = 'Mostrar Consultas Agendadas';
            }
        }
        function toggleReport() {
            const content = document.getElementById('reportContent');
            const btn = document.getElementById('toggleReportBtn');
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = 'Ocultar Relatórios';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Mostrar Relatórios';
            }
        }
        function toggleAgendaMgmt() {
            const section = document.getElementById('agendaMgmtSection');
            const btn = document.querySelector('.agenda-mgmt-toggle');
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                btn.textContent = '📋 Fechar Gestão';
                displayAgendaMgmt();
            } else {
                section.style.display = 'none';
                btn.textContent = '📋 Gestão de Agenda';
            }
        }
        // Updated displayAgendaMgmt for table view - Only Monday to Friday
        function displayAgendaMgmt() {
            const grid = document.getElementById('agendaMgmtGrid');
            grid.innerHTML = '';
            const dayNames = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta']; // Only Monday to Friday
            const periodNames = ['1º Período', '2º Período', '3º Período'];
            agendaTypes.forEach((type, typeIndex) => {
                const item = document.createElement('div');
                item.className = `agenda-mgmt-item ${type === 'Agenda Odontológica' ? 'odontologica' : type === 'Agenda Especialidades Médicas' ? 'medicas' : ''}`;
                let tableHTML = `
                    <h4>${type}</h4>
                    <table class="agenda-table">
                        <thead>
                            <tr>
                                <th>Período</th>
                                ${dayNames.map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;
                for (let p = 0; p < 3; p++) {
                    tableHTML += `<tr><td>${periodNames[p]}</td>`;
                    for (let d = 1; d <= 5; d++) { // Only Monday to Friday (days 1-5)
                        const period = agendaSchedules[type][d]?.[p] || {start: '', end: ''};
                        const value = formatPeriod(period);
                        const isGray = !period.start || !period.end;
                        tableHTML += `
                            <td class="${isGray ? 'gray-cell' : ''}">
                                <input type="text" value="${value}" placeholder="HH:MM HH:MM" onchange="updatePeriod('${type}', ${d}, ${p}, this.value)" ${isGray ? 'disabled' : ''}>
                            </td>
                        `;
                    }
                    tableHTML += '</tr>';
                }
                tableHTML += `
                        </tbody>
                    </table>
                    <button class="save-agenda-btn" onclick="saveAgenda('${type}')">Salvar Agenda ${type}</button>
                `;
                item.innerHTML = tableHTML;
                grid.appendChild(item);
            });
        }
        function updatePeriod(type, day, periodIndex, value) {
            const parsed = parsePeriodInput(value);
            if (!agendaSchedules[type][day]) agendaSchedules[type][day] = [];
            if (!agendaSchedules[type][day][periodIndex]) agendaSchedules[type][day][periodIndex] = {start: '', end: ''};
            agendaSchedules[type][day][periodIndex].start = parsed.start;
            agendaSchedules[type][day][periodIndex].end = parsed.end;
            // Re-render table to update gray cells
            displayAgendaMgmt();
        }
        function saveAgenda(type) {
            localStorage.setItem('agendaSchedules', JSON.stringify(agendaSchedules));
            showToast(`Agenda para ${type} salva com sucesso!`, 'success');
            // If current, update hours
            if (currentAgendaType === type && selectedDay) {
                populateHours(selectedDay);
            }
        }
        function saveAppointment() {
            const btn = document.getElementById('scheduleBtn');
            const spinner = document.getElementById('scheduleSpinner');
            btn.classList.add('loading');
            spinner.style.display = 'block';
            setTimeout(() => {
                const patientName = sanitizeInput(document.getElementById('patientName').value.trim());
                const patientCpf = document.getElementById('patientCpf').value.trim();
                const cpfClean = patientCpf.replace(/\D/g, '');
                const patientPhone = document.getElementById('patientPhone').value.trim();
                const phoneClean = patientPhone.replace(/\D/g, '');
                const schedulerName = sanitizeInput(document.getElementById('schedulerName').value.trim());
                const observations = sanitizeInput(document.getElementById('observations').value.trim());
                const agendaType = document.getElementById('agendaTypeSelect').value;
                const professional = sanitizeInput(document.getElementById('dentistSelect').value);
                const location = document.getElementById('locationSelect').value;
                const priority = document.getElementById('prioritySelect').value;
                const firstAppointment = document.getElementById('firstAppointmentSelect').value;
                const dateStr = selectedDay.toLocaleDateString('pt-BR');
                const dayOfWeek = selectedDay.getDay();
                if (isHoliday(selectedDay)) {
                    showToast(`Não é possível agendar em feriados: ${getHolidayName(selectedDay)}.`, 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                if (isBlocked(dateStr, agendaType)) {
                    const reason = blockedDates.find(b => b.date === dateStr && b.agendaType === agendaType)?.reason;
                    showToast(`Não é possível agendar em data bloqueada para ${agendaType}: ${reason}.`, 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                if (!agendaSchedules[agendaType][dayOfWeek].some(p => p.start && p.end)) {
                    showToast(`Sem disponibilidade para ${agendaType} neste dia da semana.`, 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                if (isProfessionalBlocked(professional, agendaType)) {
                    const reason = blockedProfessionals.find(bp => bp.professional === professional && bp.agendaType === agendaType)?.reason;
                    showToast(`Não é possível agendar com profissional bloqueado para ${agendaType}: ${reason}.`, 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                if (patientCpf && !isValidCPF(cpfClean)) {
                    showToast('CPF inválido.', 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                if (phoneClean.length < 10 || phoneClean.length > 11) {
                    showToast('Telefone inválido.', 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                const existing = appointments.find(apt =>
                    apt.agendaType === agendaType &&
                    apt.date === dateStr &&
                    apt.time === selectedHour &&
                    apt.professional === professional
                );
                if (existing) {
                    showToast('Já existe um agendamento para este profissional nesta data e horário.', 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }
                const appointment = {
                    id: Date.now(),
                    patient: patientName,
                    cpf: patientCpf,
                    phone: patientPhone,
                    scheduler: schedulerName,
                    observations,
                    location,
                    agendaType,
                    date: dateStr,
                    time: selectedHour,
                    professional,
                    priority,
                    firstAppointment,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    discount: Object.keys(discountObj).length > 0 ? discountObj : undefined
                };
                appointments.unshift(appointment);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                currentPrintId = appointment.id;
                updateAppointmentDatesSet();
                showToast('Consulta agendada com sucesso! ✅');
                resetToEmpty();
                generateCalendar(currentAgendaType);
                if (document.getElementById('scheduledGrid').style.display !== 'none') {
                    displayAppointments();
                }
                btn.classList.remove('loading');
                spinner.style.display = 'none';
                justScheduled = true;
                document.getElementById('printConfirmModal').style.display = 'block';
                focusTrap(document.getElementById('printConfirmModal'));
            }, 1000);
        }
        function editAppointment(id) {
            const appointment = appointments.find(apt => apt.id === id);
            if (appointment) {
                editingId = id;
                document.getElementById('editPatientName').value = appointment.patient;
                document.getElementById('editPatientCpf').value = appointment.cpf || '';
                document.getElementById('editPatientPhone').value = appointment.phone || '';
                document.getElementById('editSchedulerName').value = appointment.scheduler || '';
                document.getElementById('editObservations').value = appointment.observations || '';
                document.getElementById('editLocationSelect').value = appointment.location || '';
                const agendaType = appointment.agendaType || '';
                document.getElementById('editAgendaTypeSelect').value = agendaType;
                populateEditProfessionals();
                const professional = appointment.professional || '';
                document.getElementById('editDentistSelect').value = professional;
                populateEditTimes();
                document.getElementById('editPrioritySelect').value = appointment.priority || '';
                document.getElementById('editFirstAppointmentSelect').value = appointment.firstAppointment || '';
                const [d, m, y] = appointment.date.split('/');
                document.getElementById('editDate').value = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                document.getElementById('editTime').value = appointment.time;
                document.getElementById('editModal').style.display = 'block';
                document.getElementById('editPatientName').focus();
                focusTrap(document.getElementById('editModal'));
            }
        }
        function saveEdit() {
            const patientName = sanitizeInput(document.getElementById('editPatientName').value.trim());
            const patientCpf = document.getElementById('editPatientCpf').value.trim();
            const cpfClean = patientCpf.replace(/\D/g, '');
            const patientPhone = document.getElementById('editPatientPhone').value.trim();
            const phoneClean = patientPhone.replace(/\D/g, '');
            const schedulerName = sanitizeInput(document.getElementById('editSchedulerName').value.trim());
            const observations = sanitizeInput(document.getElementById('editObservations').value.trim());
            const location = document.getElementById('editLocationSelect').value;
            const agendaType = document.getElementById('editAgendaTypeSelect').value;
            const professional = sanitizeInput(document.getElementById('editDentistSelect').value);
            const priority = document.getElementById('editPrioritySelect').value;
            const firstAppointment = document.getElementById('editFirstAppointmentSelect').value;
            const newDateInput = document.getElementById('editDate').value;
            const newTime = document.getElementById('editTime').value;
            if (!patientName || (patientCpf && !isValidCPF(cpfClean)) || (phoneClean.length < 10 || phoneClean.length > 11) || !location || !agendaType || !professional || !newDateInput || !newTime || !priority || !firstAppointment) {
                showToast('Preencha todos os campos obrigatórios e verifique o CPF e telefone.', 'error');
                return;
            }
            const [y, m, d] = newDateInput.split('-');
            const newDateStr = `${d}/${m}/${y}`;
            const newDateObj = new Date(y, m - 1, d);
            const newDayOfWeek = newDateObj.getDay();
            if (isHoliday(newDateObj)) {
                showToast(`Não é possível agendar em feriados: ${getHolidayName(newDateObj)}.`, 'error');
                return;
            }
            if (isBlocked(newDateStr, agendaType)) {
                const reason = blockedDates.find(b => b.date === newDateStr && b.agendaType === agendaType)?.reason;
                showToast(`Não é possível agendar em data bloqueada para ${agendaType}: ${reason}.`, 'error');
                return;
            }
            if (!agendaSchedules[agendaType][newDayOfWeek].some(p => p.start && p.end)) {
                showToast(`Sem disponibilidade para ${agendaType} neste dia da semana.`, 'error');
                return;
            }
            if (isProfessionalBlocked(professional, agendaType)) {
                const reason = blockedProfessionals.find(bp => bp.professional === professional && bp.agendaType === agendaType)?.reason;
                showToast(`Não é possível agendar com profissional bloqueado para ${agendaType}: ${reason}.`, 'error');
                return;
            }
            const existing = appointments.find(apt =>
                apt.id !== editingId &&
                apt.agendaType === agendaType &&
                apt.date === newDateStr &&
                apt.time === newTime &&
                apt.professional === professional
            );
            if (existing) {
                showToast('Conflito: Já existe um agendamento neste horário para este profissional.', 'error');
                return;
            }
            const appointment = appointments.find(apt => apt.id === editingId);
            if (appointment) {
                const oldDateStr = appointment.date;
                appointment.patient = patientName;
                appointment.cpf = patientCpf;
                appointment.phone = patientPhone;
                appointment.scheduler = schedulerName;
                appointment.observations = observations;
                appointment.location = location;
                appointment.agendaType = agendaType;
                appointment.date = newDateStr;
                appointment.time = newTime;
                appointment.professional = professional;
                appointment.priority = priority;
                appointment.firstAppointment = firstAppointment;
                appointment.timestamp = new Date().toISOString();
                if (oldDateStr !== newDateStr) {
                    updateAppointmentDatesSet();
                }
            }
            localStorage.setItem('appointments', JSON.stringify(appointments));
            closeModal('editModal');
            editingId = null;
            showToast('Consulta atualizada com sucesso! ✅');
            generateCalendar(currentAgendaType);
            if (document.getElementById('scheduledGrid').style.display !== 'none') {
                displayAppointments();
            }
        }
        function deleteAppointment(id) {
            deleteId = id;
            document.getElementById('deleteModal').style.display = 'block';
            focusTrap(document.getElementById('deleteModal'));
        }
        function confirmDelete() {
            if (deleteId) {
                const appointmentToDelete = appointments.find(apt => apt.id === deleteId);
                appointments = appointments.filter(apt => apt.id !== deleteId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                updateAppointmentDatesSet();
                closeModal('deleteModal');
                deleteId = null;
                showToast('Consulta inativada com sucesso! ✅');
                generateCalendar(currentAgendaType);
                if (document.getElementById('scheduledGrid').style.display !== 'none') {
                    displayAppointments();
                }
            }
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            if (modalId === 'printConfirmModal' && justScheduled) {
                setTimeout(() => {
                    justScheduled = false;
                    window.location.reload();
                }, 1000);
            }
            const triggeringButton = document.activeElement;
            if (triggeringButton && (triggeringButton.classList.contains('btn-edit') || triggeringButton.classList.contains('btn-delete'))) {
                triggeringButton.focus();
            }
        }
        window.onclick = function(event) {
            const deleteModal = document.getElementById('deleteModal');
            const editModal = document.getElementById('editModal');
            const blockModal = document.getElementById('blockModal');
            const blockProfessionalModal = document.getElementById('blockProfessionalModal');
            const printConfirmModal = document.getElementById('printConfirmModal');
            const printTypeModal = document.getElementById('printTypeModal');
            const patientHistoryModal = document.getElementById('patientHistoryModal');
            const discountModal = document.getElementById('discountModal');
            const declarationTimeModal = document.getElementById('declarationTimeModal');
            if (event.target === deleteModal) closeModal('deleteModal');
            if (event.target === editModal) closeModal('editModal');
            if (event.target === blockModal) closeModal('blockModal');
            if (event.target === blockProfessionalModal) closeModal('blockProfessionalModal');
            if (event.target === printConfirmModal) closeModal('printConfirmModal');
            if (event.target === printTypeModal) closeModal('printTypeModal');
            if (event.target === patientHistoryModal) closeModal('patientHistoryModal');
            if (event.target === discountModal) closeModal('discountModal');
            if (event.target === declarationTimeModal) closeModal('declarationTimeModal');
        }
        function filterAppointments() {
            displayAppointments();
        }
        function displayAppointments() {
            const odontologiaList = document.getElementById('odontologiaList');
            const medicasList = document.getElementById('medicasList');
            const examesList = document.getElementById('examesList');
            const odontologiaStart = document.getElementById('odontologiaStartDate').value;
            const odontologiaEnd = document.getElementById('odontologiaEndDate').value;
            const odontologiaProf = document.getElementById('odontologiaProfessional').value;
            const odontologiaCpf = document.getElementById('odontologiaCpf').value.replace(/\D/g, '');
            const odontologiaSearch = document.getElementById('odontologiaSearch').value.toLowerCase().trim();
            const medicasStart = document.getElementById('medicasStartDate').value;
            const medicasEnd = document.getElementById('medicasEndDate').value;
            const medicasProf = document.getElementById('medicasProfessional').value;
            const medicasCpf = document.getElementById('medicasCpf').value.replace(/\D/g, '');
            const medicasSearch = document.getElementById('medicasSearch').value.toLowerCase().trim();
            const examesStart = document.getElementById('examesStartDate').value;
            const examesEnd = document.getElementById('examesEndDate').value;
            const examesProf = document.getElementById('examesProfessional').value;
            const examesCpf = document.getElementById('examesCpf').value.replace(/\D/g, '');
            const examesSearch = document.getElementById('examesSearch').value.toLowerCase().trim();
            let odontologiaAppts = appointments.filter(apt => apt.agendaType === 'Agenda Odontológica');
            odontologiaAppts = odontologiaAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (odontologiaStart) {
                    const start = new Date(odontologiaStart);
                    if (aptDate < start) return false;
                }
                if (odontologiaEnd) {
                    const end = new Date(odontologiaEnd);
                    if (aptDate > end) return false;
                }
                if (odontologiaProf && apt.professional !== odontologiaProf) return false;
                if (odontologiaCpf && apt.cpf.replace(/\D/g, '') !== odontologiaCpf) return false;
                if (odontologiaSearch && !apt.patient.toLowerCase().includes(odontologiaSearch)) return false;
                return true;
            });
            let medicasAppts = appointments.filter(apt => apt.agendaType === 'Agenda Especialidades Médicas');
            medicasAppts = medicasAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (medicasStart) {
                    const start = new Date(medicasStart);
                    if (aptDate < start) return false;
                }
                if (medicasEnd) {
                    const end = new Date(medicasEnd);
                    if (aptDate > end) return false;
                }
                if (medicasProf && apt.professional !== medicasProf) return false;
                if (medicasCpf && apt.cpf.replace(/\D/g, '') !== medicasCpf) return false;
                if (medicasSearch && !apt.patient.toLowerCase().includes(medicasSearch)) return false;
                return true;
            });
            let examesAppts = appointments.filter(apt => apt.agendaType === 'Agenda de Exames');
            examesAppts = examesAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (examesStart) {
                    const start = new Date(examesStart);
                    if (aptDate < start) return false;
                }
                if (examesEnd) {
                    const end = new Date(examesEnd);
                    if (aptDate > end) return false;
                }
                if (examesProf && apt.professional !== examesProf) return false;
                if (examesCpf && apt.cpf.replace(/\D/g, '') !== examesCpf) return false;
                if (examesSearch && !apt.patient.toLowerCase().includes(examesSearch)) return false;
                return true;
            });
            if (odontologiaAppts.length === 0) {
                odontologiaList.innerHTML = '<p class="empty-message">Nenhum agendamento odontológico.</p>';
            } else {
                odontologiaList.innerHTML = '';
                odontologiaAppts.forEach((apt, index) => {
                    const statusClass = getStatusClass(apt.status);
                    const statusText = getStatusText(apt.status);
                    const schedulerText = apt.scheduler ? ` | Responsável: ${sanitizeInput(apt.scheduler)}` : '';
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.style.animationDelay = `${index * 0.1}s`;
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('aria-label', `Agendamento de ${apt.patient} em ${apt.date} às ${apt.time} - Status: ${statusText}`);
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar este agendamento" role="button">Editar</button>
                            <button class="btn-declaration" onclick="generateAttendanceDeclarationForAppointment(${apt.id})" aria-label="Gerar Declaração de Comparecimento" role="button">Declaração</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Inativar este agendamento" role="button">Inativar</button>
                            <button class="btn-pdf" onclick="preparePrint(${apt.id})" aria-label="Imprimir comprovante" role="button">Imprimir</button>
                        </div>
                        <h4><span class="patient-name" onclick="showPatientHistory('${apt.cpf}', '${apt.patient}')" aria-label="Ver histórico de ${apt.patient}">${sanitizeInput(apt.patient)}</span> - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'Não informado'} | Telefone: ${apt.phone || 'Não informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'Não informado'} | Local: ${apt.location || 'Não informado'} | Prioritário: ${apt.priority || 'Não informado'} | Primeiro Atendimento: ${apt.firstAppointment || 'Não informado'}${schedulerText}</p>
                        ${apt.observations ? `<p class="observations">Observações: ${sanitizeInput(apt.observations)}</p>` : ''}
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="status ${statusClass}">Status: ${statusText}</span>
                                <button class="btn-attended" onclick="updateAttendanceStatus(${apt.id}, 'attended')" aria-label="Marcar como compareceu" role="button">Compareceu</button>
                                <button class="btn-no-show" onclick="updateAttendanceStatus(${apt.id}, 'no-show')" aria-label="Marcar como não compareceu" role="button">Não Compareceu</button>
                                <button class="btn-rescheduled" onclick="updateAttendanceStatus(${apt.id}, 'rescheduled')" aria-label="Marcar como reagendado" role="button">Reagendado</button>
                            </div>
                            <button class="btn-clinica" onclick="confirmOpenFicha('${apt.cpf || ''}', '${apt.patient}', '${apt.phone || ''}', '${apt.observations || ''}')" aria-label="Abrir Ficha Odontológica" role="button">Ficha Odontológica</button>
                        </div>
                    `;
                    setTimeout(() => card.classList.add('show'), index * 50);
                    odontologiaList.appendChild(card);
                });
            }
            if (medicasAppts.length === 0) {
                medicasList.innerHTML = '<p class="empty-message">Nenhum agendamento de especialidades médicas.</p>';
            } else {
                medicasList.innerHTML = '';
                medicasAppts.forEach((apt, index) => {
                    const statusClass = getStatusClass(apt.status);
                    const statusText = getStatusText(apt.status);
                    const schedulerText = apt.scheduler ? ` | Responsável: ${sanitizeInput(apt.scheduler)}` : '';
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.style.animationDelay = `${index * 0.1}s`;
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('aria-label', `Agendamento de ${apt.patient} em ${apt.date} às ${apt.time} - Status: ${statusText}`);
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar este agendamento" role="button">Editar</button>
                            <button class="btn-declaration" onclick="generateAttendanceDeclarationForAppointment(${apt.id})" aria-label="Gerar Declaração de Comparecimento" role="button">Declaração</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Inativar este agendamento" role="button">Inativar</button>
                            <button class="btn-pdf" onclick="preparePrint(${apt.id})" aria-label="Imprimir comprovante" role="button">Imprimir</button>
                        </div>
                        <h4><span class="patient-name" onclick="showPatientHistory('${apt.cpf}', '${apt.patient}')" aria-label="Ver histórico de ${apt.patient}">${sanitizeInput(apt.patient)}</span> - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'Não informado'} | Telefone: ${apt.phone || 'Não informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'Não informado'} | Local: ${apt.location || 'Não informado'} | Prioritário: ${apt.priority || 'Não informado'} | Primeiro Atendimento: ${apt.firstAppointment || 'Não informado'}${schedulerText}</p>
                        ${apt.observations ? `<p class="observations">Observações: ${sanitizeInput(apt.observations)}</p>` : ''}
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="status ${statusClass}">Status: ${statusText}</span>
                                <button class="btn-attended" onclick="updateAttendanceStatus(${apt.id}, 'attended')" aria-label="Marcar como compareceu" role="button">Compareceu</button>
                                <button class="btn-no-show" onclick="updateAttendanceStatus(${apt.id}, 'no-show')" aria-label="Marcar como não compareceu" role="button">Não Compareceu</button>
                                <button class="btn-rescheduled" onclick="updateAttendanceStatus(${apt.id}, 'rescheduled')" aria-label="Marcar como reagendado" role="button">Reagendado</button>
                            </div>
                            <button class="btn-clinica" onclick="confirmOpenFicha('${apt.cpf || ''}', '${apt.patient}', '${apt.phone || ''}', '${apt.observations || ''}')" aria-label="Abrir Ficha Clínica" role="button">Ficha Clínica</button>
                        </div>
                    `;
                    setTimeout(() => card.classList.add('show'), index * 50);
                    medicasList.appendChild(card);
                });
            }
            if (examesAppts.length === 0) {
                examesList.innerHTML = '<p class="empty-message">Nenhum agendamento de exames.</p>';
            } else {
                examesList.innerHTML = '';
                examesAppts.forEach((apt, index) => {
                    const statusClass = getStatusClass(apt.status);
                    const statusText = getStatusText(apt.status);
                    const schedulerText = apt.scheduler ? ` | Responsável: ${sanitizeInput(apt.scheduler)}` : '';
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.style.animationDelay = `${index * 0.1}s`;
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('aria-label', `Agendamento de ${apt.patient} em ${apt.date} às ${apt.time} - Status: ${statusText}`);
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar este agendamento" role="button">Editar</button>
                            <button class="btn-declaration" onclick="generateAttendanceDeclarationForAppointment(${apt.id})" aria-label="Gerar Declaração de Comparecimento" role="button">Declaração</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Inativar este agendamento" role="button">Inativar</button>
                            <button class="btn-pdf" onclick="preparePrint(${apt.id})" aria-label="Imprimir comprovante" role="button">Imprimir</button>
                        </div>
                        <h4><span class="patient-name" onclick="showPatientHistory('${apt.cpf}', '${apt.patient}')" aria-label="Ver histórico de ${apt.patient}">${sanitizeInput(apt.patient)}</span> - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'Não informado'} | Telefone: ${apt.phone || 'Não informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'Não informado'} | Local: ${apt.location || 'Não informado'} | Prioritário: ${apt.priority || 'Não informado'} | Primeiro Atendimento: ${apt.firstAppointment || 'Não informado'}${schedulerText}</p>
                        ${apt.observations ? `<p class="observations">Observações: ${sanitizeInput(apt.observations)}</p>` : ''}
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="status ${statusClass}">Status: ${statusText}</span>
                                <button class="btn-attended" onclick="updateAttendanceStatus(${apt.id}, 'attended')" aria-label="Marcar como compareceu" role="button">Compareceu</button>
                                <button class="btn-no-show" onclick="updateAttendanceStatus(${apt.id}, 'no-show')" aria-label="Marcar como não compareceu" role="button">Não Compareceu</button>
                                <button class="btn-rescheduled" onclick="updateAttendanceStatus(${apt.id}, 'rescheduled')" aria-label="Marcar como reagendado" role="button">Reagendado</button>
                            </div>
                            <button class="btn-clinica" onclick="confirmOpenFicha('${apt.cpf || ''}', '${apt.patient}', '${apt.phone || ''}', '${apt.observations || ''}')" aria-label="Abrir Ficha Clínica" role="button">Ficha Clínica</button>
                        </div>
                    `;
                    setTimeout(() => card.classList.add('show'), index * 50);
                    examesList.appendChild(card);
                });
            }
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '✅' : '❌';
            toast.textContent = `${icon} ${message}`;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }
        function updateAttendanceStatus(id, status) {
            const appointment = appointments.find(apt => apt.id === id);
            if (appointment) {
                appointment.status = status;
                appointment.timestamp = new Date().toISOString();
                localStorage.setItem('appointments', JSON.stringify(appointments));
                const statusText = getStatusText(status);
                showToast(`Status atualizado: ${statusText}`, 'success');
                if (document.getElementById('scheduledGrid').style.display !== 'none') {
                    displayAppointments();
                }
            }
        }
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal[style*="block"]');
                openModals.forEach(modal => closeModal(modal.id));
            }
        }
        function focusTrap(modal) {
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            if (focusableElements.length === 0) return;
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                }
            });
            firstFocusable.focus();
        }
        // Discount Modal Functions
        function openDiscountModal() {
            const agendaType = document.getElementById('agendaTypeSelect').value;
            const professional = document.getElementById('dentistSelect').value;
            if (!agendaType || !professional) {
                showToast('Selecione o tipo de agenda e o profissional para adicionar desconto.', 'error');
                return;
            }
            currentServicePrice = prices[professional] || 0;
            document.getElementById('serviceNameDisplay').textContent = `${professional} (${agendaType})`;
            document.getElementById('currentPriceDisplay').textContent = `R$ ${currentServicePrice.toFixed(2)}`;
            document.getElementById('serviceInfo').style.display = 'block';
            calculateDiscount();
            document.getElementById('discountModal').style.display = 'block';
            focusTrap(document.getElementById('discountModal'));
            document.getElementById('industryDiscount').checked = false;
            document.getElementById('promotionalDiscount').checked = false;
            document.getElementById('industryDiscountInput').style.display = 'none';
            document.getElementById('promotionalDiscountInput').style.display = 'none';
            document.getElementById('promotionType').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('otherPromotion').style.display = 'none';
            document.getElementById('otherPromotion').value = '';
            document.getElementById('discountedInfo').style.display = 'none';
        }
        function toggleDiscountInput(inputGroupId, isChecked) {
            const inputGroup = document.getElementById(inputGroupId);
            inputGroup.style.display = isChecked ? 'flex' : 'none';
            calculateDiscount();
        }
        function calculateDiscount() {
            const industryChecked = document.getElementById('industryDiscount').checked;
            const promotionalChecked = document.getElementById('promotionalDiscount').checked;
            let totalDiscount = 0;
            if (industryChecked) {
                totalDiscount += parseFloat(document.getElementById('industryDiscountValue').value) || 0;
            }
            if (promotionalChecked) {
                totalDiscount += parseFloat(document.getElementById('promotionalDiscountValue').value) || 0;
            }
            const discountedPrice = currentServicePrice * (1 - totalDiscount / 100);
            if (totalDiscount > 0) {
                document.getElementById('discountedPriceDisplay').textContent = `R$ ${discountedPrice.toFixed(2)}`;
                document.getElementById('discountedInfo').style.display = 'block';
            } else {
                document.getElementById('discountedInfo').style.display = 'none';
            }
        }
        function applyDiscount() {
            const industryChecked = document.getElementById('industryDiscount').checked;
            const promotionalChecked = document.getElementById('promotionalDiscount').checked;
            if (!industryChecked && !promotionalChecked) {
                showToast('Selecione pelo menos um tipo de desconto.', 'error');
                return;
            }
            discountObj = {};
            let discountInfo = '';
            if (industryChecked) {
                const value = parseFloat(document.getElementById('industryDiscountValue').value);
                if (!value || value <= 0) {
                    showToast('Informe um valor válido para Desconto Industria.', 'error');
                    return;
                }
                discountObj.industry = value;
                discountInfo += `Indústria: ${value}% `;
                document.getElementById('industryDiscountDisplay').textContent = `Desconto Indústria: ${value}%`;
            } else {
                document.getElementById('industryDiscountDisplay').textContent = '';
            }
            if (promotionalChecked) {
                const value = parseFloat(document.getElementById('promotionalDiscountValue').value);
                if (!value || value <= 0) {
                    showToast('Informe um valor válido para Desconto Promocional.', 'error');
                    return;
                }
                discountObj.promotional = value;
                discountInfo += `Promocional: ${value}% `;
                document.getElementById('promotionalDiscountDisplay').textContent = `Desconto Promocional: ${value}%`;
                const promotionType = document.getElementById('promotionType').value;
                if (promotionType) {
                    let promotionName = promotionType;
                    if (promotionType === 'Outros') {
                        promotionName = document.getElementById('otherPromotion').value.trim();
                        if (!promotionName) {
                            showToast('Informe o nome da promoção para "Outros".', 'error');
                            return;
                        }
                    }
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (!startDate || !endDate) {
                        showToast('Preencha as datas de início e término da promoção.', 'error');
                        return;
                    }
                    if (!discountObj.promotion) discountObj.promotion = {};
                    discountObj.promotion.name = promotionName;
                    discountObj.promotion.start = startDate;
                    discountObj.promotion.end = endDate;
                }
            } else {
                document.getElementById('promotionalDiscountDisplay').textContent = '';
            }
            document.getElementById('displayedDiscounts').style.display = 'block';
            showToast(`Desconto aplicado: ${discountInfo}`, 'success');
            closeModal('discountModal');
        }
        function closeDiscountDisplay() {
            document.getElementById('displayedDiscounts').style.display = 'none';
            discountObj = {};
        }
        window.onload = async function() {
            console.warn('Aviso: Dados salvos em localStorage. Para produção, migre para Firebase ou Supabase para melhor segurança e persistência.');
            try {
                logoBase64 = await getImageBase64('img/sesibranco.png');
                if (!logoBase64) {
                    console.warn('Logo não carregado. Verifique o caminho do arquivo "img/sesibranco.png".');
                }
            } catch (e) {
                console.error('Falha ao carregar logo para impressões:', e);
                logoBase64 = '';
            }
            try {
                coloredLogoBase64 = await getImageBase64('img/sesisaude.png');
                if (!coloredLogoBase64) {
                    console.warn('Logo colorido não carregado. Verifique o caminho do arquivo "img/sesisaude.png".');
                }
            } catch (e) {
                console.error('Falha ao carregar logo colorido para declarações:', e);
                coloredLogoBase64 = '';
            }
            updateAppointmentDatesSet();
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            toggleBtn.setAttribute('aria-checked', savedTheme === 'dark' ? 'true' : 'false');
            const agendaTypeSelect = document.getElementById('agendaTypeSelect');
            agendaTypeSelect.innerHTML = '<option value="">Selecione</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                agendaTypeSelect.appendChild(option);
            });
            const editAgendaTypeSelect = document.getElementById('editAgendaTypeSelect');
            editAgendaTypeSelect.innerHTML = '<option value="">Selecione</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                editAgendaTypeSelect.appendChild(option);
            });
            const reportAgendaTypeSelect = document.getElementById('reportAgendaType');
            reportAgendaTypeSelect.innerHTML = '<option value="">Todos os Tipos</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                reportAgendaTypeSelect.appendChild(option);
            });
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Selecione um local</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });
            const editLocationSelect = document.getElementById('editLocationSelect');
            editLocationSelect.innerHTML = '<option value="">Selecione um local</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                editLocationSelect.appendChild(option);
            });
            const odontologiaProfessional = document.getElementById('odontologiaProfessional');
            odontologiaProfessional.innerHTML = '<option value="">Todos</option>';
            dentists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                odontologiaProfessional.appendChild(option);
            });
            const medicasProfessional = document.getElementById('medicasProfessional');
            medicasProfessional.innerHTML = '<option value="">Todos</option>';
            medicalSpecialists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                medicasProfessional.appendChild(option);
            });
            const examesProfessional = document.getElementById('examesProfessional');
            examesProfessional.innerHTML = '<option value="">Todos</option>';
            examSpecialists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                examesProfessional.appendChild(option);
            });
            document.getElementById('agendaTypeSelect').onchange = function() {
                currentAgendaType = this.value;
                const agendaType = this.value;
                populateProfessionals(agendaType, 'dentistSelect');
                document.getElementById('dentistSelect').value = '';
                generateCalendar(currentAgendaType);
                if (selectedDay) {
                    populateHours(selectedDay);
                }
                updateScheduleButton();
            };
            document.getElementById('dentistSelect').onchange = function() {
                if (selectedDay) {
                    populateHours(selectedDay);
                }
                updateScheduleButton();
            };
            document.getElementById('locationSelect').onchange = function() {
                updateScheduleButton();
            };
            document.getElementById('prioritySelect').onchange = function() {
                updateScheduleButton();
            };
            document.getElementById('firstAppointmentSelect').onchange = function() {
                updateScheduleButton();
            };
            document.getElementById('patientName').oninput = updateScheduleButton;
            document.getElementById('patientCpf').oninput = function() { formatCPF(this); validateCPF(this); };
            document.getElementById('patientPhone').oninput = function() { formatPhone(this); validatePhone(this); };
            document.getElementById('schedulerName').oninput = updateScheduleButton;
            const editCpfInput = document.getElementById('editPatientCpf');
            editCpfInput.oninput = function() { formatCPF(this); validateEditCPF(this); };
            const editPhoneInput = document.getElementById('editPatientPhone');
            editPhoneInput.oninput = function() { formatPhone(this); validateEditPhone(this); };
            currentAgendaType = '';
            generateCalendar(currentAgendaType);
            document.getElementById('patientName').focus();
            document.addEventListener('keydown', handleEscapeKey);
            document.getElementById('promotionType').onchange = function() {
                const otherInput = document.getElementById('otherPromotion');
                if (this.value === 'Outros') {
                    otherInput.style.display = 'block';
                } else {
                    otherInput.style.display = 'none';
                    otherInput.value = '';
                }
            };
            const blockedGrid = document.getElementById('blockedGrid');
            const toggleBlockedBtn = document.getElementById('toggleBlockedBtn');
            if (blockedDates.length > 0 || blockedProfessionals.length > 0) {
                blockedGrid.style.display = 'grid';
                blockedGrid.classList.add('show');
                toggleBlockedBtn.textContent = 'Ocultar Datas Bloqueadas';
                isBlockedSectionOpen = true;
                displayBlocked();
            }
        };
        function updateScheduleButton() {
            const patientName = document.getElementById('patientName').value.trim();
            const patientCpf = document.getElementById('patientCpf').value.trim();
            const cpfValid = patientCpf ? isValidCPF(patientCpf.replace(/\D/g, '')) : true;
            const patientPhone = document.getElementById('patientPhone').value.trim();
            const phoneValid = patientPhone && (patientPhone.replace(/\D/g, '').length >= 10 && patientPhone.replace(/\D/g, '').length <= 11);
            const agendaType = document.getElementById('agendaTypeSelect').value;
            const professional = document.getElementById('dentistSelect').value;
            const location = document.getElementById('locationSelect').value;
            const priority = document.getElementById('prioritySelect').value;
            const firstAppointment = document.getElementById('firstAppointmentSelect').value;
            const btn = document.getElementById('scheduleBtn');
            const isDisabled = !patientName || !cpfValid || !phoneValid || !selectedDay || !selectedHour || !agendaType || !professional || !location || !priority || !firstAppointment;
            btn.disabled = isDisabled;
            btn.setAttribute('aria-disabled', isDisabled ? 'true' : 'false');
            btn.setAttribute('aria-label', isDisabled ? 'Agendar consulta (desabilitado até preencher todos os campos obrigatórios)' : 'Agendar consulta');
        }
        function generateReport() {
            const btn = document.querySelector('.report-btn');
            const spinner = document.getElementById('reportSpinner');
            btn.classList.add('loading');
            spinner.style.display = 'block';
            setTimeout(() => {
                const agendaTypeFilter = document.getElementById('reportAgendaType').value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                filteredAppointments = appointments.filter(apt => {
                    if (agendaTypeFilter && apt.agendaType !== agendaTypeFilter) return false;
                    if (startDate) {
                        const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                        const start = new Date(startDate);
                        if (aptDate < start) return false;
                    }
                    if (endDate) {
                        const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                        const end = new Date(endDate);
                        if (aptDate > end) return false;
                    }
                    return true;
                });
                filteredAppointments.sort((a, b) => {
                    const dateA = new Date(a.date.split('/').reverse().join('-'));
                    const dateB = new Date(b.date.split('/').reverse().join('-'));
                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;
                    const timeA = a.time.split(':').reduce((acc, val, idx) => acc + parseInt(val) * (idx === 0 ? 60 : 1), 0);
                    const timeB = b.time.split(':').reduce((acc, val, idx) => acc + parseInt(val) * (idx === 0 ? 60 : 1), 0);
                    return timeA - timeB;
                });
                const tableBody = document.getElementById('reportTableBody');
                tableBody.innerHTML = '';
                filteredAppointments.forEach((apt, index) => {
                    const row = tableBody.insertRow();
                    row.style.animationDelay = `${index * 0.05}s`;
                    row.classList.add('fadeIn');
                    row.insertCell(0).textContent = sanitizeInput(apt.patient);
                    row.insertCell(1).textContent = apt.cpf || '';
                    row.insertCell(2).textContent = apt.phone || '';
                    row.insertCell(3).textContent = apt.date;
                    row.insertCell(4).textContent = apt.time;
                    row.insertCell(5).textContent = sanitizeInput(apt.professional);
                    row.insertCell(6).textContent = apt.agendaType;
                    row.insertCell(7).textContent = apt.location;
                    row.insertCell(8).textContent = apt.priority || '';
                    row.insertCell(9).textContent = apt.firstAppointment || '';
                    const statusClass = getStatusClass(apt.status);
                    row.insertCell(10).innerHTML = `<span class="status ${statusClass}">${getStatusText(apt.status)}</span>`;
                    row.insertCell(11).textContent = sanitizeInput(apt.observations || '');
                });
                const total = filteredAppointments.length;
                const odontologica = filteredAppointments.filter(apt => apt.agendaType === 'Agenda Odontológica').length;
                const medicas = filteredAppointments.filter(apt => apt.agendaType === 'Agenda Especialidades Médicas').length;
                const exames = filteredAppointments.filter(apt => apt.agendaType === 'Agenda de Exames').length;
                const summary = document.getElementById('summaryStats');
                summary.innerHTML = `
                    <div class="summary-item">
                        <h4>Total de Agendamentos</h4>
                        <p>${total}</p>
                    </div>
                    <div class="summary-item">
                        <h4>Odontológica</h4>
                        <p>${odontologica}</p>
                    </div>
                    <div class="summary-item">
                        <h4>Especialidades Médicas</h4>
                        <p>${medicas}</p>
                    </div>
                    <div class="summary-item">
                        <h4>Exames</h4>
                        <p>${exames}</p>
                    </div>
                `;
                const ctx1 = document.getElementById('reportChart').getContext('2d');
                if (reportChart) {
                    reportChart.destroy();
                }
                const barTotal = odontologica + medicas + exames;
                reportChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Odontológica', 'Especialidades Médicas', 'Exames'],
                        datasets: [{
                            data: [odontologica, medicas, exames],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(0, 123, 255, 0.8)',
                                'rgba(23, 162, 184, 0.8)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(0, 123, 255, 1)',
                                'rgba(23, 162, 184, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Agendamentos por Tipo',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = barTotal > 0 ? ((value / barTotal) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutBounce'
                        }
                    }
                });
                const barPercentages = document.getElementById('barPercentages');
                barPercentages.innerHTML = `
                    <p>Odontológica: ${barTotal > 0 ? ((odontologica / barTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Especialidades Médicas: ${barTotal > 0 ? ((medicas / barTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Exames: ${barTotal > 0 ? ((exames / barTotal) * 100).toFixed(1) : 0}%</p>
                `;
                const attended = filteredAppointments.filter(apt => apt.status === 'attended').length;
                const noShow = filteredAppointments.filter(apt => apt.status === 'no-show').length;
                const rescheduled = filteredAppointments.filter(apt => apt.status === 'rescheduled').length;
                const pending = filteredAppointments.length - attended - noShow - rescheduled;
                const ctx2 = document.getElementById('attendanceChart').getContext('2d');
                if (attendanceChart) {
                    attendanceChart.destroy();
                }
                const attendanceTotal = attended + noShow + pending + rescheduled;
                attendanceChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Compareceu', 'Não Compareceu', 'Pendente', 'Reagendado'],
                        datasets: [{
                            data: [attended, noShow, pending, rescheduled],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(255, 193, 7, 0.6)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(220, 53, 69, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(255, 193, 7, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Taxa de Comparecimento Detalhada',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = attendanceTotal > 0 ? ((value / attendanceTotal) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutBounce'
                        }
                    }
                });
                const barAttendancePercentages = document.getElementById('barAttendancePercentages');
                barAttendancePercentages.innerHTML = `
                    <p>Compareceu: ${attendanceTotal > 0 ? ((attended / attendanceTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Não Compareceu: ${attendanceTotal > 0 ? ((noShow / attendanceTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Pendente: ${attendanceTotal > 0 ? ((pending / attendanceTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Reagendado: ${attendanceTotal > 0 ? ((rescheduled / attendanceTotal) * 100).toFixed(1) : 0}%</p>
                `;
                const profCounts = {};
                filteredAppointments.forEach(apt => {
                    profCounts[apt.professional] = (profCounts[apt.professional] || 0) + 1;
                });
                const profEntries = Object.entries(profCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const profLabels = profEntries.map(entry => entry[0]);
                const profData = profEntries.map(entry => entry[1]);
                const profTotal = Object.values(profCounts).reduce((sum, count) => sum + count, 0);
                const ctx3 = document.getElementById('productivityChart').getContext('2d');
                if (productivityChart) {
                    productivityChart.destroy();
                }
                productivityChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: profLabels,
                        datasets: [{
                            data: profData,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Produtividade por Profissional (Top 5)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = profTotal > 0 ? ((value / profTotal) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutBounce'
                        }
                    }
                });
                const productivityPercentages = document.getElementById('productivityPercentages');
                productivityPercentages.innerHTML = profEntries.map(entry => `<p>${entry[0]}: ${((entry[1] / profTotal) * 100).toFixed(1)}%</p>`).join('');
                document.getElementById('reportTableContainer').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
                btn.classList.remove('loading');
                spinner.style.display = 'none';
            }, 500);
        }
        function exportToExcel() {
            if (filteredAppointments.length === 0) {
                showToast('Nenhum relatório para exportar.', 'error');
                return;
            }
            const headers = ['Paciente', 'CPF', 'Telefone', 'Data', 'Horário', 'Profissional', 'Tipo', 'Local', 'Prioritário', 'Primeiro Atendimento', 'Status', 'Observações'];
            const data = [
                headers,
                ...filteredAppointments.map(apt => [
                    apt.patient,
                    apt.cpf || '',
                    apt.phone || '',
                    apt.date,
                    apt.time,
                    apt.professional,
                    apt.agendaType,
                    apt.location,
                    apt.priority || '',
                    apt.firstAppointment || '',
                    getStatusText(apt.status),
                    apt.observations || ''
                ])
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            for(let col=0; col<headers.length; col++){
                const cell_address = XLSX.utils.encode_cell({r:0, c:col});
                if(!ws[cell_address]) continue;
                ws[cell_address].s = {
                    font: { bold: true, color: {rgb: "FFFFFF"} },
                    fill: { fgColor: {rgb: "007BFF"} },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
            for(let row=1; row<data.length; row++){
                const rowColor = row % 2 === 0 ? "F8F9FA" : "FFFFFF";
                for(let col=0; col<headers.length; col++){
                    const cell_address = XLSX.utils.encode_cell({r:row, c:col});
                    if(!ws[cell_address]) continue;
                    ws[cell_address].s = {
                        fill: { fgColor: {rgb: rowColor} },
                        alignment: { wrapText: true, vertical: "center" }
                    };
                }
            }
            for(let row=1; row<data.length; row++){
                const status = data[row][10];
                let statusColor = "000000";
                if(status === 'Compareceu') statusColor = "155724";
                else if(status === 'Não Compareceu') statusColor = "721C24";
                else if(status === 'Reagendado') statusColor = "856404";
                else statusColor = "383D41";
                const cell_address = XLSX.utils.encode_cell({r:row, c:10});
                if(!ws[cell_address]) continue;
                ws[cell_address].s = {
                    font: { bold: true, color: {rgb: statusColor} },
                    fill: { fgColor: {rgb: "FFFFFF"} },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatório de Agendamentos');
            XLSX.writeFile(wb, `relatorio_agendamentos_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Relatório exportado para Excel com cores! ✅');
        }
    </script>
</body>
</html>
