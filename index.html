<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento M√©dico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-primary: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            --bg-secondary: white;
            --text-primary: #2c3e50;
            --accent: #007bff;
            --success: #28a745;
            --error: #e74c3c;
            --warning: #ffc107;
        }
        
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --bg-secondary: #2d2d2d;
            --text-primary: #f0f4f8;
            --accent: #007bff;
            --success: #28a745;
            --error: #e74c3c;
            --warning: #ffc107;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 15px;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }
        .header-logo {
            height: 90px;
            width: auto;
        }
        .logo {
            font-size: 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .system-title {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            text-align: center;
            padding: 12px;
            margin: -15px 0 15px 0;
            border-radius: 0 0 12px 12px;
            font-weight: 400;
            font-size: 16px;
        }
        .container {
            display: grid;
            grid-template-columns: 1.5fr 1.5fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745);
        }
        .section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        h3 {
            color: #007bff;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        .month-nav button {
            background: #e9ecef;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.2s;
            color: #6c757d;
        }
        .month-nav button:hover {
            background: #007bff;
            color: white;
            transform: scale(1.1);
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }
        .day-header {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            padding: 6px;
            font-weight: 500;
            font-size: 11px;
            color: #6c757d;
        }
        .day {
            padding: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            font-size: 14px;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 0.5px;
            position: relative;
        }
        .day:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: scale(1.05);
        }
        .day.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        .day.other-month {
            color: #adb5bd;
            background: transparent;
        }
        .day.unavailable {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        .day.holiday {
            background: #ffeb3b;
            color: #000;
            font-weight: bold;
        }
        .day.blocked {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: var(--error);
            font-weight: bold;
            cursor: not-allowed;
            border-color: var(--error);
        }
        .day.unavailable:hover {
            background: #f8f9fa;
            transform: none;
            border-color: #e9ecef;
        }
        .day.past {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        .day.has-appointment::after {
            content: '‚Ä¢';
            position: absolute;
            bottom: 1px;
            right: 2px;
            color: #dc3545;
            font-size: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .selected-date {
            margin-top: 8px;
            padding: 8px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 6px;
            font-style: italic;
            color: #0056b3;
            border-left: 3px solid #007bff;
            animation: fadeIn 0.3s ease;
            font-size: 13px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .hour-slot {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffd54f;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hour-slot:hover, .hour-slot.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,123,255,0.2);
        }
        .hour-slot.booked {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #f5c6cb;
            color: #721c24;
            cursor: not-allowed;
            font-weight: bold;
        }
        .hour-slot.booked:hover {
            transform: none;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 13px;
            transition: all 0.2s;
            background: white;
            margin-bottom: 10px;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            display: none;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        .radio-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 400;
            font-size: 13px;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
        }
        .radio-group label:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }
        .schedule-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
            position: relative;
        }
        .schedule-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .schedule-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        .block-btn {
            background: linear-gradient(135deg, var(--error) 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
            margin-top: 5px;
        }
        .block-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        .block-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        .dentist-select {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }
        .dentist-select h4 {
            margin: 0 0 6px 0;
            color: #007bff;
            font-size: 13px;
        }
        .agenda-type-select {
            margin-bottom: 12px;
        }
        .agenda-type-select h4 {
            margin: 0 0 6px 0;
            color: #007bff;
            font-size: 13px;
        }
        .report-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
        }
        .report-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffc107, #dc3545);
        }
        .report-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .report-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .report-filters select, .report-filters input {
            flex: 1;
            min-width: 150px;
        }
        .report-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
            position: relative;
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
            margin-left: 10px;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .report-table th, .report-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }
        .report-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 500;
            color: #495057;
        }
        .report-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
        }
        .summary-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            color: #007bff;
        }
        .summary-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #0056b3;
        }
        .chart-container {
            margin-top: 20px;
            text-align: center;
            height: 150px;
            position: relative;
        }
        .chart-percentages {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-wrapper {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        .scheduled-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .scheduled-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .scheduled-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #28a745, #ffc107);
        }
        .toggle-scheduled-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
            width: auto;
            margin: 0 0 10px 0;
            display: inline-block;
        }
        .toggle-scheduled-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        .scheduled-grid {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 12px;
        }
        .scheduled-column {
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .scheduled-column.odontologia {
            border-left-color: #28a745;
        }
        .scheduled-column.exames {
            border-left-color: #17a2b8;
        }
        .scheduled-column h4 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 500;
        }
        .scheduled-column.odontologia h4 {
            color: #28a745;
        }
        .scheduled-column.exames h4 {
            color: #17a2b8;
        }
        .date-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .date-filters input {
            width: auto;
            min-width: 120px;
        }
        .date-filters label {
            font-size: 12px;
            color: #6c757d;
        }
        .professional-filter {
            margin-bottom: 10px;
        }
        .cpf-filter {
            margin-bottom: 10px;
        }
        .search-filter {
            margin-bottom: 10px;
        }
        .professional-filter label, .cpf-filter label, .search-filter label {
            font-size: 12px;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }
        .professional-filter select, .cpf-filter input, .search-filter input {
            width: 100%;
            font-size: 12px;
        }
        .cpf-filter input, .search-filter input {
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        .scheduled-list {
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .appointment-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #007bff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            animation: slideIn 0.4s ease;
            position: relative;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .appointment-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .appointment-card h4 {
            margin: 0 0 4px 0;
            color: #0056b3;
            font-size: 14px;
        }
        .appointment-card p {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }
        .appointment-card .observations {
            font-style: italic;
            color: #495057;
            margin-top: 4px;
        }
        .appointment-card .status {
            font-weight: bold;
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            font-size: 11px;
        }
        .appointment-card .status.attended {
            background: #d4edda;
            color: #155724;
        }
        .appointment-card .status.no-show {
            background: #f8d7da;
            color: #721c24;
        }
        .appointment-card .status.rescheduled {
            background: #fff3cd;
            color: #856404;
        }
        .appointment-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .btn-edit, .btn-delete, .btn-attended, .btn-no-show, .btn-rescheduled {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        .btn-edit:hover {
            background: #e0a800;
            transform: scale(1.05);
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .btn-attended {
            background: #28a745;
            color: white;
        }
        .btn-attended:hover {
            background: #218838;
            transform: scale(1.05);
        }
        .btn-no-show {
            background: #6c757d;
            color: white;
        }
        .btn-no-show:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        .btn-rescheduled {
            background: #ffc107;
            color: #000;
        }
        .btn-rescheduled:hover {
            background: #e0a800;
            transform: scale(1.05);
        }
        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            font-size: 14px;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .modal h3 {
            margin-top: 0;
            color: #007bff;
        }
        .modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .modal textarea {
            resize: vertical;
            min-height: 60px;
        }
        .modal .radio-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .modal .radio-group label {
            padding: 4px;
            font-size: 12px;
        }
        .modal-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .modal-btn:hover {
            transform: translateY(-1px);
        }
        .cancel-btn {
            background: #6c757d;
        }
        .confirm-delete {
            background: #dc3545;
        }
        .modal input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        .modal .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            display: none;
        }
        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #28a745;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
        }
        .toast.show {
            visibility: visible;
            animation: fadeIn 0.5s;
        }
        .toast.error {
            background-color: #dc3545;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .summary {
                flex-direction: column;
            }
            .summary-item {
                margin: 5px 0;
            }
            .scheduled-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
            .date-filters {
                flex-direction: column;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            body {
                padding: 10px;
            }
            .header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            .appointment-actions {
                position: static;
                justify-content: center;
                margin-top: 8px;
                gap: 8px;
            }
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            .report-filters {
                flex-direction: column;
            }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .required {
            color: #dc3545;
        }
        /* Melhorias de acessibilidade para bot√µes */
        button:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        button[aria-disabled="true"] {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body data-theme="light">
    <div class="header">
        <img src="img/sesi_semfundo.png" alt="SESI Logo" class="header-logo">
        <div class="logo">
            <span>ü©∫</span>
            Sistema de Agendamento Pessoa F√≠sica - SESI Sa√∫de
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema" role="switch" aria-checked="false">üåô</button>
        <img src="img/melhoria.jpg" alt="SESI Logo" class="header-logo">
    </div>

    <div class="container">
        <div class="section">
            <h3>üìÖ Selecione uma Data</h3>
            <div class="calendar-header">
                <div class="month-nav">
                    <button onclick="prevMonth()" aria-label="M√™s anterior" role="button">‚Äπ</button>
                    <span class="month" id="monthDisplay" role="status">outubro 2025</span>
                    <button onclick="nextMonth()" aria-label="Pr√≥ximo m√™s" role="button">‚Ä∫</button>
                </div>
            </div>
            <div class="calendar" id="calendar" role="grid" aria-label="Calend√°rio">
                <!-- Calendar will be generated by JS -->
            </div>
            <div class="selected-date" id="selectedDate" style="display: none;" role="alert">
                Data selecionada: <span id="selectedDateText"></span>
            </div>
            <div id="blockDateContainer" style="margin-top: 10px;">
                <button class="block-btn" id="blockDateBtn" onclick="blockSelectedDate()" disabled style="display:none;" aria-label="Bloquear data selecionada" role="button">üîí Bloquear Data</button>
            </div>
        </div>

        <div class="section">
            <h3>üïí Hor√°rios Dispon√≠veis</h3>
            <div class="agenda-type-select">
                <h4>üìã Selecione o Tipo de Agenda</h4>
                <label for="agendaTypeSelect" class="sr-only">Tipo de agenda</label>
                <select id="agendaTypeSelect" aria-required="true" aria-describedby="agendaTypeDesc">
                    <option value="">Selecione</option>
                </select>
                <small id="agendaTypeDesc" class="sr-only">Escolha o tipo de agenda para exibir profissionais e hor√°rios dispon√≠veis.</small>
            </div>
            <div class="dentist-select">
                <h4>üë§ Selecione o Profissional</h4>
                <label for="dentistSelect" class="sr-only">Profissional</label>
                <select id="dentistSelect" aria-required="true" aria-describedby="dentistDesc">
                    <option value="">Selecione um profissional</option>
                </select>
                <small id="dentistDesc" class="sr-only">Selecione o profissional para verificar hor√°rios dispon√≠veis.</small>
            </div>
            <div class="hours-grid" id="hoursGrid" role="grid" aria-label="Hor√°rios dispon√≠veis">
                <!-- Hours will be populated by JS -->
            </div>
        </div>

        <div class="section">
            <h3>üë§ Dados da Consulta</h3>
            <label for="patientName">Nome do Paciente <span aria-hidden="true" class="required">*</span></label>
            <input type="text" id="patientName" placeholder="Digite o nome completo do paciente" aria-required="true" aria-describedby="patientNameDesc" required>
            <small id="patientNameDesc" class="sr-only">Campo obrigat√≥rio. Digite o nome completo do paciente.</small>
            
            <label for="patientCpf">CPF do Paciente <span aria-hidden="true" class="required">*</span></label>
            <input type="text" id="patientCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" aria-required="true" aria-describedby="cpfError patientCpfDesc" required>
            <small id="cpfError" class="error-message" aria-live="polite">CPF inv√°lido. (Apenas N√∫meros).</small>
            <small id="patientCpfDesc" class="sr-only">Campo obrigat√≥rio. Digite o CPF no formato 123.456.789-00.</small>
            
            <label for="patientPhone">N√∫mero do Telefone <span aria-hidden="true" class="required">*</span></label>
            <input type="tel" id="patientPhone" placeholder="Digite o n√∫mero do telefone (ex: (11) 99999-9999)" aria-required="true" aria-describedby="phoneError patientPhoneDesc" required>
            <small id="phoneError" class="error-message" aria-live="polite">Telefone inv√°lido. Use o formato (DD) 9XXXX-XXXX.</small>
            <small id="patientPhoneDesc" class="sr-only">Campo obrigat√≥rio. Digite o telefone no formato (11) 99999-9999.</small>
            
            <label for="locationSelect">üè¢ Local do Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="locationSelect" aria-required="true" aria-describedby="locationDesc" required>
                <option value="">Selecione um local</option>
            </select>
            <small id="locationDesc" class="sr-only">Campo obrigat√≥rio. Escolha o local de atendimento.</small>
            
            <label for="prioritySelect">Atendimento Priorit√°rio <span aria-hidden="true" class="required">*</span></label>
            <select id="prioritySelect" aria-required="true" aria-describedby="priorityDesc" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>
            <small id="priorityDesc" class="sr-only">Indique se o atendimento √© priorit√°rio.</small>

            <label for="firstAppointmentSelect">Primeiro Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="firstAppointmentSelect" aria-required="true" aria-describedby="firstAppointmentDesc" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>
            <small id="firstAppointmentDesc" class="sr-only">Indique se √© o primeiro atendimento.</small>

            <label for="observations">Observa√ß√µes</label>
            <textarea id="observations" placeholder="Digite observa√ß√µes adicionais (opcional)" aria-describedby="observationsDesc"></textarea>
            <small id="observationsDesc" class="sr-only">Campo opcional para observa√ß√µes adicionais.</small>

            <button class="schedule-btn" id="scheduleBtn" onclick="saveAppointment()" disabled aria-label="Agendar consulta (desabilitado at√© preencher todos os campos obrigat√≥rios)" role="button">
                Agendar Consulta
                <div class="spinner" id="scheduleSpinner"></div>
            </button>
        </div>
    </div>

    <div class="scheduled-section">
        <h3>üìã Consultas Agendadas</h3>
        <button class="toggle-scheduled-btn" id="toggleScheduledBtn" onclick="toggleScheduled()" aria-label="Mostrar ou ocultar lista de consultas agendadas" role="button">Mostrar Consultas Agendadas</button>
        <div class="scheduled-grid" id="scheduledGrid">
            <div class="scheduled-column odontologia">
                <h4>ü¶∑ Odontol√≥gica</h4>
                <div class="date-filters">
                    <label for="odontologiaStartDate">Data Inicial:</label>
                    <input type="date" id="odontologiaStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial odontol√≥gica">
                    <label for="odontologiaEndDate">Data Final:</label>
                    <input type="date" id="odontologiaEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final odontol√≥gica">
                </div>
                <div class="professional-filter">
                    <label for="odontologiaProfessional">Profissional:</label>
                    <select id="odontologiaProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional odontol√≥gico">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label for="odontologiaCpf">CPF:</label>
                    <input type="text" id="odontologiaCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF odontol√≥gico">
                </div>
                <div class="search-filter">
                    <label for="odontologiaSearch">Buscar Paciente:</label>
                    <input type="text" id="odontologiaSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente odontol√≥gico">
                </div>
                <div id="odontologiaList" class="scheduled-list" role="list" aria-label="Lista de agendamentos odontol√≥gicos">
                    <p class="empty-message">Nenhum agendamento odontol√≥gico.</p>
                </div>
            </div>
            <div class="scheduled-column">
                <h4>üè• Especialidades M√©dicas</h4>
                <div class="date-filters">
                    <label for="medicasStartDate">Data Inicial:</label>
                    <input type="date" id="medicasStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial m√©dica">
                    <label for="medicasEndDate">Data Final:</label>
                    <input type="date" id="medicasEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final m√©dica">
                </div>
                <div class="professional-filter">
                    <label for="medicasProfessional">Profissional:</label>
                    <select id="medicasProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional m√©dico">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label for="medicasCpf">CPF:</label>
                    <input type="text" id="medicasCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF m√©dico">
                </div>
                <div class="search-filter">
                    <label for="medicasSearch">Buscar Paciente:</label>
                    <input type="text" id="medicasSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente m√©dico">
                </div>
                <div id="medicasList" class="scheduled-list" role="list" aria-label="Lista de agendamentos m√©dicos">
                    <p class="empty-message">Nenhum agendamento de especialidades m√©dicas.</p>
                </div>
            </div>
            <div class="scheduled-column exames">
                <h4>üî¨ Exames</h4>
                <div class="date-filters">
                    <label for="examesStartDate">Data Inicial:</label>
                    <input type="date" id="examesStartDate" onchange="debouncedFilterAppointments()" aria-label="Data inicial exames">
                    <label for="examesEndDate">Data Final:</label>
                    <input type="date" id="examesEndDate" onchange="debouncedFilterAppointments()" aria-label="Data final exames">
                </div>
                <div class="professional-filter">
                    <label for="examesProfessional">Profissional:</label>
                    <select id="examesProfessional" onchange="debouncedFilterAppointments()" aria-label="Profissional exames">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="cpf-filter">
                    <label for="examesCpf">CPF:</label>
                    <input type="text" id="examesCpf" placeholder="Digite o CPF (ex: 123.456.789-00)" oninput="formatFilterCPF(this); debouncedFilterAppointments()" maxlength="14" aria-label="Filtro por CPF exames">
                </div>
                <div class="search-filter">
                    <label for="examesSearch">Buscar Paciente:</label>
                    <input type="text" id="examesSearch" placeholder="Digite nome do paciente" oninput="debouncedFilterAppointments()" aria-label="Busca por paciente exames">
                </div>
                <div id="examesList" class="scheduled-list" role="list" aria-label="Lista de agendamentos de exames">
                    <p class="empty-message">Nenhum agendamento de exames.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="scheduled-section" id="blockedSection">
        <h3>üîí Gerenciar Datas Bloqueadas</h3>
        <button class="toggle-scheduled-btn" id="toggleBlockedBtn" onclick="toggleBlocked()" aria-label="Mostrar ou ocultar lista de datas bloqueadas" role="button">Mostrar Datas Bloqueadas</button>
        <div class="scheduled-grid" id="blockedGrid" style="display: none;">
            <div class="scheduled-column">
                <h4>Bloqueios Ativos</h4>
                <div id="blockedList" class="scheduled-list" role="list" aria-label="Lista de datas bloqueadas">
                    <p class="empty-message">Nenhuma data bloqueada.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="scheduled-section">
        <h3>üìä Relat√≥rios de Agendamentos</h3>
        <button class="toggle-scheduled-btn" id="toggleReportBtn" onclick="toggleReport()" aria-label="Mostrar ou ocultar se√ß√£o de relat√≥rios" role="button">Mostrar Relat√≥rios</button>
        <div class="report-section" id="reportContent" style="display: none;">
            <div class="report-filters">
                <label for="reportAgendaType" class="sr-only">Tipo de relat√≥rio</label>
                <select id="reportAgendaType" aria-label="Tipo de relat√≥rio">
                    <option value="">Todos os Tipos</option>
                    <option value="Agenda Odontol√≥gica">Agenda Odontol√≥gica</option>
                    <option value="Agenda Especialidades M√©dicas">Agenda Especialidades M√©dicas</option>
                    <option value="Agenda de Exames">Agenda de Exames</option>
                </select>
                <label for="reportStartDate" class="sr-only">Data inicial relat√≥rio</label>
                <input type="date" id="reportStartDate" aria-label="Data inicial relat√≥rio">
                <label for="reportEndDate" class="sr-only">Data final relat√≥rio</label>
                <input type="date" id="reportEndDate" aria-label="Data final relat√≥rio">
                <button class="report-btn" onclick="generateReport()" aria-label="Gerar relat√≥rio de agendamentos" role="button">
                    Gerar Relat√≥rio
                    <div class="spinner" id="reportSpinner"></div>
                </button>
                <button class="export-btn" id="exportBtn" onclick="exportToExcel()" style="display: none;" aria-label="Exportar relat√≥rio para Excel" role="button">Exportar Excel</button>
                <button class="export-btn" id="exportPdfBtn" onclick="exportToPDF()" style="display: none;" aria-label="Exportar relat√≥rio para PDF" role="button">Exportar PDF</button>
            </div>
            <div id="reportTableContainer" style="display: none;">
                <table class="report-table" id="reportTable" role="table" aria-label="Tabela de relat√≥rios">
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>CPF</th>
                            <th>Telefone</th>
                            <th>Data</th>
                            <th>Hor√°rio</th>
                            <th>Profissional</th>
                            <th>Tipo</th>
                            <th>Local</th>
                            <th>Priorit√°rio</th>
                            <th>Primeiro Atendimento</th>
                            <th>Observa√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" role="rowgroup"></tbody>
                </table>
                <div class="summary" id="summaryStats"></div>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h4>Distribui√ß√£o por Tipo</h4>
                        <div class="chart-container">
                            <canvas id="reportChart" aria-label="Gr√°fico de colunas mostrando distribui√ß√£o de agendamentos por tipo" role="img"></canvas>
                        </div>
                        <div class="chart-percentages" id="barPercentages"></div>
                    </div>
                    <div class="chart-wrapper">
                        <h4>Taxa de Comparecimento</h4>
                        <div class="chart-container">
                            <canvas id="attendanceChart" aria-label="Gr√°fico de pizza mostrando taxa de comparecimento" role="img"></canvas>
                        </div>
                        <div class="chart-percentages" id="piePercentages"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert" aria-live="polite">Consulta agendada com sucesso!</div>

    <!-- Block Modal -->
    <div id="blockModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="blockTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('blockModal')" aria-label="Fechar modal de bloqueio de data">&times;</span>
            <h3 id="blockTitle">Bloquear Data</h3>
            <p>Data: <span id="blockDateText"></span></p>
            <label for="blockReason">Motivo do Bloqueio <span aria-hidden="true" class="required">*</span></label>
            <textarea id="blockReason" placeholder="Digite o motivo do bloqueio..." aria-required="true" required></textarea>
            <button class="modal-btn" onclick="confirmBlock()" aria-label="Confirmar bloqueio da data" role="button">Bloquear Data</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('blockModal')" aria-label="Cancelar bloqueio da data" role="button">Cancelar</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteModal')" aria-label="Fechar modal de confirma√ß√£o de exclus√£o">&times;</span>
            <h3 id="deleteTitle">Confirmar Exclus√£o</h3>
            <p>Tem certeza que deseja excluir esta consulta?</p>
            <button class="modal-btn confirm-delete" onclick="confirmDelete()" aria-label="Confirmar exclus√£o da consulta" role="button">Sim, Excluir</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('deleteModal')" aria-label="Cancelar exclus√£o da consulta" role="button">Cancelar</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')" aria-label="Fechar modal de edi√ß√£o de consulta">&times;</span>
            <h3 id="editTitle">Editar Consulta</h3>
            <label for="editPatientName">Nome do Paciente <span aria-hidden="true" class="required">*</span></label>
            <input type="text" id="editPatientName" aria-required="true" required>
            
            <label for="editPatientCpf">CPF do Paciente <span aria-hidden="true" class="required">*</span></label>
            <input type="text" id="editPatientCpf" aria-required="true" aria-describedby="editCpfError editPatientCpfDesc" required>
            <small id="editCpfError" class="error-message" aria-live="polite">CPF inv√°lido. Verifique os d√≠gitos.</small>
            <small id="editPatientCpfDesc" class="sr-only">Digite o CPF no formato 123.456.789-00.</small>
            
            <label for="editPatientPhone">N√∫mero do Telefone <span aria-hidden="true" class="required">*</span></label>
            <input type="tel" id="editPatientPhone" aria-required="true" aria-describedby="editPhoneError editPatientPhoneDesc" required>
            <small id="editPhoneError" class="error-message" aria-live="polite">Telefone inv√°lido. Use o formato (DD) 9XXXX-XXXX.</small>
            <small id="editPatientPhoneDesc" class="sr-only">Digite o telefone no formato (11) 99999-9999.</small>
            
            <label for="editLocationSelect">Local do Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="editLocationSelect" aria-required="true" required></select>
            
            <label for="editAgendaTypeSelect">Tipo de Agenda <span aria-hidden="true" class="required">*</span></label>
            <select id="editAgendaTypeSelect" onchange="populateEditProfessionals()" aria-required="true" required></select>
            
            <label for="editDentistSelect">Profissional <span aria-hidden="true" class="required">*</span></label>
            <select id="editDentistSelect" onchange="populateEditTimes()" aria-required="true" required></select>
            
            <label for="editDate">Data da Consulta <span aria-hidden="true" class="required">*</span></label>
            <input type="date" id="editDate" required aria-required="true">
            
            <label for="editTime">Hor√°rio da Consulta <span aria-hidden="true" class="required">*</span></label>
            <select id="editTime" required aria-required="true"></select>
            
            <label for="editPrioritySelect">Atendimento Priorit√°rio <span aria-hidden="true" class="required">*</span></label>
            <select id="editPrioritySelect" aria-required="true" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>

            <label for="editFirstAppointmentSelect">Primeiro Atendimento <span aria-hidden="true" class="required">*</span></label>
            <select id="editFirstAppointmentSelect" aria-required="true" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>

            <label for="editObservations">Observa√ß√µes</label>
            <textarea id="editObservations" placeholder="Digite observa√ß√µes adicionais (opcional)"></textarea>
            
            <button class="modal-btn" onclick="saveEdit()" aria-label="Salvar altera√ß√µes na consulta" role="button">Salvar Altera√ß√µes</button>
            <button class="modal-btn cancel-btn" onclick="closeModal('editModal')" aria-label="Cancelar edi√ß√£o da consulta" role="button">Cancelar</button>
        </div>
    </div>

    <script>
        let currentDate = new Date(2025, 9, 2); // October 02, 2025
        let selectedDay = null;
        let selectedHour = null;
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let blockedDates = JSON.parse(localStorage.getItem('blockedDates')) || [];
        let appointmentDatesSet = new Set();
        let editingId = null;
        let deleteId = null;
        let filteredAppointments = []; // Store filtered appointments for export
        let debounceTimer; // Para debounce em filtros
        let reportChart = null; // Reference to the chart instance
        let attendanceChart = null; // Reference to the attendance chart instance

        const holidays = [
            // 2025
            new Date(2025, 0, 1),   // Confraterniza√ß√£o Universal
            new Date(2025, 2, 3),   // Carnaval (Segunda-feira)
            new Date(2025, 2, 4),   // Carnaval (Ter√ßa-feira)
            new Date(2025, 3, 18),  // Paix√£o de Cristo
            new Date(2025, 3, 21),  // Tiradentes
            new Date(2025, 4, 1),   // Dia do Trabalho
            new Date(2025, 5, 19),  // Corpus Christi
            new Date(2025, 8, 7),   // Independ√™ncia do Brasil
            new Date(2025, 9, 12),  // Nossa Sra. a Aparecida - Padroeira do Brasil
            new Date(2025, 10, 2),  // Finados
            new Date(2025, 10, 15), // Proclama√ß√£o da Rep√∫blica
            new Date(2025, 11, 25), // Natal
            // 2026
            new Date(2026, 0, 1),   // Confraterniza√ß√£o Universal
            new Date(2026, 1, 16),  // Carnaval (Segunda-feira)
            new Date(2026, 1, 17),  // Carnaval (Ter√ßa-feira)
            new Date(2026, 3, 3),   // Paix√£o de Cristo
            new Date(2026, 3, 21),  // Tiradentes
            new Date(2026, 4, 1),   // Dia do Trabalho
            new Date(2026, 5, 4),   // Corpus Christi
            new Date(2026, 8, 7),   // Independ√™ncia do Brasil
            new Date(2026, 9, 12),  // Nossa Sra. a Aparecida - Padroeira do Brasil
            new Date(2026, 10, 2),  // Finados
            new Date(2026, 10, 15), // Proclama√ß√£o da Rep√∫blica
            new Date(2026, 11, 25), // Natal
            // 2027
            new Date(2027, 0, 1),   // Confraterniza√ß√£o Universal
            new Date(2027, 1, 8),   // Carnaval (Segunda-feira)
            new Date(2027, 1, 9),   // Carnaval (Ter√ßa-feira)
            new Date(2027, 2, 26),  // Paix√£o de Cristo
            new Date(2027, 3, 21),  // Tiradentes
            new Date(2027, 4, 1),   // Dia do Trabalho
            new Date(2027, 4, 27),  // Corpus Christi
            new Date(2027, 8, 7),   // Independ√™ncia do Brasil
            new Date(2027, 9, 12),  // Nossa Sra. a Aparecida - Padroeira do Brasil
            new Date(2027, 10, 2),  // Finados
            new Date(2027, 10, 15), // Proclama√ß√£o da Rep√∫blica
            new Date(2027, 11, 25)  // Natal
        ];

        const holidayNames = {
            '2025-01-01': 'Confraterniza√ß√£o Universal',
            '2025-03-03': 'Carnaval (Segunda-feira)',
            '2025-03-04': 'Carnaval (Ter√ßa-feira)',
            '2025-04-18': 'Paix√£o de Cristo',
            '2025-04-21': 'Tiradentes',
            '2025-05-01': 'Dia do Trabalho',
            '2025-06-19': 'Corpus Christi',
            '2025-09-07': 'Independ√™ncia do Brasil',
            '2025-10-12': 'Nossa Sra. a Aparecida - Padroeira do Brasil',
            '2025-11-02': 'Finados',
            '2025-11-15': 'Proclama√ß√£o da Rep√∫blica',
            '2025-12-25': 'Natal',
            '2026-01-01': 'Confraterniza√ß√£o Universal',
            '2026-02-16': 'Carnaval (Segunda-feira)',
            '2026-02-17': 'Carnaval (Ter√ßa-feira)',
            '2026-04-03': 'Paix√£o de Cristo',
            '2026-04-21': 'Tiradentes',
            '2026-05-01': 'Dia do Trabalho',
            '2026-06-04': 'Corpus Christi',
            '2026-09-07': 'Independ√™ncia do Brasil',
            '2026-10-12': 'Nossa Sra. a Aparecida - Padroeira do Brasil',
            '2026-11-02': 'Finados',
            '2026-11-15': 'Proclama√ß√£o da Rep√∫blica',
            '2026-12-25': 'Natal',
            '2027-01-01': 'Confraterniza√ß√£o Universal',
            '2027-02-08': 'Carnaval (Segunda-feira)',
            '2027-02-09': 'Carnaval (Ter√ßa-feira)',
            '2027-03-26': 'Paix√£o de Cristo',
            '2027-04-21': 'Tiradentes',
            '2027-05-01': 'Dia do Trabalho',
            '2027-05-27': 'Corpus Christi',
            '2027-09-07': 'Independ√™ncia do Brasil',
            '2027-10-12': 'Nossa Sra. a Aparecida - Padroeira do Brasil',
            '2027-11-02': 'Finados',
            '2027-11-15': 'Proclama√ß√£o da Rep√∫blica',
            '2027-12-25': 'Natal'
        };

        function getHolidayName(date) {
            const key = date.toISOString().split('T')[0];
            return holidayNames[key] || 'Feriado Nacional';
        }

        const agendaTypes = [
            'Agenda Odontol√≥gica',
            'Agenda Especialidades M√©dicas',
            'Agenda de Exames'
        ];

        const dentists = [
            'Ana Paula',
            'Carlson',
            'Cinara',
            'Edson',
            'Jo√£o'
        ];

        const medicalSpecialists = [
            'Cl√≠nica Geral',
            'Cardiologia',
            'Oftalmologia',
            'Otorrinolaringologia',
            'Ginecologia',
            'Dermatologia',
            'Psicologia',
            'Nutri√ß√£o'
        ];

        const examSpecialists = [
            'Exame de Sangue',
            'Raio-X',
            'Ultrassom',
            'Tomografia',
            'Eletrocardiograma'
        ];

        const locations = [
            'SESI Sa√∫de - Santo Amaro',
            'Posto Avan√ßado - SESI Paulista'
        ];

        const standardHours = [
            '07:00', '07:30', '08:00', '08:30', '09:00', '09:30',
            '10:00', '10:30', '11:00', '11:30', '12:00', '12:30',
            '13:00', '13:30', '14:00', '14:30', '15:00', '15:30',
            '16:00', '16:30', '17:00', '17:30', '18:00'
        ];

        function generate20MinHours() {
            const hours = [];
            for (let h = 7; h <= 18; h++) {
                for (let m = 0; m < 60; m += 20) {
                    if (h === 18 && m > 0) break;
                    hours.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                }
            }
            return hours;
        }

        const twentyMinHours = generate20MinHours();

        function generate50MinHours() {
            const hours = [];
            let timeInMinutes = 7 * 60; // 420 minutes
            while (timeInMinutes <= 18 * 60) {
                const h = Math.floor(timeInMinutes / 60);
                const m = timeInMinutes % 60;
                if (h <= 18) {
                    hours.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                }
                timeInMinutes += 50;
            }
            return hours;
        }

        const fiftyMinHours = generate50MinHours();

        function getHoursForAgendaType(agendaType) {
            return agendaType === 'Agenda Odontol√≥gica' ? twentyMinHours : standardHours;
        }

        function getHoursForProfessional(agendaType, professional) {
            if (agendaType !== 'Agenda Odontol√≥gica') {
                return standardHours;
            }
            if (!professional) {
                return twentyMinHours;
            }
            if (['Ana Paula', 'Carlson', 'Jo√£o'].includes(professional)) {
                return twentyMinHours;
            } else if (['Edson', 'Cinara'].includes(professional)) {
                return fiftyMinHours;
            } else {
                return twentyMinHours;
            }
        }

        function updateAppointmentDatesSet() {
            appointmentDatesSet.clear();
            appointments.forEach(apt => {
                const [day, mon, yr] = apt.date.split('/');
                appointmentDatesSet.add(new Date(yr, mon - 1, day).toDateString());
            });
        }

        function isHoliday(date) {
            return holidays.some(holiday => holiday.toDateString() === date.toDateString());
        }

        function isBlocked(dateStr) {
            return blockedDates.some(b => b.date === dateStr);
        }

        // Fun√ß√£o para sanitizar inputs (b√°sica contra XSS)
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function formatCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})/, "$1-$2");
            input.value = value;
        }

        function formatFilterCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})/, "$1-$2");
            input.value = value;
        }

        function validateCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('cpfError');
            const isValid = cpf.length === 11 && isValidCPF(cpf);
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) { // S√≥ mostra erro se n√£o vazio
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
            updateScheduleButton();
        }

        function isValidCPF(cpf) {
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf[i]) * (10 - i);
            }
            let remainder = 11 - (sum % 11);
            let digit1 = remainder >= 10 ? 0 : remainder;
            if (parseInt(cpf[9]) !== digit1) return false;
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf[i]) * (11 - i);
            }
            remainder = 11 - (sum % 11);
            let digit2 = remainder >= 10 ? 0 : remainder;
            return parseInt(cpf[10]) === digit2;
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, "");
            if (value.length >= 11) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
            } else if (value.length >= 7) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            } else if (value.length >= 2) {
                value = value.replace(/^(\d{2})/, "($1) ");
            }
            input.value = value;
        }

        function validatePhone(input) {
            const phone = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('phoneError');
            const isValid = phone.length >= 10 && phone.length <= 11;
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
            updateScheduleButton();
        }

        function validateEditCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('editCpfError');
            const isValid = cpf.length === 11 && isValidCPF(cpf);
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
        }

        function validateEditPhone(input) {
            const phone = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('editPhoneError');
            const isValid = phone.length >= 10 && phone.length <= 11;
            if (isValid) {
                input.classList.remove('error');
                errorEl.style.display = 'none';
                input.removeAttribute('aria-invalid');
            } else if (input.value.trim()) {
                input.classList.add('error');
                errorEl.style.display = 'block';
                input.setAttribute('aria-invalid', 'true');
            }
        }

        function getProfessionals(agendaType) {
            if (agendaType === 'Agenda Odontol√≥gica') {
                return dentists;
            } else if (agendaType === 'Agenda Especialidades M√©dicas') {
                return medicalSpecialists;
            } else if (agendaType === 'Agenda de Exames') {
                return examSpecialists;
            }
            return [];
        }

        function populateProfessionals(agendaType, selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecione um profissional</option>';
            const professionals = getProfessionals(agendaType);
            professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                select.appendChild(option);
            });
        }

        function populateEditProfessionals() {
            const agendaType = document.getElementById('editAgendaTypeSelect').value;
            populateProfessionals(agendaType, 'editDentistSelect');
        }

        function populateEditTimes() {
            const agendaTypeSelect = document.getElementById('editAgendaTypeSelect');
            const dentistSelect = document.getElementById('editDentistSelect');
            const agendaType = agendaTypeSelect.value;
            const professional = dentistSelect.value;
            const timeSelect = document.getElementById('editTime');
            timeSelect.innerHTML = '';
            let hours;
            if (agendaType) {
                if (agendaType === 'Agenda Odontol√≥gica' && professional) {
                    hours = getHoursForProfessional(agendaType, professional);
                } else {
                    hours = getHoursForAgendaType(agendaType);
                }
            } else {
                hours = standardHours;
            }
            hours.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                timeSelect.appendChild(opt);
            });
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            toggleBtn.setAttribute('aria-checked', newTheme === 'dark' ? 'true' : 'false');
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            calendar.innerHTML = `
                <div class="day-header">dom</div>
                <div class="day-header">seg</div>
                <div class="day-header">ter</div>
                <div class="day-header">qua</div>
                <div class="day-header">qui</div>
                <div class="day-header">sex</div>
                <div class="day-header">s√°b</div>
            `;

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = date.getDate();
                dayElement.setAttribute('role', 'gridcell');
                dayElement.setAttribute('tabindex', '0'); // Para navega√ß√£o por teclado
                dayElement.setAttribute('aria-label', `Dia ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else {
                    const dayOfWeek = date.getDay();
                    const dateStr = date.toLocaleDateString('pt-BR');
                    const isHolidayDay = isHoliday(date);
                    const isBlockedDay = isBlocked(dateStr);
                    const blockReason = blockedDates.find(b => b.date === dateStr)?.reason;
                    const isUnavailableBase = dayOfWeek === 0 || dayOfWeek === 6 || isHolidayDay || date < today || isBlockedDay;

                    if (isUnavailableBase) {
                        dayElement.classList.add('unavailable');
                        if (isHolidayDay) {
                            dayElement.classList.add('holiday');
                            dayElement.title = getHolidayName(date);
                            dayElement.setAttribute('aria-label', `Feriado: ${getHolidayName(date)} - ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                        } else if (isBlockedDay) {
                            dayElement.classList.add('blocked');
                            dayElement.title = `Data bloqueada: ${blockReason}`;
                            dayElement.setAttribute('aria-label', `Data bloqueada: ${blockReason} - ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                        }
                        dayElement.setAttribute('aria-disabled', 'true');
                        dayElement.onclick = null;
                        dayElement.onkeydown = null;
                    } else {
                        dayElement.onclick = () => selectDay(date);
                        dayElement.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectDay(date); };
                        if (date.toDateString() === today.toDateString()) {
                            dayElement.style.background = '#ffc107';
                            dayElement.style.color = '#000';
                            dayElement.setAttribute('aria-label', `Hoje: ${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })}`);
                        }
                    }
                    // Check for appointments on this day
                    const hasAppointment = appointmentDatesSet.has(date.toDateString());
                    if (hasAppointment) {
                        dayElement.classList.add('has-appointment');
                        dayElement.setAttribute('aria-label', `${dayElement.getAttribute('aria-label')} - Possui agendamento`);
                    }
                }
                calendar.appendChild(dayElement);
            }

            document.getElementById('monthDisplay').textContent = firstDay.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }

        function selectDay(date) {
            if (isHoliday(date)) {
                showToast(`N√£o √© poss√≠vel selecionar feriados: ${getHolidayName(date)}`, 'error');
                return;
            }
            const dateStr = date.toLocaleDateString('pt-BR');
            if (isBlocked(dateStr)) {
                const reason = blockedDates.find(b => b.date === dateStr)?.reason;
                showToast(`Data bloqueada: ${reason}`, 'error');
                return;
            }
            selectedDay = date;
            document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('selectedDate').style.display = 'block';
            document.getElementById('selectedDateText').textContent = `${date.getDate()} de ${date.toLocaleDateString('pt-BR', { month: 'long' })} de ${date.getFullYear()}`;
            document.getElementById('blockDateBtn').style.display = 'block';
            document.getElementById('blockDateBtn').disabled = false;
            updateScheduleButton();
            populateHours(date);
        }

        function blockSelectedDate() {
            if (!selectedDay) {
                showToast('Selecione uma data primeiro.', 'error');
                return;
            }
            const dateStr = selectedDay.toLocaleDateString('pt-BR');
            if (isBlocked(dateStr)) {
                showToast('Esta data j√° est√° bloqueada.', 'error');
                return;
            }
            document.getElementById('blockDateText').textContent = dateStr;
            document.getElementById('blockReason').value = '';
            document.getElementById('blockModal').style.display = 'block';
        }

        function confirmBlock() {
            const reason = document.getElementById('blockReason').value.trim();
            if (!reason) {
                showToast('Informe o motivo do bloqueio.', 'error');
                return;
            }
            const dateStr = selectedDay.toLocaleDateString('pt-BR');
            blockedDates.push({ date: dateStr, reason: sanitizeInput(reason) });
            localStorage.setItem('blockedDates', JSON.stringify(blockedDates));
            closeModal('blockModal');
            showToast('Data bloqueada com sucesso! üîí');
            generateCalendar();
            clearSelections();
        }

        function removeBlock(index) {
            if (confirm('Tem certeza que deseja remover este bloqueio?')) {
                blockedDates.splice(index, 1);
                localStorage.setItem('blockedDates', JSON.stringify(blockedDates));
                displayBlocked();
                generateCalendar();
                showToast('Bloqueio removido com sucesso! ‚úÖ');
            }
        }

        function toggleBlocked() {
            const grid = document.getElementById('blockedGrid');
            const btn = document.getElementById('toggleBlockedBtn');
            if (grid.style.display === 'none' || grid.style.display === '') {
                grid.style.display = 'grid';
                btn.textContent = 'Ocultar Datas Bloqueadas';
                displayBlocked();
            } else {
                grid.style.display = 'none';
                btn.textContent = 'Mostrar Datas Bloqueadas';
            }
        }

        function displayBlocked() {
            const list = document.getElementById('blockedList');
            list.innerHTML = '';
            if (blockedDates.length === 0) {
                list.innerHTML = '<p class="empty-message">Nenhuma data bloqueada.</p>';
                return;
            }
            blockedDates.forEach((block, index) => {
                const card = document.createElement('div');
                card.className = 'appointment-card';
                card.setAttribute('role', 'listitem');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Bloqueio em ${block.date}: ${block.reason}`);
                card.innerHTML = `
                    <div class="appointment-actions">
                        <button class="btn-delete" onclick="removeBlock(${index})" aria-label="Remover bloqueio desta data" role="button">Remover</button>
                    </div>
                    <h4>${block.date}</h4>
                    <p>Motivo: ${sanitizeInput(block.reason)}</p>
                `;
                list.appendChild(card);
            });
        }

        function populateHours(selectedDate) {
            const hoursGrid = document.getElementById('hoursGrid');
            hoursGrid.innerHTML = '';
            const dateStr = selectedDate.toLocaleDateString('pt-BR');
            const selectedAgendaType = document.getElementById('agendaTypeSelect').value;
            const selectedDentist = document.getElementById('dentistSelect').value;
            let hours;
            if (selectedAgendaType && selectedDentist) {
                hours = getHoursForProfessional(selectedAgendaType, selectedDentist);
            } else if (selectedAgendaType) {
                hours = getHoursForAgendaType(selectedAgendaType);
            } else {
                hours = standardHours;
            }
            let bookedHours = [];
            let isSpecificDentist = false;
            if (selectedAgendaType && selectedDentist) {
                bookedHours = appointments
                    .filter(apt => apt.agendaType === selectedAgendaType && apt.date === dateStr && apt.professional === selectedDentist)
                    .map(apt => apt.time);
                isSpecificDentist = true;
            } else if (selectedAgendaType) {
                bookedHours = appointments
                    .filter(apt => apt.agendaType === selectedAgendaType && apt.date === dateStr)
                    .map(apt => apt.time);
            } else {
                bookedHours = appointments
                    .filter(apt => apt.date === dateStr)
                    .map(apt => apt.time);
            }
            hours.forEach(hour => {
                const slot = document.createElement('div');
                slot.className = 'hour-slot';
                slot.setAttribute('role', 'gridcell');
                slot.setAttribute('tabindex', '0');
                slot.setAttribute('aria-label', `Hor√°rio ${hour}`);
                if (bookedHours.includes(hour)) {
                    slot.classList.add('booked');
                    const titleText = isSpecificDentist ? 'Hor√°rio j√° agendado para este profissional' : 'Hor√°rio ocupado';
                    slot.title = titleText;
                    slot.setAttribute('aria-disabled', 'true');
                    slot.setAttribute('aria-label', `Hor√°rio ${hour} - Ocupado`);
                    slot.onkeydown = null; // Desabilita teclado
                    slot.onclick = (e) => {
                        e.preventDefault();
                        const alertText = isSpecificDentist ? 'Este hor√°rio j√° est√° agendado para este profissional.' : 'Este hor√°rio est√° ocupado.';
                        alert(alertText);
                    };
                } else {
                    slot.onclick = () => selectHour(hour);
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectHour(hour); };
                }
                slot.textContent = hour;
                if (bookedHours.includes(hour)) {
                    const text = isSpecificDentist ? ' (Agendado)' : ' (Ocupado)';
                    slot.innerHTML += `<span style="font-size: 10px;">${text}</span>`;
                }
                hoursGrid.appendChild(slot);
            });
        }

        function selectHour(hour) {
            selectedHour = hour;
            document.querySelectorAll('.hour-slot:not(.booked)').forEach(s => s.classList.remove('selected'));
            event.target.classList.add('selected');
            updateScheduleButton();
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
            document.getElementById('selectedDate').style.display = 'none';
            clearSelections();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
            document.getElementById('selectedDate').style.display = 'none';
            clearSelections();
        }

        function clearSelections() {
            selectedDay = null;
            selectedHour = null;
            editingId = null;
            document.getElementById('scheduleBtn').textContent = 'Agendar Consulta';
            document.getElementById('patientName').value = '';
            document.getElementById('patientCpf').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('observations').value = '';
            document.getElementById('locationSelect').value = '';
            document.getElementById('agendaTypeSelect').value = '';
            document.getElementById('dentistSelect').value = '';
            document.getElementById('prioritySelect').value = '';
            document.getElementById('firstAppointmentSelect').value = '';
            document.querySelectorAll('.hour-slot').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
            document.getElementById('hoursGrid').innerHTML = '';
            document.getElementById('selectedDate').style.display = 'none';
            document.getElementById('blockDateBtn').style.display = 'none';
            updateScheduleButton();
        }

        // Debounce para filtros (evita chamadas excessivas)
        function debouncedFilterAppointments() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filterAppointments, 300);
        }

        function toggleScheduled() {
            const grid = document.getElementById('scheduledGrid');
            const btn = document.getElementById('toggleScheduledBtn');
            if (grid.style.display === 'none' || grid.style.display === '') {
                grid.style.display = 'grid';
                btn.textContent = 'Ocultar Consultas Agendadas';
                displayAppointments();
            } else {
                grid.style.display = 'none';
                btn.textContent = 'Mostrar Consultas Agendadas';
            }
        }

        function toggleReport() {
            const content = document.getElementById('reportContent');
            const btn = document.getElementById('toggleReportBtn');
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = 'Ocultar Relat√≥rios';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Mostrar Relat√≥rios';
            }
        }

        function generateReport() {
            const btn = document.querySelector('.report-btn');
            const spinner = document.getElementById('reportSpinner');
            btn.classList.add('loading');
            spinner.style.display = 'block';

            setTimeout(() => {
                const agendaTypeFilter = document.getElementById('reportAgendaType').value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;

                filteredAppointments = appointments.filter(apt => {
                    if (agendaTypeFilter && apt.agendaType !== agendaTypeFilter) return false;
                    if (startDate) {
                        const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                        const start = new Date(startDate);
                        if (aptDate < start) return false;
                    }
                    if (endDate) {
                        const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                        const end = new Date(endDate);
                        if (aptDate > end) return false;
                    }
                    return true;
                });

                // Ordenar por data e depois por hor√°rio
                filteredAppointments.sort((a, b) => {
                    const dateA = new Date(a.date.split('/').reverse().join('-'));
                    const dateB = new Date(b.date.split('/').reverse().join('-'));
                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;
                    // Mesma data, ordenar por hor√°rio
                    const timeA = a.time.split(':').reduce((acc, val, idx) => acc + parseInt(val) * (idx === 0 ? 60 : 1), 0);
                    const timeB = b.time.split(':').reduce((acc, val, idx) => acc + parseInt(val) * (idx === 0 ? 60 : 1), 0);
                    return timeA - timeB;
                });

                const tableBody = document.getElementById('reportTableBody');
                tableBody.innerHTML = '';
                filteredAppointments.forEach(apt => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = sanitizeInput(apt.patient);
                    row.insertCell(1).textContent = apt.cpf || '';
                    row.insertCell(2).textContent = apt.phone || '';
                    row.insertCell(3).textContent = apt.date;
                    row.insertCell(4).textContent = apt.time;
                    row.insertCell(5).textContent = sanitizeInput(apt.professional);
                    row.insertCell(6).textContent = apt.agendaType;
                    row.insertCell(7).textContent = apt.location;
                    row.insertCell(8).textContent = apt.priority || '';
                    row.insertCell(9).textContent = apt.firstAppointment || '';
                    row.insertCell(10).textContent = sanitizeInput(apt.observations || '');
                });

                // Summary Stats
                const total = filteredAppointments.length;
                const odontologica = filteredAppointments.filter(apt => apt.agendaType === 'Agenda Odontol√≥gica').length;
                const medicas = filteredAppointments.filter(apt => apt.agendaType === 'Agenda Especialidades M√©dicas').length;
                const exames = filteredAppointments.filter(apt => apt.agendaType === 'Agenda de Exames').length;

                const summary = document.getElementById('summaryStats');
                summary.innerHTML = `
                    <div class="summary-item">
                        <h4>Total de Agendamentos</h4>
                        <p>${total}</p>
                    </div>
                    <div class="summary-item">
                        <h4>Odontol√≥gica</h4>
                        <p>${odontologica}</p>
                    </div>
                    <div class="summary-item">
                        <h4>Especialidades M√©dicas</h4>
                        <p>${medicas}</p>
                    </div>
                    <div class="summary-item">
                        <h4>Exames</h4>
                        <p>${exames}</p>
                    </div>
                `;

                // Generate Bar Chart for Type Distribution
                const ctx1 = document.getElementById('reportChart').getContext('2d');
                if (reportChart) {
                    reportChart.destroy();
                }
                const barTotal = odontologica + medicas + exames;
                reportChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Odontol√≥gica', 'Especialidades M√©dicas', 'Exames'],
                        datasets: [{
                            data: [odontologica, medicas, exames],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(0, 123, 255, 0.8)',
                                'rgba(23, 162, 184, 0.8)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(0, 123, 255, 1)',
                                'rgba(23, 162, 184, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Distribui√ß√£o de Agendamentos por Tipo',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = barTotal > 0 ? ((value / barTotal) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeInOutBounce'
                        }
                    }
                });

                // Display percentages below bar chart
                const barPercentages = document.getElementById('barPercentages');
                barPercentages.innerHTML = `
                    <p>Odontol√≥gica: ${barTotal > 0 ? ((odontologica / barTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Especialidades M√©dicas: ${barTotal > 0 ? ((medicas / barTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Exames: ${barTotal > 0 ? ((exames / barTotal) * 100).toFixed(1) : 0}%</p>
                `;

                // Generate Pie Chart for Attendance
                const attended = filteredAppointments.filter(apt => apt.status === 'attended').length;
                const noShow = filteredAppointments.filter(apt => apt.status === 'no-show').length;
                const rescheduled = filteredAppointments.filter(apt => apt.status === 'rescheduled').length;
                const pending = filteredAppointments.length - attended - noShow - rescheduled;

                const ctx2 = document.getElementById('attendanceChart').getContext('2d');
                if (attendanceChart) {
                    attendanceChart.destroy();
                }
                const pieTotal = attended + noShow + pending + rescheduled;
                attendanceChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Compareceu', 'N√£o Compareceu', 'Pendente', 'Reagendado'],
                        datasets: [{
                            data: [attended, noShow, pending, rescheduled],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(255, 193, 7, 0.6)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(220, 53, 69, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(255, 193, 7, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Taxa de Comparecimento',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = pieTotal > 0 ? ((value / pieTotal) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeInOutBounce'
                        }
                    }
                });

                // Display percentages below pie chart
                const piePercentages = document.getElementById('piePercentages');
                piePercentages.innerHTML = `
                    <p>Compareceu: ${pieTotal > 0 ? ((attended / pieTotal) * 100).toFixed(1) : 0}%</p>
                    <p>N√£o Compareceu: ${pieTotal > 0 ? ((noShow / pieTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Pendente: ${pieTotal > 0 ? ((pending / pieTotal) * 100).toFixed(1) : 0}%</p>
                    <p>Reagendado: ${pieTotal > 0 ? ((rescheduled / pieTotal) * 100).toFixed(1) : 0}%</p>
                `;

                document.getElementById('reportTableContainer').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
                document.getElementById('exportPdfBtn').style.display = 'inline-block';

                btn.classList.remove('loading');
                spinner.style.display = 'none';
            }, 500);
        }

        function exportToExcel() {
            if (filteredAppointments.length === 0) {
                showToast('Nenhum relat√≥rio para exportar.', 'error');
                return;
            }

            const headers = ['Paciente', 'CPF', 'Telefone', 'Data', 'Hor√°rio', 'Profissional', 'Tipo', 'Local', 'Priorit√°rio', 'Primeiro Atendimento', 'Observa√ß√µes'];
            const data = [
                headers,
                ...filteredAppointments.map(apt => [
                    apt.patient,
                    apt.cpf || '',
                    apt.phone || '',
                    apt.date,
                    apt.time,
                    apt.professional,
                    apt.agendaType,
                    apt.location,
                    apt.priority || '',
                    apt.firstAppointment || '',
                    apt.observations || ''
                ])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relat√≥rio de Agendamentos');
            XLSX.writeFile(wb, `relatorio_agendamentos_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Relat√≥rio exportado para Excel! ‚úÖ');
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Relat√≥rio de Agendamentos', 10, 10);

            let y = 20;

            // Configura√ß√µes da tabela
            const marginLeft = 10;
            const tableWidth = 190;
            const colWidths = [25, 15, 20, 12, 12, 20, 15, 20, 10, 10, 15];
            const headers = ['Paciente', 'CPF', 'Telefone', 'Data', 'Hor√°rio', 'Profissional', 'Tipo', 'Local', 'Priorit√°rio', '1¬∫ At.', 'Obs.'];

            // Fun√ß√£o para truncar texto
            function truncateText(text, maxLength) {
                if (text.length > maxLength) {
                    return text.substring(0, maxLength) + '...';
                }
                return text;
            }

            // Desenhar linha superior
            doc.line(marginLeft, y, marginLeft + tableWidth, y);
            y += 5;

            // Cabe√ßalhos
            let x = marginLeft;
            headers.forEach((header, i) => {
                doc.text(truncateText(header, colWidths[i] / 3), x, y); // Aproximadamente 3 chars por mm
                x += colWidths[i];
            });
            y += 5;

            // Linha separadora
            doc.line(marginLeft, y, marginLeft + tableWidth, y);
            y += 5;

            filteredAppointments.forEach(apt => {
                x = marginLeft;
                const rowData = [
                    truncateText(apt.patient || '', 22),
                    apt.cpf || '',
                    truncateText(apt.phone || '', 17),
                    apt.date || '',
                    apt.time || '',
                    truncateText(apt.professional || '', 17),
                    truncateText(apt.agendaType || '', 12),
                    truncateText(apt.location || '', 17),
                    apt.priority || '',
                    apt.firstAppointment || '',
                    truncateText(apt.observations || '', 12)
                ];

                rowData.forEach((cell, i) => {
                    doc.text(truncateText(cell, colWidths[i] / 3), x, y);
                    x += colWidths[i];
                });

                y += 5;

                // Verificar se precisa de nova p√°gina
                if (y > 280) {
                    // Desenhar linha inferior antes de nova p√°gina
                    doc.line(marginLeft, y, marginLeft + tableWidth, y);
                    doc.addPage();
                    y = 10;

                    // Repetir cabe√ßalhos na nova p√°gina
                    doc.line(marginLeft, y, marginLeft + tableWidth, y);
                    y += 5;
                    x = marginLeft;
                    headers.forEach((header, i) => {
                        doc.text(truncateText(header, colWidths[i] / 3), x, y);
                        x += colWidths[i];
                    });
                    y += 5;
                    doc.line(marginLeft, y, marginLeft + tableWidth, y);
                    y += 5;
                }
            });

            // Linha final
            doc.line(marginLeft, y, marginLeft + tableWidth, y);

            doc.save(`relatorio_agendamentos_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Relat√≥rio exportado para PDF! ‚úÖ');
        }

        // Toast notification expandido
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            toast.textContent = `${icon} ${message}`;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        // Fun√ß√£o para atualizar status de comparecimento
        function updateAttendanceStatus(id, status) {
            const appointment = appointments.find(apt => apt.id === id);
            if (appointment) {
                appointment.status = status;
                appointment.timestamp = new Date().toISOString();
                localStorage.setItem('appointments', JSON.stringify(appointments));
                const statusText = status === 'attended' ? 'Compareceu' : status === 'no-show' ? 'N√£o Compareceu' : 'Reagendado';
                showToast(`Status atualizado: ${statusText}`, 'success');
                if (document.getElementById('scheduledGrid').style.display !== 'none') {
                    displayAppointments();
                }
            }
        }

        // Populate selects
        window.onload = function() {
            // Aviso sobre localStorage (melhoria de seguran√ßa)
            console.warn('Aviso: Dados salvos em localStorage. Para produ√ß√£o, migre para Firebase ou Supabase para melhor seguran√ßa e persist√™ncia.');

            updateAppointmentDatesSet();

            // Carregar tema salvo
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            toggleBtn.setAttribute('aria-checked', savedTheme === 'dark' ? 'true' : 'false');

            // Agenda Types
            const agendaTypeSelect = document.getElementById('agendaTypeSelect');
            agendaTypeSelect.innerHTML = '<option value="">Selecione</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                agendaTypeSelect.appendChild(option);
            });

            // Edit Agenda Types
            const editAgendaTypeSelect = document.getElementById('editAgendaTypeSelect');
            editAgendaTypeSelect.innerHTML = '<option value="">Selecione</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                editAgendaTypeSelect.appendChild(option);
            });

            // Report Agenda Types
            const reportAgendaTypeSelect = document.getElementById('reportAgendaType');
            reportAgendaTypeSelect.innerHTML = '<option value="">Todos os Tipos</option>';
            agendaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                reportAgendaTypeSelect.appendChild(option);
            });

            // Locations
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Selecione um local</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });

            // Edit Locations
            const editLocationSelect = document.getElementById('editLocationSelect');
            editLocationSelect.innerHTML = '<option value="">Selecione um local</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                editLocationSelect.appendChild(option);
            });

            // Odontologia Professionals
            const odontologiaProfessional = document.getElementById('odontologiaProfessional');
            odontologiaProfessional.innerHTML = '<option value="">Todos</option>';
            dentists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                odontologiaProfessional.appendChild(option);
            });

            // Medicas Professionals
            const medicasProfessional = document.getElementById('medicasProfessional');
            medicasProfessional.innerHTML = '<option value="">Todos</option>';
            medicalSpecialists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                medicasProfessional.appendChild(option);
            });

            // Exames Professionals
            const examesProfessional = document.getElementById('examesProfessional');
            examesProfessional.innerHTML = '<option value="">Todos</option>';
            examSpecialists.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                examesProfessional.appendChild(option);
            });

            document.getElementById('agendaTypeSelect').onchange = function() {
                const agendaType = this.value;
                populateProfessionals(agendaType, 'dentistSelect');
                document.getElementById('dentistSelect').value = '';
                if (selectedDay) {
                    populateHours(selectedDay);
                }
                updateScheduleButton();
            };

            document.getElementById('dentistSelect').onchange = function() {
                if (selectedDay) {
                    populateHours(selectedDay);
                }
                updateScheduleButton();
            };

            document.getElementById('locationSelect').onchange = function() {
                updateScheduleButton();
            };

            document.getElementById('prioritySelect').onchange = function() {
                updateScheduleButton();
            };

            document.getElementById('firstAppointmentSelect').onchange = function() {
                updateScheduleButton();
            };

            document.getElementById('patientName').oninput = updateScheduleButton;
            document.getElementById('patientCpf').oninput = function() { formatCPF(this); validateCPF(this); };
            document.getElementById('patientPhone').oninput = function() { formatPhone(this); validatePhone(this); };

            const editCpfInput = document.getElementById('editPatientCpf');
            editCpfInput.oninput = function() { formatCPF(this); validateEditCPF(this); };

            const editPhoneInput = document.getElementById('editPatientPhone');
            editPhoneInput.oninput = function() { formatPhone(this); validateEditPhone(this); };

            generateCalendar();
        };

        function updateScheduleButton() {
            const patientName = document.getElementById('patientName').value.trim();
            const patientCpf = document.getElementById('patientCpf').value.trim();
            const cpfValid = patientCpf && isValidCPF(patientCpf.replace(/\D/g, ''));
            const patientPhone = document.getElementById('patientPhone').value.trim();
            const phoneValid = patientPhone && (patientPhone.replace(/\D/g, '').length >= 10 && patientPhone.replace(/\D/g, '').length <= 11);
            const agendaType = document.getElementById('agendaTypeSelect').value;
            const professional = document.getElementById('dentistSelect').value;
            const location = document.getElementById('locationSelect').value;
            const priority = document.getElementById('prioritySelect').value;
            const firstAppointment = document.getElementById('firstAppointmentSelect').value;
            const btn = document.getElementById('scheduleBtn');
            const isDisabled = !patientName || !cpfValid || !phoneValid || !selectedDay || !selectedHour || !agendaType || !professional || !location || !priority || !firstAppointment;
            btn.disabled = isDisabled;
            btn.setAttribute('aria-disabled', isDisabled ? 'true' : 'false');
            btn.setAttribute('aria-label', isDisabled ? 'Agendar consulta (desabilitado at√© preencher todos os campos obrigat√≥rios)' : 'Agendar consulta');
        }

        function saveAppointment() {
            const btn = document.getElementById('scheduleBtn');
            const spinner = document.getElementById('scheduleSpinner');
            btn.classList.add('loading');
            spinner.style.display = 'block';

            setTimeout(() => {
                const patientName = sanitizeInput(document.getElementById('patientName').value.trim());
                const patientCpf = document.getElementById('patientCpf').value.trim();
                const cpfClean = patientCpf.replace(/\D/g, '');
                const patientPhone = document.getElementById('patientPhone').value.trim();
                const phoneClean = patientPhone.replace(/\D/g, '');
                const observations = sanitizeInput(document.getElementById('observations').value.trim());
                const agendaType = document.getElementById('agendaTypeSelect').value;
                const professional = sanitizeInput(document.getElementById('dentistSelect').value);
                const location = document.getElementById('locationSelect').value;
                const priority = document.getElementById('prioritySelect').value;
                const firstAppointment = document.getElementById('firstAppointmentSelect').value;
                const dateStr = selectedDay.toLocaleDateString('pt-BR');

                if (isHoliday(selectedDay)) {
                    showToast(`N√£o √© poss√≠vel agendar em feriados: ${getHolidayName(selectedDay)}.`, 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }

                if (isBlocked(dateStr)) {
                    const reason = blockedDates.find(b => b.date === dateStr)?.reason;
                    showToast(`N√£o √© poss√≠vel agendar em data bloqueada: ${reason}.`, 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }

                if (!isValidCPF(cpfClean)) {
                    showToast('CPF inv√°lido.', 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }

                if (phoneClean.length < 10 || phoneClean.length > 11) {
                    showToast('Telefone inv√°lido.', 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }

                // Check for duplicate
                const existing = appointments.find(apt => 
                    apt.agendaType === agendaType &&
                    apt.date === dateStr && 
                    apt.time === selectedHour && 
                    apt.professional === professional
                );
                if (existing) {
                    showToast('J√° existe um agendamento para este profissional nesta data e hor√°rio.', 'error');
                    btn.classList.remove('loading');
                    spinner.style.display = 'none';
                    return;
                }

                // Create new appointment
                const appointment = {
                    id: Date.now(),
                    patient: patientName,
                    cpf: patientCpf,
                    phone: patientPhone,
                    observations,
                    location,
                    agendaType,
                    date: dateStr,
                    time: selectedHour,
                    professional,
                    priority,
                    firstAppointment,
                    status: 'pending', // Status inicial
                    timestamp: new Date().toISOString()
                };
                appointments.unshift(appointment);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                updateAppointmentDatesSet();
                showToast('Consulta agendada com sucesso! ‚úÖ');
                clearSelections();
                generateCalendar();
                if (document.getElementById('scheduledGrid').style.display !== 'none') {
                    displayAppointments();
                }
                btn.classList.remove('loading');
                spinner.style.display = 'none';
            }, 1000);
        }

        function editAppointment(id) {
            const appointment = appointments.find(apt => apt.id === id);
            if (appointment) {
                editingId = id;
                document.getElementById('editPatientName').value = appointment.patient;
                document.getElementById('editPatientCpf').value = appointment.cpf || '';
                document.getElementById('editPatientPhone').value = appointment.phone || '';
                document.getElementById('editObservations').value = appointment.observations || '';
                document.getElementById('editLocationSelect').value = appointment.location || '';
                const agendaType = appointment.agendaType || '';
                document.getElementById('editAgendaTypeSelect').value = agendaType;
                populateEditProfessionals();
                const professional = appointment.professional || '';
                document.getElementById('editDentistSelect').value = professional;
                populateEditTimes();
                document.getElementById('editPrioritySelect').value = appointment.priority || '';
                document.getElementById('editFirstAppointmentSelect').value = appointment.firstAppointment || '';
                // Set date
                const [d, m, y] = appointment.date.split('/');
                document.getElementById('editDate').value = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                // Set time
                document.getElementById('editTime').value = appointment.time;
                document.getElementById('editModal').style.display = 'block';
            }
        }

        function saveEdit() {
            const patientName = sanitizeInput(document.getElementById('editPatientName').value.trim());
            const patientCpf = document.getElementById('editPatientCpf').value.trim();
            const cpfClean = patientCpf.replace(/\D/g, '');
            const patientPhone = document.getElementById('editPatientPhone').value.trim();
            const phoneClean = patientPhone.replace(/\D/g, '');
            const observations = sanitizeInput(document.getElementById('editObservations').value.trim());
            const location = document.getElementById('editLocationSelect').value;
            const agendaType = document.getElementById('editAgendaTypeSelect').value;
            const professional = sanitizeInput(document.getElementById('editDentistSelect').value);
            const priority = document.getElementById('editPrioritySelect').value;
            const firstAppointment = document.getElementById('editFirstAppointmentSelect').value;
            const newDateInput = document.getElementById('editDate').value;
            const newTime = document.getElementById('editTime').value;

            if (!patientName || !isValidCPF(cpfClean) || (phoneClean.length < 10 || phoneClean.length > 11) || !location || !agendaType || !professional || !newDateInput || !newTime || !priority || !firstAppointment) {
                showToast('Preencha todos os campos obrigat√≥rios e verifique o CPF e telefone.', 'error');
                return;
            }

            const [y, m, d] = newDateInput.split('-');
            const newDateStr = `${d}/${m}/${y}`;
            const newDateObj = new Date(y, m - 1, d);

            if (isHoliday(newDateObj)) {
                showToast(`N√£o √© poss√≠vel agendar em feriados: ${getHolidayName(newDateObj)}.`, 'error');
                return;
            }

            if (isBlocked(newDateStr)) {
                const reason = blockedDates.find(b => b.date === newDateStr)?.reason;
                showToast(`N√£o √© poss√≠vel agendar em data bloqueada: ${reason}.`, 'error');
                return;
            }

            // Check for conflict
            const existing = appointments.find(apt => 
                apt.id !== editingId &&
                apt.agendaType === agendaType &&
                apt.date === newDateStr && 
                apt.time === newTime && 
                apt.professional === professional
            );
            if (existing) {
                showToast('Conflito: J√° existe um agendamento neste hor√°rio para este profissional.', 'error');
                return;
            }

            const appointment = appointments.find(apt => apt.id === editingId);
            if (appointment) {
                const oldDateStr = appointment.date;
                appointment.patient = patientName;
                appointment.cpf = patientCpf;
                appointment.phone = patientPhone;
                appointment.observations = observations;
                appointment.location = location;
                appointment.agendaType = agendaType;
                appointment.date = newDateStr;
                appointment.time = newTime;
                appointment.professional = professional;
                appointment.priority = priority;
                appointment.firstAppointment = firstAppointment;
                appointment.timestamp = new Date().toISOString();
                if (oldDateStr !== newDateStr) {
                    updateAppointmentDatesSet();
                }
            }
            localStorage.setItem('appointments', JSON.stringify(appointments));
            closeModal('editModal');
            editingId = null;
            showToast('Consulta atualizada com sucesso! ‚úÖ');
            generateCalendar();
            if (document.getElementById('scheduledGrid').style.display !== 'none') {
                displayAppointments();
            }
        }

        function deleteAppointment(id) {
            deleteId = id;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function confirmDelete() {
            if (deleteId) {
                const appointmentToDelete = appointments.find(apt => apt.id === deleteId);
                appointments = appointments.filter(apt => apt.id !== deleteId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                updateAppointmentDatesSet();
                closeModal('deleteModal');
                deleteId = null;
                showToast('Consulta exclu√≠da com sucesso! ‚úÖ');
                generateCalendar();
                if (document.getElementById('scheduledGrid').style.display !== 'none') {
                    displayAppointments();
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const deleteModal = document.getElementById('deleteModal');
            const editModal = document.getElementById('editModal');
            const blockModal = document.getElementById('blockModal');
            if (event.target === deleteModal) {
                closeModal('deleteModal');
            }
            if (event.target === editModal) {
                closeModal('editModal');
            }
            if (event.target === blockModal) {
                closeModal('blockModal');
            }
        }

        function filterAppointments() {
            displayAppointments();
        }

        function displayAppointments() {
            const odontologiaList = document.getElementById('odontologiaList');
            const medicasList = document.getElementById('medicasList');
            const examesList = document.getElementById('examesList');

            const odontologiaStart = document.getElementById('odontologiaStartDate').value;
            const odontologiaEnd = document.getElementById('odontologiaEndDate').value;
            const odontologiaProf = document.getElementById('odontologiaProfessional').value;
            const odontologiaCpf = document.getElementById('odontologiaCpf').value.replace(/\D/g, '');
            const odontologiaSearch = document.getElementById('odontologiaSearch').value.toLowerCase().trim();
            const medicasStart = document.getElementById('medicasStartDate').value;
            const medicasEnd = document.getElementById('medicasEndDate').value;
            const medicasProf = document.getElementById('medicasProfessional').value;
            const medicasCpf = document.getElementById('medicasCpf').value.replace(/\D/g, '');
            const medicasSearch = document.getElementById('medicasSearch').value.toLowerCase().trim();
            const examesStart = document.getElementById('examesStartDate').value;
            const examesEnd = document.getElementById('examesEndDate').value;
            const examesProf = document.getElementById('examesProfessional').value;
            const examesCpf = document.getElementById('examesCpf').value.replace(/\D/g, '');
            const examesSearch = document.getElementById('examesSearch').value.toLowerCase().trim();

            let odontologiaAppts = appointments.filter(apt => apt.agendaType === 'Agenda Odontol√≥gica');
            odontologiaAppts = odontologiaAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (odontologiaStart) {
                    const start = new Date(odontologiaStart);
                    if (aptDate < start) return false;
                }
                if (odontologiaEnd) {
                    const end = new Date(odontologiaEnd);
                    if (aptDate > end) return false;
                }
                if (odontologiaProf && apt.professional !== odontologiaProf) return false;
                if (odontologiaCpf && apt.cpf.replace(/\D/g, '') !== odontologiaCpf) return false;
                if (odontologiaSearch && !apt.patient.toLowerCase().includes(odontologiaSearch)) return false;
                return true;
            });

            let medicasAppts = appointments.filter(apt => apt.agendaType === 'Agenda Especialidades M√©dicas');
            medicasAppts = medicasAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (medicasStart) {
                    const start = new Date(medicasStart);
                    if (aptDate < start) return false;
                }
                if (medicasEnd) {
                    const end = new Date(medicasEnd);
                    if (aptDate > end) return false;
                }
                if (medicasProf && apt.professional !== medicasProf) return false;
                if (medicasCpf && apt.cpf.replace(/\D/g, '') !== medicasCpf) return false;
                if (medicasSearch && !apt.patient.toLowerCase().includes(medicasSearch)) return false;
                return true;
            });

            let examesAppts = appointments.filter(apt => apt.agendaType === 'Agenda de Exames');
            examesAppts = examesAppts.filter(apt => {
                const aptDate = new Date(apt.date.split('/').reverse().join('-'));
                if (examesStart) {
                    const start = new Date(examesStart);
                    if (aptDate < start) return false;
                }
                if (examesEnd) {
                    const end = new Date(examesEnd);
                    if (aptDate > end) return false;
                }
                if (examesProf && apt.professional !== examesProf) return false;
                if (examesCpf && apt.cpf.replace(/\D/g, '') !== examesCpf) return false;
                if (examesSearch && !apt.patient.toLowerCase().includes(examesSearch)) return false;
                return true;
            });

            if (odontologiaAppts.length === 0) {
                odontologiaList.innerHTML = '<p class="empty-message">Nenhum agendamento odontol√≥gico.</p>';
            } else {
                odontologiaList.innerHTML = '';
                odontologiaAppts.forEach(apt => {
                    const statusClass = apt.status === 'attended' ? 'attended' : apt.status === 'no-show' ? 'no-show' : apt.status === 'rescheduled' ? 'rescheduled' : '';
                    const statusText = apt.status === 'attended' ? 'Compareceu' : apt.status === 'no-show' ? 'N√£o Compareceu' : apt.status === 'rescheduled' ? 'Reagendado' : 'Pendente';
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('aria-label', `Agendamento de ${apt.patient} em ${apt.date} √†s ${apt.time} - Status: ${statusText}`);
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar este agendamento" role="button">Editar</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Excluir este agendamento" role="button">Excluir</button>
                            <button class="btn-attended" onclick="updateAttendanceStatus(${apt.id}, 'attended')" aria-label="Marcar como compareceu" role="button">Compareceu</button>
                            <button class="btn-no-show" onclick="updateAttendanceStatus(${apt.id}, 'no-show')" aria-label="Marcar como n√£o compareceu" role="button">N√£o Compareceu</button>
                            <button class="btn-rescheduled" onclick="updateAttendanceStatus(${apt.id}, 'rescheduled')" aria-label="Marcar como reagendado" role="button">Reagendado</button>
                        </div>
                        <h4>${sanitizeInput(apt.patient)} - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'N√£o informado'} | Telefone: ${apt.phone || 'N√£o informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'N√£o informado'} | Local: ${apt.location || 'N√£o informado'} | Priorit√°rio: ${apt.priority || 'N√£o informado'} | Primeiro Atendimento: ${apt.firstAppointment || 'N√£o informado'}</p>
                        ${apt.observations ? `<p class="observations">Observa√ß√µes: ${sanitizeInput(apt.observations)}</p>` : ''}
                        ${apt.status ? `<p class="status ${statusClass}">Status: ${statusText}</p>` : ''}
                    `;
                    odontologiaList.appendChild(card);
                });
            }

            if (medicasAppts.length === 0) {
                medicasList.innerHTML = '<p class="empty-message">Nenhum agendamento de especialidades m√©dicas.</p>';
            } else {
                medicasList.innerHTML = '';
                medicasAppts.forEach(apt => {
                    const statusClass = apt.status === 'attended' ? 'attended' : apt.status === 'no-show' ? 'no-show' : apt.status === 'rescheduled' ? 'rescheduled' : '';
                    const statusText = apt.status === 'attended' ? 'Compareceu' : apt.status === 'no-show' ? 'N√£o Compareceu' : apt.status === 'rescheduled' ? 'Reagendado' : 'Pendente';
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('aria-label', `Agendamento de ${apt.patient} em ${apt.date} √†s ${apt.time} - Status: ${statusText}`);
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar este agendamento" role="button">Editar</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Excluir este agendamento" role="button">Excluir</button>
                            <button class="btn-attended" onclick="updateAttendanceStatus(${apt.id}, 'attended')" aria-label="Marcar como compareceu" role="button">Compareceu</button>
                            <button class="btn-no-show" onclick="updateAttendanceStatus(${apt.id}, 'no-show')" aria-label="Marcar como n√£o compareceu" role="button">N√£o Compareceu</button>
                            <button class="btn-rescheduled" onclick="updateAttendanceStatus(${apt.id}, 'rescheduled')" aria-label="Marcar como reagendado" role="button">Reagendado</button>
                        </div>
                        <h4>${sanitizeInput(apt.patient)} - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'N√£o informado'} | Telefone: ${apt.phone || 'N√£o informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'N√£o informado'} | Local: ${apt.location || 'N√£o informado'} | Priorit√°rio: ${apt.priority || 'N√£o informado'} | Primeiro Atendimento: ${apt.firstAppointment || 'N√£o informado'}</p>
                        ${apt.observations ? `<p class="observations">Observa√ß√µes: ${sanitizeInput(apt.observations)}</p>` : ''}
                        ${apt.status ? `<p class="status ${statusClass}">Status: ${statusText}</p>` : ''}
                    `;
                    medicasList.appendChild(card);
                });
            }

            if (examesAppts.length === 0) {
                examesList.innerHTML = '<p class="empty-message">Nenhum agendamento de exames.</p>';
            } else {
                examesList.innerHTML = '';
                examesAppts.forEach(apt => {
                    const statusClass = apt.status === 'attended' ? 'attended' : apt.status === 'no-show' ? 'no-show' : apt.status === 'rescheduled' ? 'rescheduled' : '';
                    const statusText = apt.status === 'attended' ? 'Compareceu' : apt.status === 'no-show' ? 'N√£o Compareceu' : apt.status === 'rescheduled' ? 'Reagendado' : 'Pendente';
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('aria-label', `Agendamento de ${apt.patient} em ${apt.date} √†s ${apt.time} - Status: ${statusText}`);
                    card.innerHTML = `
                        <div class="appointment-actions">
                            <button class="btn-edit" onclick="editAppointment(${apt.id})" aria-label="Editar este agendamento" role="button">Editar</button>
                            <button class="btn-delete" onclick="deleteAppointment(${apt.id})" aria-label="Excluir este agendamento" role="button">Excluir</button>
                            <button class="btn-attended" onclick="updateAttendanceStatus(${apt.id}, 'attended')" aria-label="Marcar como compareceu" role="button">Compareceu</button>
                            <button class="btn-no-show" onclick="updateAttendanceStatus(${apt.id}, 'no-show')" aria-label="Marcar como n√£o compareceu" role="button">N√£o Compareceu</button>
                            <button class="btn-rescheduled" onclick="updateAttendanceStatus(${apt.id}, 'rescheduled')" aria-label="Marcar como reagendado" role="button">Reagendado</button>
                        </div>
                        <h4>${sanitizeInput(apt.patient)} - ${apt.time} | ${apt.date}</h4>
                        <p>CPF: ${apt.cpf || 'N√£o informado'} | Telefone: ${apt.phone || 'N√£o informado'} | Profissional: ${sanitizeInput(apt.professional)} | Tipo: ${apt.agendaType || 'N√£o informado'} | Local: ${apt.location || 'N√£o informado'} | Priorit√°rio: ${apt.priority || 'N√£o informado'} | Primeiro Atendimento: ${apt.firstAppointment || 'N√£o informado'}</p>
                        ${apt.observations ? `<p class="observations">Observa√ß√µes: ${sanitizeInput(apt.observations)}</p>` : ''}
                        ${apt.status ? `<p class="status ${statusClass}">Status: ${statusText}</p>` : ''}
                    `;
                    examesList.appendChild(card);
                });
            }
        }
    </script>
</body> 
</html>
